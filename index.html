<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cashflow: Classic Rat Race</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#000000',
                            card: '#1C1C1E',
                            overlay: 'rgba(30, 30, 30, 0.7)'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .hidden { display: none !important; }
        
                /* æ–°å¢ï¼šå¼ºåˆ¶ç¦æ­¢æ‰€æœ‰å…ƒç´ è¢«é€‰ä¸­å’Œé•¿æŒ‰å¼¹å‡ºèœå• */
        * {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }
        /* å…è®¸è¾“å…¥æ¡†æ­£å¸¸è¾“å…¥ */
        input, textarea {
            -webkit-user-select: auto !important;
            user-select: auto !important;
        }

        :root {
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.85);
            --ios-card-dark: rgba(28, 28, 30, 0.85);
            --ios-blur: 12px;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
        }

        /* --- iPhone æ»šåŠ¨é‡æ„æ ¸å¿ƒæ ·å¼ --- */
        .ios-scroll-container {
            transform: translate3d(0,0,0);
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
            pointer-events: auto;
        }
        .ios-scroll-container::-webkit-scrollbar { display: none; }
        
        /* --- iPhone é€‚é…æ ¸å¿ƒä¿®å¤ --- */
        .pt-safe-top {
            padding-top: 20px; 
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }
        .pb-safe-bottom {
            padding-bottom: 20px; 
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg: #000000;
                --ios-card: rgba(28, 28, 30, 0.8); 
                --ios-card-dark: rgba(28, 28, 30, 0.9);
                --shadow-sm: 0 2px 8px rgba(0,0,0,0.5);
                --shadow-lg: 0 12px 32px rgba(0,0,0,0.6);
            }
            .tile { background: #1C1C1E !important; border: 1px solid #2c2c2e; }
            .tile-pay { background: #3f2c00 !important; color: #fbbf24 !important; border-color: #78350f !important; }
            .tile-opp { background: #064e3b !important; color: #4ade80 !important; border-color: #065f46 !important; }
            .tile-market { background: #172554 !important; color: #60a5fa !important; border-color: #1e3a8a !important; }
            .tile-doodad { background: #450a0a !important; color: #f87171 !important; border-color: #7f1d1d !important; }
            .tile-baby { background: #500724 !important; color: #f472b6 !important; border-color: #831843 !important; }
            .tile-charity { background: #431407 !important; color: #fb923c !important; border-color: #7c2d12 !important; }
            .tile-down { background: #3b0764 !important; color: #c084fc !important; border-color: #581c87 !important; }
        }

        body { 
            background-color: var(--ios-bg); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            color: #1c1c1e;
            overflow: hidden; 
        }

        .hardware-accel {
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            perspective: 1000px;
        }

        .glass { 
            background: var(--ios-card); 
            backdrop-filter: blur(var(--ios-blur)); 
            -webkit-backdrop-filter: blur(var(--ios-blur)); 
            border: 1px solid rgba(255, 255, 255, 0.4); 
        }

        @media (prefers-color-scheme: dark) {
            .glass { border: 1px solid rgba(255, 255, 255, 0.1); }
        }
        
        .glass-dark {
            background: var(--ios-card-dark);
            backdrop-filter: blur(var(--ios-blur));
            -webkit-backdrop-filter: blur(var(--ios-blur));
            color: white;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes popUp { 
            0% { transform: scale(0.95) translateY(10px); opacity: 0; } 
            100% { transform: scale(1) translateY(0); opacity: 1; } 
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px); }
            40% { transform: translateX(6px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }
        .modal-enter { 
            animation: popUp 0.3s cubic-bezier(0.19, 1, 0.22, 1) forwards; 
            will-change: transform, opacity; 
        }
        .shake-anim { animation: shake 0.4s ease-in-out; }
        
        .tap-effect { transition: transform 0.1s, opacity 0.1s; cursor: pointer; touch-action: manipulation; }
        .tap-effect:active { transform: scale(0.97); opacity: 0.8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #board-container { -webkit-overflow-scrolling: touch; }

        #game-board { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            padding: 0 12px; max-width: 600px; margin: 0 auto;
        }
        .tile {
            aspect-ratio: 1; border-radius: 14px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 10px; font-weight: 700;
            color: #1c1c1e; background: white; box-shadow: var(--shadow-sm);
            position: relative; text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            will-change: transform; 
        }
        .tile-icon { font-size: 22px; margin-bottom: 2px; }
        .tile.active {
            transform: scale(1.05); box-shadow: 0 0 0 3px var(--ios-blue), var(--shadow-lg); z-index: 10;
        }

        .tile-pay { background: #FFF9C4; color: #F57F17; }
        .tile-opp { background: #DCFCE7; color: #15803d; }
        .tile-market { background: #DBEAFE; color: #1d4ed8; }
        .tile-doodad { background: #FEE2E2; color: #b91c1c; }
        .tile-baby { background: #FCE7F3; color: #be185d; }
        .tile-charity { background: #FFEDD5; color: #c2410c; }
        .tile-down { background: #F3E8FF; color: #7e22ce; }

                .player-token, .ai-token {
            position: absolute; width: 14px; height: 14px;
            border: 2px solid white; border-radius: 50%; top: -4px; right: -4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 20;
            transition: all 0.2s ease;
        }
        .player-token { background: var(--ios-blue); z-index: 30; }
        .ai-token { background: #FF3B30; right: auto; left: -4px; z-index: 20; } /* AIæ˜¯çº¢è‰²çš„ï¼Œä½ç½®ç¨å¾®é”™å¼€ */


        .ios-segment { background: rgba(118, 118, 128, 0.24); border-radius: 9px; padding: 2px; display: flex; }
        .segment-btn {
            flex: 1; text-align: center; font-size: 13px; font-weight: 500;
            padding: 6px 0; border-radius: 7px; color: rgba(255,255,255,0.6); transition: all 0.2s;
        }
        .segment-btn.active { background: #636366; color: white; box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        
        .stepper-btn {
            width: 36px; height: 36px; border-radius: 10px; background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 600; color: var(--ios-blue);
        }
        @media (prefers-color-scheme: dark) {
            .stepper-btn { background: #2c2c2e; color: #60a5fa; box-shadow: none; border: 1px solid #3a3a3c; }
        }

        .loan-panel {
            background: rgba(255,59,48, 0.15); border: 1px solid rgba(255,59,48, 0.2);
            border-radius: 16px; padding: 16px; margin-bottom: 16px;
        }
        .debt-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;
            margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05);
        }

        #input-qty-field {
            background: transparent; font-size: 1.6rem; font-weight: 700; text-align: center;
            width: 100px; color: #1e293b; outline: none; border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }
        @media (prefers-color-scheme: dark) { #input-qty-field { color: white; } }
        #input-qty-field:focus { border-bottom-color: var(--ios-blue); }
        
        #modal-overlay { 
            z-index: 60 !important; 
            background-color: rgba(0, 0, 0, 0.4); 
            backdrop-filter: none !important;
        } 
        @media (prefers-color-scheme: dark) {
            #modal-overlay { background-color: rgba(0, 0, 0, 0.65); }
        }

        /* --- è´¢åŠ¡æŠ¥è¡¨ UI é‡æ„ (Apple Wallet é£æ ¼) --- */
        .sheet-header-card {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: 20px; padding: 20px; color: white;
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
            margin-bottom: 24px; position: relative; overflow: hidden;
        }
        .sheet-header-card::after {
            content: ''; position: absolute; top: -50%; right: -20%;
            width: 200px; height: 200px; background: rgba(255,255,255,0.1);
            border-radius: 50%; blur: 20px; pointer-events: none;
        }

        .sheet-section-title {
            font-size: 17px; font-weight: 700; color: #1c1c1e;
            margin-bottom: 12px; margin-top: 24px; padding-left: 4px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .dark .sheet-section-title { color: white; }

        .sheet-card {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 16px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .dark .sheet-card { 
            background: rgba(44, 44, 46, 0.6); 
            border: 1px solid rgba(255,255,255,0.08); 
        }
        .sheet-card:active { transform: scale(0.98); }

        .asset-icon-box {
            width: 44px; height: 44px; border-radius: 12px;
            background: #F2F2F7; display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 12px;
        }/* --- å…¨æ–° Fintech ä»ªè¡¨ç›˜æ ·å¼ --- */
        .fintech-dashboard {
            display: flex; flex-col; gap: 16px; padding-bottom: 40px;
        }

        /* é¡¶éƒ¨æ€»è§ˆå¡ç‰‡ */
        .fintech-header {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 24px;
            padding: 24px;
            color: white;
            box-shadow: 0 10px 30px -10px rgba(15, 23, 42, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .fintech-header::before {
            content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 200%;
            background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, transparent 70%);
            transform: rotate(30deg); pointer-events: none;
        }

        /* è¿›åº¦æ¡è½¨é“ */
        .freedom-track {
            height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px;
            margin: 20px 0 8px 0; overflow: hidden; position: relative;
        }
        .freedom-bar {
            height: 100%; background: linear-gradient(90deg, #34d399, #10b981);
            border-radius: 10px; transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .freedom-marker {
            position: absolute; top: 0; bottom: 0; width: 2px; background: #ef4444; z-index: 5;
        }

        /* æ•°æ®ç½‘æ ¼ */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;
        }
        .stat-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px; border-radius: 16px;
        }

        /* èµ„äº§åˆ—è¡¨é¡¹æ ·å¼ */
        .asset-row {
            display: flex; align-items: center; justify-content: space-between;
            background: white; 
            padding: 16px; margin-bottom: 12px;
            border-radius: 18px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            border: 1px solid #f1f5f9;
        }
        .dark .asset-row {
            background: #27272a; border-color: #3f3f46;
        }
        
        .asset-icon-circle {
            width: 42px; height: 42px; border-radius: 14px;
            background: #f8fafc; color: #334155;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 14px; flex-shrink: 0;
            border: 1px solid #e2e8f0;
        }
        .dark .asset-icon-circle {
            background: #18181b; color: #e2e8f0; border-color: #3f3f46;
        }

        .section-label {
            font-size: 13px; font-weight: 800; color: #94a3b8; 
            text-transform: uppercase; letter-spacing: 0.05em;
            margin: 24px 0 10px 4px; display: flex; align-items: center; gap: 6px;
        }
        .section-label::after {
            content: ''; flex: 1; height: 1px; background: #e2e8f0; opacity: 0.5;
        }
        .dark .section-label::after { background: #3f3f46; }

        /* æ ‡ç­¾ Badge */
        .badge-tag {
            font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: 700;
            margin-left: 6px; vertical-align: middle;
        }
        .badge-blue { background: #dbeafe; color: #2563eb; }
        .dark .badge-blue { background: rgba(37,99,235,0.2); color: #60a5fa; }
        .dark .asset-icon-box { background: rgba(255,255,255,0.1); }

    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-slate-800 dark:text-slate-200 hardware-accel">

    <div class="z-20 pt-safe-top">
        <div class="px-4 py-2">
            <div id="top-panel" class="glass rounded-[28px] p-5 shadow-sm transition-all duration-300 hardware-accel">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <div id="game-phase-badge" class="w-8 h-8 rounded-full bg-slate-900 dark:bg-white dark:text-black flex items-center justify-center text-white font-bold text-lg shadow-md">ğŸ‘·</div>
                        <span id="game-phase-text" class="font-bold text-lg tracking-tight text-slate-800 dark:text-white">èŒä¸š</span>
                        </div>
                    <button onclick="game.toggleSheet()" class="tap-effect px-3 py-1.5 bg-white/60 dark:bg-white/10 backdrop-blur rounded-full text-xs font-semibold text-slate-600 dark:text-slate-300 flex items-center gap-1 border border-white/40 dark:border-white/10 shadow-sm">
                        ğŸ“Š èµ„äº§ & è´Ÿå€º
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/70 dark:bg-white/10 p-3.5 rounded-2xl border border-white/50 dark:border-white/5 shadow-sm">
                        <div class="text-[10px] text-slate-400 dark:text-slate-400 font-bold uppercase tracking-wide">æ‰‹å¤´ç°é‡‘</div>
                        <div class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight" id="display-cash">$0</div>
                    </div>
                    <div class="bg-blue-50/90 dark:bg-blue-900/20 p-3.5 rounded-2xl border border-blue-100 dark:border-blue-800/50 relative overflow-hidden shadow-sm">
                        <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wide">æœˆç°é‡‘æµ</div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 tracking-tight" id="display-flow">$0</div>
                        <div id="bankrupt-warn" class="absolute inset-0 bg-red-100/95 flex items-center justify-center text-red-600 font-bold text-xs hidden animate-pulse">âš ï¸ èµ¤å­—è­¦æŠ¥</div>
                    </div>
                </div>

                <div class="mt-4 px-1">
                    <div class="flex justify-between text-[11px] text-slate-400 dark:text-slate-500 mb-1.5 font-medium">
                        <span>è¢«åŠ¨æ”¶å…¥: <strong id="display-passive" class="text-slate-600 dark:text-slate-300">$0</strong></span>
                        <span>æ€»æ”¯å‡º: <strong id="display-expense" class="text-slate-600 dark:text-slate-300">$0</strong></span>
                    </div>
                    <div class="h-2.5 w-full bg-slate-200/60 dark:bg-white/10 rounded-full overflow-hidden relative">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-green-400 to-emerald-500 w-0 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(52,199,89,0.3)]"></div>
                    </div>
                    <div class="mt-3 mb-2 flex justify-center"> <div id="log-capsule" class="bg-slate-100/90 dark:bg-[#2c2c2e]/90 backdrop-blur-md px-4 py-1.5 rounded-full text-[11px] font-medium text-slate-500 dark:text-slate-400 max-w-[90%] truncate transition-all border border-white/50 dark:border-white/5 shadow-sm">
                            æ¬¢è¿æ¥åˆ°ç°é‡‘æµæ¸¸æˆ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar py-2" id="board-container">
        <div id="game-board"></div>
        <div class="h-44"></div> 
    </div>

    <div class="fixed bottom-0 w-full glass rounded-t-[36px] shadow-[0_-8px_40px_rgba(0,0,0,0.08)] z-30 pb-safe-bottom hardware-accel">
        <div class="p-5 pb-2"> <div id="dice-controls" class="flex gap-3 h-14">
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 hidden flex items-end sm:items-center justify-center transition-opacity duration-300">
        
        <div id="card-modal" class="glass w-full sm:w-[380px] sm:rounded-[36px] rounded-t-[36px] p-6 shadow-2xl hidden relative pb-safe-bottom hardware-accel">
            
            <div class="absolute top-6 left-6 px-3 py-1.5 bg-green-100 dark:bg-green-900/40 rounded-full text-[11px] font-bold text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800/30 flex items-center gap-1 z-10 shadow-sm">
                ğŸ¦ <span id="modal-cash-display" class="text-red-600 dark:text-red-400">$0</span>
            </div>

            <button onclick="game.quickLoan()" class="absolute top-6 right-6 px-3 py-1.5 bg-slate-100 dark:bg-[#2c2c2e] hover:bg-slate-200 dark:hover:bg-[#3a3a3c] rounded-full text-[11px] font-bold text-slate-500 dark:text-slate-400 tap-effect flex items-center gap-1 z-10 border border-slate-200 dark:border-white/5 shadow-sm">
                ğŸ¦ å€Ÿ/è¿˜
            </button>

            <div class="flex justify-center -mt-16 mb-4">
                <div id="card-icon-bg" class="bg-white dark:bg-[#2c2c2e] p-4 rounded-2xl shadow-[0_8px_24px_rgba(0,0,0,0.08)] text-4xl border border-slate-50 dark:border-white/5">ğŸ </div>
            </div>
            
            <div class="text-center mb-6">
                <div id="card-tag" class="inline-block px-2.5 py-0.5 bg-slate-100 dark:bg-white/10 text-slate-400 dark:text-slate-400 text-[10px] font-bold rounded-md mb-2 uppercase tracking-wider">Type</div>
                <h2 id="card-title" class="text-2xl font-bold text-slate-800 dark:text-white leading-tight">Title</h2>
                <div id="card-desc" class="text-slate-500 dark:text-slate-400 text-sm mt-3 leading-relaxed px-2">Description.</div>
            </div>

            <div id="input-area" class="mb-6 hidden">
                 <div class="flex items-center justify-between bg-slate-50 dark:bg-[#2c2c2e] rounded-2xl p-3 border border-slate-100 dark:border-white/5">
                    <button onclick="game.adjustShares(-100)" class="stepper-btn text-slate-400">-</button>
                    <div class="text-center min-w-[80px]">
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-0.5">æ•°é‡ (æ‰‹/è‚¡)</div>
                        <input type="number" id="input-qty-field" value="100" step="10" oninput="game.manualInputShares(this.value)">
                    </div>
                    <button onclick="game.adjustShares(100)" class="stepper-btn text-blue-600">+</button>
                 </div>
                 <div class="flex justify-between items-center px-4 mt-2">
                     <span class="text-xs text-slate-400 font-medium">å•ä»·: <span id="input-price-per">$0</span></span>
                     <span class="text-xs text-slate-500 dark:text-slate-300 font-bold">æ€»è®¡: <span id="input-total" class="text-slate-800 dark:text-white">$0</span></span>
                 </div>
            </div>

            <div id="card-financials" class="bg-slate-50/80 dark:bg-[#2c2c2e] rounded-2xl p-4 mb-6 space-y-2.5 text-sm hidden border border-slate-100 dark:border-white/5">
                <div class="flex justify-between items-center"><span class="text-slate-400 font-medium" id="lbl-cost">æˆæœ¬</span><span class="font-bold text-slate-700 dark:text-slate-200" id="val-cost">$0</span></div>
                <div class="flex justify-between items-center"><span class="text-slate-400 font-medium" id="lbl-down">é¦–ä»˜</span><span class="font-bold text-blue-600 dark:text-blue-400" id="val-down">$0</span></div>
                <div class="w-full h-px bg-slate-200 dark:bg-white/10 my-1"></div>
                <div class="flex justify-between items-center"><span class="text-slate-400 font-medium">æœˆç°é‡‘æµ</span><span class="font-bold text-green-600 dark:text-green-400" id="val-flow">+$0</span></div>
            </div>

            <div class="flex gap-3 mb-4"> <button id="btn-cancel" onclick="game.closeModal()" class="flex-1 py-3.5 bg-slate-100 dark:bg-[#2c2c2e] hover:bg-slate-200 dark:hover:bg-[#3a3a3c] text-slate-500 dark:text-slate-400 rounded-2xl font-bold tap-effect text-sm transition-colors">æ”¾å¼ƒ</button>
                <button onclick="game.confirmCardAction('SHORT')" id="btn-short-action" class="hidden flex-1 py-3.5 bg-red-50 dark:bg-red-900/20 text-red-500 border border-red-100 dark:border-red-900/30 rounded-2xl font-bold tap-effect text-sm">åšç©º</button>
                <button onclick="game.confirmCardAction('BUY')" id="btn-card-action" class="flex-[1.5] py-3.5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 dark:shadow-none tap-effect text-sm transition-colors">æ‰§è¡Œ</button>
            </div>
        </div>

        <div id="choice-modal" class="glass w-full sm:w-[360px] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl hidden pb-safe-bottom dark:border dark:border-white/10 hardware-accel">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2 text-center">é€‰æ‹©æŠ•èµ„èµ›é“</h3>
            <p class="text-xs text-slate-400 text-center mb-6 px-4">å°ç”Ÿæ„èµ·æ­¥å¿«ä½†é£é™©é«˜ï¼Œå¤§ç”Ÿæ„ç¨³å®šä½†é—¨æ§›é«˜ã€‚</p>
            
            <div class="space-y-3">
                <button onclick="game.chooseDeal('Small')" class="w-full p-4 rounded-2xl border bg-white/50 dark:bg-[#2c2c2e]/50 border-slate-100 dark:border-white/5 hover:border-blue-200 active:bg-blue-50 dark:active:bg-white/5 flex items-center justify-between tap-effect transition-all shadow-sm group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span class="text-2xl group-active:scale-110 transition-transform">ğŸ“‰</span> åˆçº§å¸‚åœº</div>
                        <div class="text-xs text-slate-400 mt-1">è‚¡ç¥¨ Â· åŸºé‡‘ Â· å°æˆ¿äº§ (æˆæœ¬ $5kå†…)</div>
                    </div>
                    <div class="text-blue-500 text-sm font-bold">å…¥é—¨ ></div>
                </button>
                <button onclick="game.chooseDeal('Big')" class="w-full p-4 rounded-2xl border bg-white/50 dark:bg-[#2c2c2e]/50 border-slate-100 dark:border-white/5 hover:border-purple-200 active:bg-purple-50 dark:active:bg-white/5 flex items-center justify-between tap-effect transition-all shadow-sm group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span class="text-2xl group-active:scale-110 transition-transform">ğŸ¢</span> å¤§ç”Ÿæ„</div>
                        <div class="text-xs text-slate-400 mt-1">å…¬å¯“ Â· ä¼ä¸šæ”¶è´­ (æˆæœ¬ $6k+)</div>
                    </div>
                    <div class="text-purple-500 text-sm font-bold">è¿›é˜¶ ></div>
                </button>
            </div>
            <button onclick="game.closeModal()" class="w-full mt-6 py-2 mb-2 text-slate-400 text-xs font-semibold">è·³è¿‡æ­¤å›åˆ</button>
        </div>

        <!-- æ¢¦æƒ³é€‰æ‹©å¼¹çª—ï¼šä¿®å¤åº•éƒ¨å¯¹é½é—®é¢˜ -->
        <div id="dream-modal" class="glass fixed left-0 right-0 bottom-0 mx-auto w-full sm:w-[360px] sm:rounded-[32px] rounded-t-[32px] shadow-2xl hidden flex flex-col z-50 h-[75dvh] transition-transform duration-300">
    
            <div class="flex-shrink-0 px-6 pt-6 pb-2 z-10 bg-inherit rounded-t-[32px] relative border-b border-black/5 dark:border-white/5">
                <div class="w-12 h-1.5 bg-slate-200 dark:bg-white/20 rounded-full mx-auto mb-3"></div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white text-center">é€‰æ‹©ä½ çš„æ¢¦æƒ³</h3>
                <p class="text-xs text-slate-400 text-center mt-1">è¿™æ˜¯ä½ è¿›å…¥å¿«è½¦é“åçš„ç»ˆæç›®æ ‡ã€‚</p>
            </div>

            <div class="relative flex-1 min-h-0 w-full">
                <!-- åˆ—è¡¨å®¹å™¨ï¼špb-safe-bottom åŠ åœ¨è¿™é‡Œ -->
                <div id="dream-list" class="ios-scroll-container absolute inset-0 px-6 py-4 space-y-3 pb-safe-bottom">
                    <!-- JS ç”Ÿæˆå†…å®¹ -->
                    <div class="h-20"></div> <!-- åº•éƒ¨é¢å¤–å«é«˜ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ -->
                </div>
                
                <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-white/90 dark:from-[#1c1c1e] to-transparent pointer-events-none rounded-b-[32px]"></div>
            </div>
        </div>
        
        <div id="game-over-modal" class="glass w-[90%] sm:w-[360px] rounded-[32px] p-8 shadow-2xl hidden flex-col items-center text-center dark:border dark:border-white/10 hardware-accel pb-safe-bottom">
            <div class="text-6xl mb-4" id="end-icon">â˜ ï¸</div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2" id="end-title">æ¸¸æˆç»“æŸ</h2>
            <p class="text-slate-500 text-sm mb-6" id="end-desc">æè¿°</p>
            <button onclick="location.reload()" class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-black rounded-2xl font-bold shadow-lg shadow-slate-300 dark:shadow-none tap-effect mb-4">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <div id="sheet-modal" class="fixed inset-0 z-[70] hidden flex-col justify-end">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-[2px]" onclick="game.toggleSheet()"></div>
        <div class="glass-dark w-full h-[92dvh] rounded-t-[32px] p-6 relative flex flex-col modal-enter shadow-[0_-10px_40px_rgba(0,0,0,0.5)]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white tracking-tight">è´¢åŠ¡æŠ¥è¡¨</h2>
                <button onclick="game.toggleSheet()" class="w-8 h-8 rounded-full bg-white/10 text-white flex items-center justify-center tap-effect hover:bg-white/20">âœ•</button>
            </div>

            <div class="ios-segment mb-6">
                <div class="segment-btn active" onclick="game.switchTab('paper', this)">æŠ•èµ„ç»„åˆ</div>
                <div class="segment-btn" onclick="game.switchTab('debt', this)">è´Ÿå€ºç®¡ç†</div>
            </div>

            <div id="panel-invest" class="flex-1 overflow-y-auto space-y-3 pb-safe-bottom">
                 <div id="sheet-content"></div>
                 <div class="h-10"></div>
            </div>

            <div id="panel-debt" class="flex-1 overflow-y-auto hidden space-y-4 pb-safe-bottom">
                <div class="loan-panel flex justify-between items-center text-white mb-2">
                    <div>
                        <div class="text-[10px] text-red-300 font-bold uppercase">é“¶è¡Œæ€¥ç”¨è´· (10%æœˆæ¯)</div>
                        <div class="text-xl font-bold" id="sheet-loan">$0</div>
                        <div class="text-[10px] opacity-60">æœˆåˆ©æ¯æ”¯å‡º: <span id="sheet-interest">$0</span></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="game.manageLoan(-1000)" class="px-3 py-1.5 bg-white/10 rounded-lg text-xs font-bold active:bg-white/20 border border-white/5">è¿˜æ¬¾</button>
                        <button onclick="game.manageLoan(1000)" class="px-3 py-1.5 bg-red-500 rounded-lg text-xs font-bold active:bg-red600 shadow-md shadow-red-900/30">å€Ÿæ¬¾</button>
                    </div>
                </div>

                <div class="text-[11px] text-white/40 uppercase font-bold px-1">ç”Ÿæ´»è´Ÿå€º (è¿˜æ¸…ä»¥å‡å°‘æ”¯å‡º)</div>
                <div id="liabilities-list" class="space-y-2"></div>
                <div class="h-10"></div>
            </div>
            
            <div class="pt-4 pb-safe-bottom border-t border-white/10 flex justify-between text-xs text-white/40 font-medium">
                <span>å·¥èµ„: $<span id="sheet-salary">0</span></span>
                <span>å­©å­: <span id="sheet-kids" class="text-white">0</span> (æ”¯å‡º $<span id="sheet-kid-cost">0</span>)</span>
            </div>
        </div>
    </div>

    <script>
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const CONFIG = {
        basicLivingExpense: 0,
        dreams: [
            { id: 'island', name: 'ç§äººå²›å±¿', cost: 200000, icon: 'ğŸï¸', desc: 'åœ¨å¤ªå¹³æ´‹æ‹¥æœ‰å±äºè‡ªå·±çš„åº¦å‡å¤©å ‚ã€‚' },
            { id: 'mayor', name: 'ç«é€‰å¸‚é•¿', cost: 150000, icon: 'ğŸ›ï¸', desc: 'æŠ•èº«å…¬å…±æœåŠ¡ï¼Œç®¡ç†æ•´ä¸ªåŸå¸‚ã€‚' },
            { id: 'park', name: 'å† åå…¬å›­', cost: 100000, icon: 'ğŸŒ³', desc: 'ä¸ºç¤¾åŒºæèµ ä¸€åº§ä»¥ä½ åå­—å‘½åçš„å…¬å›­ã€‚' },
            { id: 'library', name: 'æèµ å›¾ä¹¦é¦†', cost: 80000, icon: 'ğŸ“š', desc: 'ä¸ºå­©å­ä»¬å»ºç«‹ä¸€åº§ç°ä»£åŒ–çš„å›¾ä¹¦é¦†ã€‚' },
            { id: 'jet', name: 'ç§äººå–·æ°”æœº', cost: 250000, icon: 'âœˆï¸', desc: 'æ¹¾æµ G650ï¼Œéšæ—¶éšåœ°èµ·é£ã€‚' },
            { id: 'golf', name: 'ä¸–ç•Œé«˜å°”å¤«', cost: 120000, icon: 'â›³', desc: 'æ‰“éä¸–ç•Œä¸Šæœ€é¡¶çº§çš„100ä¸ªçƒåœºã€‚' },
            { id: 'yacht', name: 'è±ªåæ¸¸è‰‡', cost: 300000, icon: 'ğŸ›¥ï¸', desc: 'åœ¨åœ°ä¸­æµ·æ‹¥æœ‰è¿™è‰˜åä¸ºâ€œè‡ªç”±å·â€çš„å·¨è½®ã€‚' },
            { id: 'school', name: 'å¸Œæœ›å°å­¦', cost: 500000, icon: 'ğŸ«', desc: 'å»ºç«‹ä¸€æ‰€å…¨å…è´¹çš„ç²¾è‹±å­¦æ ¡ã€‚' }
        ],
        professions: [
            {
                name: 'ä¿å®‰', icon: 'ğŸ§¹', salary: 1600, savings: 1210, perChild: 70,
                debts: { mortgage: 20000, car: 4000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 280, mortgage: 200, car: 60, credit: 60, retail: 50, loan: 0, other: 300 }
            },
            {
                name: 'å¡è½¦å¸æœº', icon: 'ğŸš›', salary: 2500, savings: 2500, perChild: 140,
                debts: { mortgage: 31000, car: 4000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 460, mortgage: 400, car: 80, credit: 60, retail: 50, loan: 0, other: 570 }
            },
            {
                name: 'æœºæ¢°å¸ˆ', icon: 'ğŸ”§', salary: 2000, savings: 1390, perChild: 110,
                debts: { mortgage: 31000, car: 3000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 360, mortgage: 300, car: 60, credit: 60, retail: 50, loan: 0, other: 450 }
            },
            {
                name: 'æ•™å¸ˆ', icon: 'ğŸ‘¨â€ğŸ«', salary: 3300, savings: 3300, perChild: 180,
                debts: { mortgage: 50000, car: 5000, credit: 3000, retail: 1000, loan: 12000 },
                expenses: { tax: 630, mortgage: 500, car: 100, credit: 90, retail: 50, loan: 60, other: 760 }
            },
            {
                name: 'æŠ¤å£«', icon: 'ğŸ’‰', salary: 3100, savings: 3100, perChild: 170,
                debts: { mortgage: 47000, car: 5000, credit: 3000, retail: 1000, loan: 6000 },
                expenses: { tax: 600, mortgage: 400, car: 100, credit: 90, retail: 50, loan: 30, other: 710 }
            },
            {
                name: 'ç§˜ä¹¦', icon: 'ğŸ“', salary: 2500, savings: 2500, perChild: 140,
                debts: { mortgage: 38000, car: 4000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 460, mortgage: 400, car: 80, credit: 60, retail: 50, loan: 0, other: 570 }
            },
            {
                name: 'è­¦å®˜', icon: 'ğŸ‘®', salary: 3000, savings: 3000, perChild: 160,
                debts: { mortgage: 46000, car: 5000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 580, mortgage: 400, car: 100, credit: 60, retail: 50, loan: 0, other: 690 }
            },
            {
                name: 'ç»ç†', icon: 'ğŸ‘”', salary: 4600, savings: 4600, perChild: 240,
                debts: { mortgage: 75000, car: 6000, credit: 4000, retail: 1000, loan: 12000 },
                expenses: { tax: 910, mortgage: 700, car: 120, credit: 120, retail: 50, loan: 60, other: 1000 }
            },
            {
                name: 'å·¥ç¨‹å¸ˆ', icon: 'ğŸ“', salary: 4900, savings: 4900, perChild: 250,
                debts: { mortgage: 75000, car: 7000, credit: 5000, retail: 1000, loan: 12000 },
                expenses: { tax: 1050, mortgage: 700, car: 140, credit: 150, retail: 50, loan: 60, other: 1090 }
            },
            {
                name: 'åŒ»ç”Ÿ', icon: 'ğŸ‘¨â€âš•ï¸', salary: 13200, savings: 13200, perChild: 640,
                debts: { mortgage: 202000, car: 19000, credit: 9000, retail: 1000, loan: 150000 },
                expenses: { tax: 3420, mortgage: 1900, car: 380, credit: 270, retail: 50, loan: 750, other: 2880 }
            },
            {
                name: 'å¾‹å¸ˆ', icon: 'âš–ï¸', salary: 7500, savings: 7500, perChild: 380,
                debts: { mortgage: 115000, car: 11000, credit: 6000, retail: 1000, loan: 78000 },
                expenses: { tax: 1830, mortgage: 1100, car: 220, credit: 180, retail: 50, loan: 390, other: 1650 }
            },
            {
                name: 'é£è¡Œå‘˜', icon: 'ğŸ§‘â€âœˆï¸', salary: 9500, savings: 9500, perChild: 480,
                debts: { mortgage: 143000, car: 15000, credit: 22000, retail: 1000, loan: 0 },
                expenses: { tax: 2350, mortgage: 1330, car: 300, credit: 660, retail: 50, loan: 0, other: 2210 }
            }
        ],
        tiles: [
            { type: 'Pay', label: 'ç»“ç®—æ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Market', label: 'å¸‚åœº', color: 'tile-market', icon: 'ğŸ“ˆ' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Doodad', label: 'é¢å¤–æ”¯å‡º', color: 'tile-doodad', icon: 'ğŸ’¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' }, 
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Pay', label: 'ç»“ç®—æ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Market', label: 'å¸‚åœº', color: 'tile-market', icon: 'ğŸ“‰' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Doodad', label: 'é¢å¤–æ”¯å‡º', color: 'tile-doodad', icon: 'ğŸ’¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Downsized', label: 'å¤±ä¸š', color: 'tile-down', icon: 'ğŸ›‹ï¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Pay', label: 'ç»“ç®—æ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Market', label: 'å¸‚åœº', color: 'tile-market', icon: 'ğŸ“ˆ' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Doodad', label: 'é¢å¤–æ”¯å‡º', color: 'tile-doodad', icon: 'ğŸ’¸' },
            { type: 'Baby', label: 'ç”Ÿå­©å­', color: 'tile-baby', icon: 'ğŸ‘¶' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
        ],
        fastTrackTiles: [
            // ç¬¬ä¸€ç»„ 12
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¢' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ’–' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ­' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¥' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸï¸' },
            { type: 'FT_Hazard', label: 'ç¨åŠ¡å®¡è®¡', color: 'tile-doodad', icon: 'ğŸ‘®', effect: 'audit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¬' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸš¤' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¬' },
            // ç¬¬äºŒç»„ 12
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ°' },
            { type: 'FT_Hazard', label: 'ç¦»å©š', color: 'tile-down', icon: 'ğŸ’”', effect: 'divorce' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ•' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ—¿' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'â›ï¸' },
            { type: 'FT_Hazard', label: 'å®˜å¸', color: 'tile-doodad', icon: 'âš–ï¸', effect: 'lawsuit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ§ª' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ¢' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¦' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸŸï¸' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ“¡' },
            // ç¬¬ä¸‰ç»„ 12
            { type: 'FT_Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸš›' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ¦' },
            { type: 'FT_Hazard', label: 'ç¨åŠ¡å®¡è®¡', color: 'tile-doodad', icon: 'ğŸ‘®', effect: 'audit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ«' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸš' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ§¬' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸª' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Hazard', label: 'ç¦»å©š', color: 'tile-down', icon: 'ğŸ’”', effect: 'divorce' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ”Œ' },
            // ç¬¬å››ç»„ 12
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ°' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¯' },
            { type: 'FT_Hazard', label: 'å®˜å¸', color: 'tile-doodad', icon: 'âš–ï¸', effect: 'lawsuit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸš„' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'â›²' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ›ï¸' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸï¸' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¥¦' },
            { type: 'FT_Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¤–' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'â›·ï¸' },
        ],

        smallDeals: [
            { name: 'MYT4U ç”µå­', symbol:'MYT4U', type: 'Stock', cost: 10, range: '$5-$30', desc: 'è‚¡ä»· $10ã€‚é•¿æœŸåœ¨$5åˆ°$30ä¹‹é—´æ³¢åŠ¨ã€‚', icon: 'ğŸ“‰', allowShort: false },
            { name: 'OK4U åŒ»è¯', symbol:'OK4U', type: 'Stock', cost: 40, range: '$5-$40', desc: 'è‚¡ä»· $40ï¼Œå¤„äºå†å²é«˜ä½ã€‚', icon: 'â›°ï¸', allowShort: false },
            { name: 'å…±åŒåŸºé‡‘', symbol:'GRO4US', type: 'Stock', cost: 40, range: '$10-$30', desc: 'å¸‚åœºçš„åŠ›é‡æŠŠåŸºé‡‘çš„ä»·æ ¼æ¨åˆ°äº†å¾ˆé«˜çš„æ°´å¹³', icon: 'ğŸª½', allowShort: false },
            { name: 'ON2U å¨±ä¹', symbol:'ON2U', type: 'Stock', cost: 5, range: '$10-$30', desc: 'å…¬å¸å¯¹è€ç”µå½±çš„è¦æ±‚å¾ˆé«˜ï¼Œè‚¡ä»·ä¸é”™ã€‚', icon: 'ğŸš€', allowShort: false },
            { name: 'ä¼˜å…ˆè‚¡åˆ†çº¢', type: 'Asset', cost: 1200, down: 1200, flow: 10, desc: 'ç”µåŠ›å…¬å¸ä¼˜å…ˆè‚¡ï¼Œæä¾›ç¨³å®šçš„10%å¹´åŒ–å›æŠ¥ã€‚', icon: 'ğŸ“œ' },
            { name: 'é“¶è¡Œå®šæœŸå­˜å•', type: 'Asset', cost: 3000, down: 3000, flow: 15, desc: 'ä½é£é™©CDå­˜å•ã€‚', icon: 'ğŸ¦' },
            { name: '2å®¤1å… å…¬å¯“', type: 'RealEstate', cost: 45000, down: 4000, flow: 180, desc: 'æ³•æ‹å±‹ã€‚é¦–ä»˜ä»…éœ€$4000ï¼ŒROIé«˜è¾¾54%ï¼', icon: 'ğŸ ' },
            { name: '3å®¤2å«', type: 'RealEstate', cost: 50000, down: 0, flow: -100, desc: 'å…¬è·¯å»ºè®¾éƒ¨å‡ºå”®æ—§åŒºçš„æˆ¿å­ï¼Œå¸‚åœºå´©æºƒï¼Œä¸Šå‘¨æ— äººæŠ•æ ‡ã€‚', icon: 'ğŸ ' },
            { name: '3å®¤2å…', type: 'RealEstate', cost: 50000, down: 4000, flow: 200, desc: 'å› å°±ä¸šå¸‚åœºä¸å¥½ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æˆ¿å­å‡ºå”®ã€‚åœ¨æ‡‚è¡Œçš„äººæ‰‹é‡Œï¼Œä¼šæ˜¯å¾ˆå¥½çš„æŠ•èµ„', icon: 'ğŸšï¸' },
            { name: 'ç¨€æœ‰çš„é‡‘å¸', type: 'Asset', cost: 500, down: 500, flow: 0, desc: 'åœ¨æ—§è´§å¸‚åœºä¸Šï¼Œä½ å‘ç°äº†ä¸€æš1500å¹´è¥¿ç­ç‰™çš‡å®¶æ–°ä¸–ç•Œå¸ï¼Œå–å®¶è¦500ã€‚', icon: 'ğŸª™' }
        ],
        bigDeals: [
            { name: '3å®¤2å«', type: 'RealEstate', cost: 65000, down: 7000, flow: 150, desc: 'ç”Ÿæ„äººéœ€è¦æŠŠè¿™å¤„æˆ¿å­å–æ‰ï¼Œä»–éœ€è¦ç°é‡‘æŒ½æ•‘å…¬å¸ã€‚', icon: 'ğŸ¡' },
            { name: '3å®¤2å«', type: 'RealEstate', cost: 70000, down: 9000, flow: 300, desc: 'ç ´äº§ç»ç†å¿…é¡»å–æ‰è¿™å¤„æˆ¿å­ï¼Œæ— æ³•æ”¯ä»˜æ–°çš„è–ªæ°´è¿‡æ¸¡åŒºã€‚', icon: 'ğŸ¡' },
            { name: '4å•å…ƒ å…¬å¯“', type: 'RealEstate', cost: 160000, down: 32000, flow: 800, desc: '4-Plex å°å‹å…¬å¯“æ¥¼ã€‚ç°é‡‘æµéå¸¸å¥åº·ã€‚', icon: 'ğŸ˜ï¸' },
            { name: '8å•å…ƒ å…¬å¯“', type: 'RealEstate', cost: 320000, down: 60000, flow: 2400, desc: '8-Plexã€‚ç®¡ç†æˆæœ¬ä½ï¼Œæ”¶ç›Šé«˜ã€‚', icon: 'ğŸ¢' },
            { name: 'æ´—è½¦æˆ¿', type: 'Business', cost: 150000, down: 30000, flow: 1000, desc: 'å…¨è‡ªåŠ¨æ´—è½¦ç”Ÿæ„ã€‚éœ€è¦è¾ƒå¤šé¦–ä»˜ã€‚', icon: 'ğŸš—' },
            { name: 'è‡ªåŠ¨æ´—è¡£åº—', type: 'Business', cost: 150000, down: 30000, flow: 2500, desc: 'ä¸ªäººç ´äº§ï¼Œå‡ºå”®ç¹åè·¯æ®µæ—çš„è‡ªåŠ¨æ´—è¡£åº—ï¼Œæ— éœ€ä¸šä¸»çœ‹æŠ¤ã€‚', icon: 'ğŸ§º' },
            { name: 'æ‹›åˆä¼™äºº', type: 'Business', cost: 20000, down: 20000, flow: 800, desc: 'æˆåŠŸçš„æŠ«è¨è¿é”ä¼ä¸šæƒ³ä¸ºé£Ÿå“åº—æä¾›å†°å†»æŠ«è¨ã€‚æ‰€æœ‰è€…éœ€è¦æœ‰äººå…¥è‚¡ã€‚', icon: 'ğŸ•' },
            { name: 'æ‹›åˆä¼™äºº', type: 'Business', cost: 30000, down: 30000, flow: 1000, desc: 'æ±½è½¦é›¶å”®å•†æƒ³æ‰©å¼ ç”Ÿæ„ï¼Œæ”¶è´­2-3å¹´çš„æ—§è½¦ï¼Œéœ€è¦èµ„é‡‘ï¼Œè€Œæ±½è½¦å‚å•†ä¸æ„Ÿå…´è¶£ã€‚', icon: 'ğŸš—' },
            { name: 'å®¶åº­æ—…é¦†å‡ºå”®', type: 'RealEstate', cost: 150000, down: 30000, flow: 1000, desc: 'ä¸šä¸»é€€ä¼‘ï¼Œæƒ³ç«‹å³è½¬è®©ã€‚5å®¤3å«', icon: 'ğŸ ' },
            { name: '3å®¤2å«', type: 'RealEstate', cost: 115000, down: 10000, flow: -100, desc: 'è¿œç¦»å…¬è·¯çš„é«˜å°”å¤«çƒåœºæœ‰3å®¤2å«å‡ºå”®ï¼Œé™„é€é«˜å°”å¤«ä¼šå‘˜ã€‚', icon: 'ğŸ¡' },
            { name: '12å•å…ƒ å…¬å¯“', type: 'RealEstate', cost: 350000, down: 50000, flow: 2400, desc: 'ä¸šä¸»ç»§æ‰¿äººç”Ÿæ´»ä¸å¥½ï¼Œæƒ³å–æ‰ï¼Œå¾ˆå¤šäººæƒ³ç§Ÿ', icon: 'ğŸ¨' },
            { name: 'è½¯ä»¶å…¬å¸ IPO', type: 'Business', cost: 50000, down: 50000, flow: 0, desc: 'ç§å‹Ÿè‚¡æƒã€‚é«˜é£é™©é«˜å›æŠ¥ï¼Œä¸Šå¸‚åå¯èƒ½ç¿»10å€ã€‚', icon: 'ğŸ’»' }
        ],
        fastTrackDeals: [
            { name: 'ç”Ÿç‰©ç§‘æŠ€å…¬å¸', cost: 200000, flow: 10000, icon: 'ğŸ§¬', desc: 'æ²»æ„ˆç½•è§ç—…ï¼Œå¸‚åœºæ½œåŠ›å·¨å¤§ã€‚' },
            { name: 'ç‚¸é¸¡è¿é”åº—', cost: 150000, flow: 9000, icon: 'ğŸ—', desc: 'å…¨çƒç‰¹è®¸ç»è¥æ‰©å¼ è®¡åˆ’ã€‚' },
            { name: 'AI ç ”å‘ä¸­å¿ƒ', cost: 250000, flow: 12000, icon: 'ğŸ’»', desc: 'å¼€å‘ä¸‹ä¸€ä»£äººå·¥æ™ºèƒ½é€šç”¨æ¨¡å‹ã€‚' },
            { name: 'å¸‚ä¸­å¿ƒè´­ç‰©å¹¿åœº', cost: 300000, flow: 15000, icon: 'ğŸ¬', desc: 'ä½äºCBDçš„é»„é‡‘åœ°æ®µã€‚' },
            { name: 'éæ´²é‡‘çŸ¿', cost: 500000, flow: 25000, icon: 'â›ï¸', desc: 'å‹˜æ¢é˜Ÿå‘ç°äº†å·¨å¤§çš„çŸ¿è„‰ã€‚' },
            { name: 'å¥½è±ååˆ¶ç‰‡å‚', cost: 600000, flow: 30000, icon: 'ğŸ¬', desc: 'ç”Ÿäº§å…¨çƒå‘è¡Œçš„è¶…çº§å¤§ç‰‡ã€‚' },
            { name: 'ç§äººå¤ªç©ºæ¢ç´¢', cost: 1000000, flow: 50000, icon: 'ğŸš€', desc: 'ç«æ˜Ÿæ®–æ°‘è®¡åˆ’å‰å“¨ç«™ã€‚' }
        ],
        marketCards: [
            { type: 'PriceChange', symbol: 'MYT4U', price: 30, desc: 'MYT4U å¸‚åœºç«çƒ­ï¼è‚¡ä»·æ¶¨è‡³ $30ã€‚' },
            { type: 'PriceChange', symbol: 'MYT4U', price: 5, desc: 'MYT4U å¸‚åœºå´©ç›˜ï¼è‚¡ä»·è·Œè‡³ $5ã€‚' }, 
            { type: 'PriceChange', symbol: 'ON2U', price: 40, desc: 'ON2U ç”µå½±ç¥¨æˆ¿å¤§å–ï¼è‚¡ä»·é£™å‡è‡³ $40ã€‚' },
            { type: 'PriceChange', symbol: 'OK4U', price: 50, desc: 'OK4U æ–°è¯ç ”å‘æˆåŠŸï¼è‚¡ä»·æ¶¨è‡³ $50ã€‚' },
            { type: 'Buyer', target: '3å®¤2å… æ¡æ¼', price: 135000, desc: 'åˆšéœ€ä¹°å®¶å‡ºç°ï¼å‡ºä»· $135k è´­ä¹°3å®¤2å…çš„æˆ¿å­ã€‚' },
            { type: 'Buyer', target: '3å®¤2å«', price: 135000, desc: 'åˆšéœ€ä¹°å®¶å‡ºç°ï¼å‡ºä»· $135k è´­ä¹°3å®¤2å«çš„æˆ¿å­ã€‚' },
            { type: 'Buyer', target: '2å®¤1å… å…¬å¯“', price: 65000, desc: 'æŠ•èµ„å®¢å‡ºä»· $65k æ”¶è´­æ‰€æœ‰2å®¤1å…å…¬å¯“ã€‚' },
            { type: 'Buyer', target: '4å•å…ƒ å…¬å¯“', price: 220000, desc: 'å…¬å¯“å¸‚åœºå›æš–ã€‚ä¹°å®¶å‡ºä»· $220kã€‚' },
            { type: 'Inflation', desc: 'é€šè´§è†¨èƒ€ï¼æ‰€æœ‰æ¶ˆè´¹å“ä»·æ ¼ä¸Šæ¶¨ã€‚' },
            { type: 'Buyer', target: 'é‡‘å¸æ”¶è—', price: 1000, desc: 'é‡‘ä»·æš´æ¶¨ï¼æ”¶è—å®¶æ€¥å¯»å…‹é²æ ¼é‡‘å¸ï¼Œå‡ºä»· $1,000ã€‚' },
            { type: 'Buyer', target: 'è½¯ä»¶å…¬å¸ IPO', price: 250000, desc: 'ä¸Šå¸‚å¤§è·æˆåŠŸï¼ä½ çš„åŸå§‹è‚¡ä»·å€¼é£™å‡è‡³ $250,000ï¼' }
        ],
        doodads: [
            { name: 'çƒ­æ°´å™¨æ¼æ°´', cost: 450, icon: 'ğŸš¿' },
            { name: 'å­¦ä¹ æ–°æŠ€èƒ½', cost: 220, icon: 'ğŸ“š' },
            { name: 'ä¹°äº†æ–°ä¿é¾„çƒ', cost: 80, icon: 'ğŸ³' },
            { name: 'ç”Ÿæ—¥æ´¾å¯¹', cost: 100, icon: 'ğŸ‚' },
            { name: 'ä¹°ç«‹ä½“å£°è¯ç­’', cost: 100, icon: 'ğŸ¤' },
            { name: 'æ— æ³•æŠ—æ‹’è‰ºæœ¯å®¶çš„æ²¹ç”»', cost: 200, icon: 'ğŸ–¼ï¸' },
            { name: 'åŒå­¦èšä¼š', cost: 250, icon: 'ğŸ¥³' },
            { name: 'å’Œæœ‹å‹åƒé¥­', cost: 40, icon: 'ğŸ½ï¸' },
            { name: 'ä¹°ç¤¼ç‰©ç»™å­©å­', cost: 50, icon: 'ğŸ' },
            { name: 'ä¹°æ–°å¢¨é•œ', cost: 80, icon: 'ğŸ•¶ï¸' },
            { name: 'è½¦åœåœ¨ç¦åœåŒº', cost: 100, icon: 'ğŸš«' },
            { name: 'è´­ä¹°æ–°å®¶å…·', cost: 300, icon: 'ğŸ›‹ï¸' },
            { name: 'ä¹°å½©ç¥¨', cost: 100, icon: 'ğŸ“°' },
            { name: 'çœ‹ç‰™ç§‘', cost: 100, icon: 'ğŸ¦·' },
            { name: 'ä¹°æ–°æ‰‹æœº', cost: 100, icon: 'ğŸ“±' },
            { name: 'ç¨åŠ¡å®¡è®¡--è€å¤©å•Šï¼', cost: 100, icon: 'ğŸ‘®' },
            { name: 'çœ‹å’–å•¡æœº', cost: 150, icon: 'â˜•' },
            { name: 'ä¹°å¨å…·', cost: 150, icon: 'ğŸ§‘â€ğŸ³' },
            { name: 'å»èµŒåœº', cost: 200, icon: 'ğŸ¤‘' },
            { name: 'æ±½è½¦éœ€è¦æ–°è½®èƒ', cost: 300, icon: 'ğŸ›' },
            { name: 'è´­ç‰©', cost: 350, icon: 'ğŸ›ï¸' },
            { name: 'æ±½è½¦ç©ºè°ƒåäº†', cost: 700, icon: 'ğŸš™' },
            { name: 'å„¿å­çš„å¤§å­¦å­¦è´¹', cost: 1500, icon: 'ğŸ“' },
            { name: 'å®¶åº­åº¦å‡', cost: 2000, icon: 'ğŸ–ï¸' },
            { name: 'å­©å­éœ€è¦èƒŒå¸¦', cost: 2000, icon: 'ğŸ‘§' },
            { name: 'å¥³å„¿çš„å©šç¤¼', cost: 2000, icon: 'ğŸ‘°â€â™€ï¸' },
            { name: 'æ–°æ¸¸è‰‡', cost: 17000, icon: 'ğŸ›¥ï¸' }
        ],
    };

    let uiTimer = null; 

        const game = {
        state: {
            isGameOver: false,
            isAiTurn: false, 
            // ç»™ AI å¢åŠ å¤´åƒã€è¢«åŠ¨æ”¶å…¥å’Œæ”¯å‡ºæ•°æ®ï¼Œé˜²æ­¢é¢æ¿æ˜¾ç¤ºå‡ºé”™
            ai: { pos: 0, cash: 2000, flow: 0, passive: 0, expense: 1500, name: 'é˜¿å°”æ³•ç‹—', avatar: 'ğŸ¤–' }, 
            isFastTrack: false, 
 
            userDream: null,    
            ftAddedCashflow: 0,  
            
            cash: 0,
            loan: 0,
            liabilities: [],
            pos: 0,
            assets: [], 
            salary: 0,
            passive: 0,
            childCount: 0,
            currentCard: null,
            inputQty: 100, 
            currentTab: 'paper',
            downsizedTurns: 0, 
            charityTurns: 0, 
            eventQueue: [],
            fastTrackCharityTurns: 0, 
            fastTrackBiz: {}, 
            
            jobTitle: '',
            jobIcon: '',
            perBabyCost: 0,
            basicTax: 0,
            otherExpense: 0
        },

        isMoving: false, 

        init() {
            this.renderDreamSelection();
        },

        renderDreamSelection() {
            this.openOverlay('dream-modal');
            const list = document.getElementById('dream-list');
            // æ¸…ç©ºé™¤ spacer ä»¥å¤–çš„å†…å®¹
            list.innerHTML = ''; 
            
            CONFIG.dreams.forEach(dream => {
                const btn = document.createElement('button');
                btn.className = "block w-full p-4 mb-3 rounded-2xl border bg-white/60 dark:bg-[#2c2c2e]/60 border-slate-100 dark:border-white/5 active:bg-pink-50 dark:active:bg-pink-900/20 active:scale-[0.98] transition-all text-left group shadow-sm relative overflow-hidden";
                btn.onclick = (e) => {
                     e.stopPropagation(); 
                     this.startGame(dream);
                };
                
                btn.innerHTML = `
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="text-3xl bg-white dark:bg-white/10 w-12 h-12 rounded-full flex items-center justify-center shadow-sm text-shadow">${dream.icon}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-slate-800 dark:text-white text-[15px] flex justify-between items-center">
                            <span class="truncate pr-2">${dream.name}</span>
                            <span class="text-pink-600 dark:text-pink-400 font-mono text-sm bg-pink-50 dark:bg-pink-900/30 px-2 py-0.5 rounded-lg">$${dream.cost/1000}k</span>
                        </div>
                        <div class="text-[11px] text-slate-500 dark:text-slate-400 leading-tight mt-1 line-clamp-2">${dream.desc}</div>
                    </div>
                   </div>
               `;
               list.appendChild(btn);
            });
            // åº•éƒ¨å«é«˜
            const spacer = document.createElement('div');
            spacer.className = "h-20";
            list.appendChild(spacer);
        },

        startGame(selectedDream) {
            this.state.userDream = selectedDream;
            this.closeModal(); 
            
            this.state.isGameOver = false;
            this.state.isFastTrack = false;
            this.state.pos = 0;
            this.state.ftAddedCashflow = 0;

            const job = CONFIG.professions[Math.floor(Math.random() * CONFIG.professions.length)];
            
            this.state.jobTitle = job.name;
            this.state.jobIcon = job.icon;
            this.state.salary = job.salary;
            this.state.cash = job.savings;
            this.state.perBabyCost = job.perChild;
            
            this.state.basicTax = job.expenses.tax;
            this.state.otherExpense = job.expenses.other;

            this.state.liabilities = [];
            this.state.assets = [];
            this.state.passive = 0;
            this.state.childCount = 0;
            
            const debtMap = {
                mortgage: { name: 'æˆ¿å±‹æŠµæŠ¼', exp: job.expenses.mortgage },
                car: { name: 'è´­è½¦è´·æ¬¾', exp: job.expenses.car },
                credit: { name: 'ä¿¡ç”¨å¡', exp: job.expenses.credit },
                retail: { name: 'é›¶å”®ä¿¡è´·', exp: job.expenses.retail },
                loan: { name: 'æ•™è‚²è´·æ¬¾', exp: job.expenses.loan }
            };

            for (const [key, amount] of Object.entries(job.debts)) {
                if (amount > 0) {
                    this.state.liabilities.push({
                        id: key,
                        name: debtMap[key].name,
                        balance: amount,
                        expense: debtMap[key].exp
                    });
                }
            }

            // --- æ–°å¢ï¼šç»™ AI åˆ†é…èŒä¸š ---
            // 1. éšæœºé€‰ä¸€ä¸ªèŒä¸šï¼ˆä¸ºäº†æœ‰è¶£ï¼Œå°½é‡å’Œç©å®¶ä¸ä¸€æ ·ï¼‰
            let aiJob = CONFIG.professions[Math.floor(Math.random() * CONFIG.professions.length)];
            while (aiJob.name === job.name && CONFIG.professions.length > 1) {
                aiJob = CONFIG.professions[Math.floor(Math.random() * CONFIG.professions.length)];
            }

            // 2. è®¡ç®— AI çš„åˆå§‹æ€»æ”¯å‡º (æ‰€æœ‰ expenses åŠ èµ·æ¥)
            const aiTotalExpense = Object.values(aiJob.expenses).reduce((a, b) => a + b, 0);

            // 3. å†™å…¥ AI å®Œæ•´æ¡£æ¡ˆ
            this.state.ai = {
                pos: 0,
                name: `AI ${aiJob.name}`, // åå­—å˜æˆ "AI åŒ»ç”Ÿ"ã€"AI å¸æœº" ç­‰
                avatar: 'ğŸ¤–',
                jobTitle: aiJob.name,
                
                cash: aiJob.savings,     // åˆå§‹å‚¨è“„
                salary: aiJob.salary,    // èŒä¸šå·¥èµ„
                passive: 0,              // åˆå§‹è¢«åŠ¨æ”¶å…¥
                expense: aiTotalExpense, // èŒä¸šæ€»æ”¯å‡º
                
                // è®¡ç®—åˆå§‹æœˆç°é‡‘æµ = å·¥èµ„ - æ€»æ”¯å‡º
                flow: aiJob.salary - aiTotalExpense
            };
            
            this.log(`ğŸ¤– AI åŠ å…¥äº†æ¸¸æˆï¼ŒèŒä¸šæ˜¯ï¼š${aiJob.name}`, true);
            // -------------------------

            this.renderBoard(); 
            this.updateUI();
            
            document.getElementById('sheet-salary').innerText = this.state.salary.toLocaleString();
            document.getElementById('game-phase-text').innerText = this.state.jobTitle;
            document.getElementById('game-phase-badge').innerText = this.state.jobIcon;
            
            this.log(`ğŸ¯ ç›®æ ‡: ${selectedDream.name}`, true);
            setTimeout(() => this.log(`ğŸ² èŒä¸š: ${job.name} (é€ƒç¦»è€é¼ èµ›è·‘)`), 1500);
        },

                enterFastTrack() {
            this.state.isFastTrack = true;
            this.state.isGameOver = false;
            
            const oldPassive = this.state.passive;
            this.state.cash += (oldPassive * 100);
            
            this.state.assets = []; 
            this.state.liabilities = []; 
            this.state.childCount = 0;
            this.state.loan = 0;
            this.state.basicTax = 0;
            this.state.otherExpense = 0;
            this.state.pos = 0;
            this.state.ftAddedCashflow = 0;
            
            this.state.salary = oldPassive;
            this.state.passive = 0; 

            // --- æ–°å¢ä»£ç å¼€å§‹ï¼šåˆå§‹åŒ–å¿«è½¦é“å¸ƒå±€ï¼ˆå›ºå®šæ¯ä¸ªæ ¼å­çš„å†…å®¹ï¼‰ ---
            this.state.fastTrackSetup = {}; // ç”¨äºå­˜å‚¨æ¯ä¸ªæ ¼å­çš„å›ºå®šå†…å®¹
            
            // 1. å‡†å¤‡æ‰“ä¹±çš„ç”Ÿæ„åˆ—è¡¨
            let shuffledDeals = [...CONFIG.fastTrackDeals].sort(() => 0.5 - Math.random());
            
            // 2. å‡†å¤‡æ‰“ä¹±çš„æ¢¦æƒ³åˆ—è¡¨ï¼ˆæ’é™¤ç©å®¶è‡ªå·±çš„æ¢¦æƒ³ï¼‰
            let otherDreams = CONFIG.dreams.filter(d => d.id !== this.state.userDream.id).sort(() => 0.5 - Math.random());
            
            // 3. ç¡®å®šå“ªä¸€ä¸ªæ ¼å­æ˜¯ç©å®¶çš„ç»ˆææ¢¦æƒ³ï¼ˆéšæœºé€‰ä¸€ä¸ªFT_Dreamæ ¼å­ï¼‰
            let dreamIndices = [];
            CONFIG.fastTrackTiles.forEach((t, i) => { if(t.type === 'FT_Dream') dreamIndices.push(i); });
            const winningTileIndex = dreamIndices[Math.floor(Math.random() * dreamIndices.length)];

            // 4. éå†åœ°å›¾ï¼Œç»™æ¯ä¸ªæ ¼å­åˆ†é…å›ºå®šçš„å†…å®¹
            CONFIG.fastTrackTiles.forEach((tile, index) => {
                if (tile.type === 'FT_Biz') {
                    // å¦‚æœç”Ÿæ„å‘å®Œäº†ï¼Œé‡æ–°æ´—ç‰Œå†å‘
                    if (shuffledDeals.length === 0) shuffledDeals = [...CONFIG.fastTrackDeals].sort(() => 0.5 - Math.random());
                    this.state.fastTrackSetup[index] = { ...shuffledDeals.pop() }; // ç»‘å®šç”Ÿæ„
                } 
                else if (tile.type === 'FT_Dream') {
                    if (index === winningTileIndex) {
                        // è¿™æ˜¯ç©å®¶çš„æ¢¦æƒ³
                        this.state.fastTrackSetup[index] = { ...this.state.userDream, isWinner: true };
                    } else {
                        // è¿™æ˜¯åˆ«äººçš„æ¢¦æƒ³
                        if (otherDreams.length === 0) otherDreams = CONFIG.dreams.filter(d => d.id !== this.state.userDream.id).sort(() => 0.5 - Math.random());
                        this.state.fastTrackSetup[index] = { ...otherDreams.pop(), isWinner: false };
                    }
                }
            });
            // --- æ–°å¢ä»£ç ç»“æŸ ---

            this.renderBoard();
            this.updateUI();
            
            document.getElementById('game-phase-badge').innerText = 'ğŸï¸';
            document.getElementById('game-phase-text').innerText = 'å¿«è½¦é“';
            
            this.openOverlay('game-over-modal');
            document.getElementById('end-icon').innerText = 'ğŸš€';
            document.getElementById('end-title').innerText = 'æ™‹çº§å¿«è½¦é“ï¼';
            document.getElementById('end-desc').innerHTML = `
                ä½ å·²è´¢åŠ¡è‡ªç”±ï¼è·å¾—å¯åŠ¨èµ„é‡‘ <b class="text-green-500">$${(oldPassive*100).toLocaleString()}</b>ã€‚<br><br>
                <div class="text-left bg-slate-100 dark:bg-white/10 p-3 rounded-xl text-xs space-y-2">
                <div class="font-bold">ğŸ† èƒœåˆ©æ¡ä»¶ (äºŒé€‰ä¸€):</div>
                <div>1. è´­ä¹°ä½ çš„æ¢¦æƒ³: <span class="text-pink-500 font-bold">${this.state.userDream.name}</span></div>
                <div>2. æˆ–å¢åŠ ç°é‡‘æµ: <span class="text-green-500 font-bold">+$50,000/æœˆ</span></div>
                </div>
            `;
            
            const btn = document.querySelector('#game-over-modal button');
            btn.innerText = "å¼€å§‹é£™è½¦";
            btn.onclick = () => this.closeModal();
        },


        get liabilitiesExpense() { return this.state.liabilities.reduce((sum, item) => sum + item.expense, 0); },
        get childExpense() { return this.state.childCount * this.state.perBabyCost; },
        get totalExpense() {
            const loanInterest = this.state.loan * 0.1;
            return this.state.basicTax + this.state.otherExpense + this.liabilitiesExpense + this.childExpense + loanInterest;
        },
        get monthlyFlow() { 
            if (this.state.isFastTrack) return this.state.salary + this.state.passive;
            return (this.state.salary + this.state.passive) - this.totalExpense; 
        },
        get totalIncome() { return this.state.salary + this.state.passive; },

        renderDiceControls() {
            const container = document.getElementById('dice-controls');
            if (this.state.isGameOver && !this.state.isFastTrack) {
                container.innerHTML = ''; return;
            }
            container.innerHTML = '';
            // --- æ–°å¢ï¼šå¦‚æœè½®åˆ° AIï¼Œæ˜¾ç¤ºç¦æ­¢æŒ‰é’® ---
            if (this.state.isAiTurn) {
                container.innerHTML = `
                    <button class="flex-1 bg-slate-200 dark:bg-white/10 text-slate-400 dark:text-white/30 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 cursor-not-allowed shadow-none" disabled>
                        <span class="animate-spin">â³</span> AI æ€è€ƒä¸­...
                    </button>
                `;
                return;
            }
            // ------------------------------------
            const disabledClass = this.isMoving ? "opacity-50 pointer-events-none" : "";
            const commonClass = `tap-effect flex-1 bg-[#1C1C1E] dark:bg-white dark:text-black text-white rounded-2xl font-bold text-lg shadow-xl shadow-slate-300 dark:shadow-none flex items-center justify-center gap-2 active:bg-black transition-all ${disabledClass}`;

            if (this.state.isFastTrack) {
                container.innerHTML = '';
                const btn2 = document.createElement('button');
                btn2.onclick = () => game.rollDice(2);
                btn2.className = `tap-effect flex-1 bg-pink-600 dark:bg-pink-500 dark:text-white text-white rounded-2xl font-bold text-lg shadow-xl flex items-center justify-center gap-2 ${this.isMoving ? 'opacity-50 pointer-events-none' : ''}`;
                btn2.innerHTML = 'ğŸ²ğŸ² åŒéª°';
                container.appendChild(btn2);

                if (this.state.fastTrackCharityTurns > 0) {
                    const btn3 = document.createElement('button');
                    btn3.onclick = () => {
                        game.rollDice(3);
                        game.state.fastTrackCharityTurns--;
                        game.updateUI();
                    };
                    btn3.className = `tap-effect flex-1 bg-orange-600 text-white rounded-2xl font-bold text-lg shadow-xl flex items-center justify-center gap-2 ${this.isMoving ? 'opacity-50 pointer-events-none' : ''}`;
                    btn3.innerHTML = `ğŸ²ğŸ²ğŸ² ä¸‰éª°ï¼ˆå‰©ä½™${this.state.fastTrackCharityTurns}æ¬¡ï¼‰`;
                    container.appendChild(btn3);
                }
                return;
            }

            if (this.state.downsizedTurns > 0) {
                container.innerHTML = `
                    <button onclick="game.rollDice(1)" class="flex-1 bg-white/10 backdrop-blur-md border border-white/10 text-white/50 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 transition-all tap-effect shadow-lg">
                        <span class="text-2xl">ğŸ’¤</span> 
                        <div class="flex flex-col leading-none">
                            <span class="text-sm font-medium">æš‚åœå›åˆ</span>
                            <span class="text-[10px] opacity-60">å‰©ä½™ ${this.state.downsizedTurns} è½®</span>
                        </div>
                    </button>
                `;
                return;
            }

            if (this.state.charityTurns > 0) {
                container.innerHTML = `
                    <button onclick="game.rollDice(1)" class="${commonClass}">ğŸ² 1</button>
                    <button onclick="game.rollDice(2)" class="${commonClass} bg-orange-500 shadow-orange-200">ğŸ² 2</button>
                `;
            } else {
                container.innerHTML = `<button onclick="game.rollDice(1)" class="${commonClass}">ğŸ² æ·éª°å­</button>`;
            }
        },

                rollDice(diceCount) {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            if (this.state.isAiTurn) { this.log("â³ è¯·ç­‰å¾…å¯¹æ‰‹è¡ŒåŠ¨ç»“æŸ"); return; }
            if (this.isMoving) return;

            // --- æ–°å¢ï¼šç«‹å³é”å®šçŠ¶æ€å¹¶æ¸…ç©ºæŒ‰é’®ï¼Œé˜²æ­¢è¿ç‚¹å’Œè§†è§‰å»¶è¿Ÿ ---
            this.isMoving = true;
            document.getElementById('dice-controls').innerHTML = ''; 
            // -----------------------------------------------------
            
            const overlay = document.getElementById('modal-overlay');
            if ((!overlay.classList.contains('hidden')) || overlay.style.display === 'flex') {
                return;
            }

            if (this.state.downsizedTurns > 0) {
                this.state.downsizedTurns--;
                this.log(`ğŸ›‹ï¸ åœèµ›ä¸­... è¿˜å‰© ${this.state.downsizedTurns} è½®`);
                
                // ã€ä¿®å¤ã€‘é‡ç½®ç§»åŠ¨é”ï¼Œå¦åˆ™æŒ‰é’®ä¼šä¸€ç›´ç°æ˜¾æ— æ³•ç‚¹å‡»
                this.isMoving = false; 
                
                this.updateUI();
                setTimeout(() => this.runAiTurn(), 800);
                return;
            }


            // --- è‡ªåŠ¨è´·æ¬¾é€»è¾‘ ---
            if (this.state.cash < 0) {
                const debt = Math.abs(this.state.cash);
                const borrowAmt = Math.ceil(debt / 1000) * 1000;
                this.manageLoan(borrowAmt);
                this.log(`âš ï¸ ç°é‡‘ä¸è¶³ï¼Œè‡ªåŠ¨è´·æ¬¾ $${borrowAmt.toLocaleString()}`);
                this.updateUI();
            }
            // ------------------

            if (this.state.charityTurns > 0) {
                this.state.charityTurns--;
            }

            let dice = 0;
            const d1 = Math.floor(Math.random() * 6) + 1;
            if (diceCount === 2) {
                const d2 = Math.floor(Math.random() * 6) + 1;
                dice = d1 + d2;
                this.log(`ğŸ² æ·å‡ºäº† ${d1} + ${d2} = ${dice} ç‚¹`, true);
            } else {
                dice = d1;
                this.log(`ğŸ² æ·å‡ºäº† ${dice} ç‚¹`, true);
            }
            
            this.isMoving = true;
            this.updateUI(); 
            
            let stepsRemaining = dice;
            const tiles = this.state.isFastTrack ? CONFIG.fastTrackTiles : CONFIG.tiles;
            let lastTime = 0;

            const animateMove = (timestamp) => {
                if (this.state.isGameOver && !this.state.isFastTrack) return;
                if (!lastTime) lastTime = timestamp;
                const elapsed = timestamp - lastTime;

                const speed = this.state.isFastTrack ? 120 : 180;

                if (elapsed > speed) { 
                    if (stepsRemaining <= 0) {
                        this.isMoving = false;
                        this.updateUI();
                        this.triggerTile(tiles[this.state.pos]);
                        return;
                    }

                    this.updatePlayerToken(this.state.pos, (this.state.pos + 1) % tiles.length);
                    this.state.pos = (this.state.pos + 1) % tiles.length;

                    if (stepsRemaining > 1) { 
                        if (tiles[this.state.pos].type === 'Pay' || tiles[this.state.pos].type === 'FT_Pay') {
                            this.payDay();
                        }
                    }

                    stepsRemaining--;
                    lastTime = timestamp;
                }
                
                if (stepsRemaining >= 0) {
                        requestAnimationFrame(animateMove);
                }
            };

            requestAnimationFrame(animateMove);
        },

        updatePlayerToken(oldIndex, newIndex) {
            const tiles = document.getElementById('game-board').children;
            if (tiles[oldIndex]) {
                tiles[oldIndex].classList.remove('active');
                const token = tiles[oldIndex].querySelector('.player-token');
                if (token) token.remove();
            }
            
            if (tiles[newIndex]) {
                tiles[newIndex].classList.add('active');
                if (!tiles[newIndex].querySelector('.player-token')) {
                    tiles[newIndex].innerHTML += `<div class="player-token"></div>`;
                }
                setTimeout(() => tiles[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }), 10);
            }
        },

        payDay() {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            
            const flow = this.monthlyFlow;
            this.state.cash += flow;
            this.log(`ğŸ’° ç»“ç®—æ—¥ï¼šç°é‡‘ +$${flow.toLocaleString()}`);
            this.animChange('display-cash', 'positive');
            
            this.checkWinCondition(); 

            if (!this.state.isFastTrack && this.state.cash < 0) {
                this.checkBankruptcy();
            }
        },

        checkBankruptcy() {
            if (this.state.isGameOver) return;
            
            if (this.state.cash < 0 || this.monthlyFlow < 0) {
                this.log(`âš ï¸ è´¢åŠ¡è­¦æŠ¥ï¼šç°é‡‘æˆ–æœˆç°é‡‘æµä¸ºè´Ÿï¼Œè¯·å€Ÿè´·æˆ–å˜å–èµ„äº§`, true);
                
                if (document.getElementById('sheet-modal').classList.contains('hidden')) {
                    setTimeout(() => this.toggleSheet(), 600);
                }
            }
        },

        triggerTile(tile) {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            
            if (this.state.isFastTrack) {
                this.handleFastTrackTile(tile);
            } else {
                switch(tile.type) {
                    case 'Pay': 
                        this.payDay(); 
                        setTimeout(() => this.runAiTurn(), 1000); // ç»“ç®—å®Œå·¥èµ„ï¼Œ1ç§’å AI è¡ŒåŠ¨
                        break;
                    case 'Opp': this.openOverlay('choice-modal'); break;

                    case 'Doodad': 
                        const doodad = CONFIG.doodads[Math.floor(Math.random() * CONFIG.doodads.length)];
                        this.showCardModal('DOODAD', doodad); 
                        break;
                    case 'Market':
                        const market = CONFIG.marketCards[Math.floor(Math.random() * CONFIG.marketCards.length)];
                        this.handleMarket(market);
                        break;
                    case 'Charity': 
                        this.triggerCharity(); 
                        // æ³¨æ„ï¼šCharity æ˜¯å¼¹çª—ï¼Œé€»è¾‘åœ¨ closeModal å¤„ç†ï¼Œè¿™é‡Œä¸ç”¨åŠ 
                        break; 
                    case 'Baby':
                        if (this.state.childCount >= 3) {
                            this.log(`ğŸ‘¶ å­©å­å·²è¾¾ä¸Šé™`);
                        } else {
                            this.state.childCount++;
                            this.log(`ğŸ‘¶ å–œå¾—è´µå­ (æ”¯å‡º +$${this.state.perBabyCost}/æœˆ)`, true);
                        }
                        this.updateUI();
                        setTimeout(() => this.runAiTurn(), 1000); // ç”Ÿå®Œå­©å­ï¼ŒAI è¡ŒåŠ¨
                        break;
                    case 'Downsized':
                        const expense = this.totalExpense;
                        this.state.cash -= expense; 
                        this.state.downsizedTurns = 2; 
                        this.state.charityTurns = 0; 
                        this.log(`ğŸ›‹ï¸ å¤±ä¸šï¼šæ”¯ä»˜è´¦å•å¹¶åœèµ›2è½®`);
                        this.updateUI();
                        if (this.state.cash < 0) this.checkBankruptcy();
                        break;
                }
            }
        },

                handleFastTrackTile(tile) {
            // è·å–å½“å‰æ ¼å­é¢„å…ˆåˆ†é…å¥½çš„æ•°æ®
            const fixedData = this.state.fastTrackSetup ? this.state.fastTrackSetup[this.state.pos] : null;

            switch(tile.type) {
                case 'FT_Pay':
                    this.payDay();
                    break;

                case 'FT_Biz':
                    // 1. æ£€æŸ¥æ˜¯å¦å·²ç»ä¹°è¿‡è¿™ä¸ªæ ¼å­çš„ç”Ÿæ„
                    if (this.state.fastTrackBiz[this.state.pos]) {
                        const deal = this.state.fastTrackBiz[this.state.pos];
                        this.log(`ğŸ¢ å·²æ‹¥æœ‰ï¼š${deal.name} (+$${deal.flow.toLocaleString()}/æœˆ)`);
                        return; // å¦‚æœå·²ä¹°è¿‡ï¼Œç›´æ¥ç»“æŸï¼Œä¸å¼¹å‡ºçª—å£
                    }
                    
                    // 2. å¦‚æœæ²¡ä¹°è¿‡ï¼Œè¯»å–å›ºå®šçš„ç”Ÿæ„æ•°æ®
                    if (fixedData) {
                        // ç¨å¾®ç»™ç°é‡‘æµå’Œæˆæœ¬åŠ ä¸€ç‚¹éšæœºæµ®åŠ¨ï¼ˆå¯é€‰ï¼Œä¿ç•™åŸæ¸¸æˆè¶£å‘³æ€§ï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ fixedData.flow
                        // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å›ºå®šæ•°æ®ï¼Œç¡®ä¿æ¯æ¬¡è¸©åˆ°ä¸€æ ·
                        const flow = fixedData.flow;
                        const cost = fixedData.cost;
                        
                        this.showCardModal('OPP', {
                            name: fixedData.name,
                            type: 'Business',
                            cost: cost,
                            down: cost, 
                            flow: flow,
                            desc: fixedData.desc,
                            icon: fixedData.icon
                        });
                        // è®°å½•å½“å‰ä½ç½®ï¼Œä»¥ä¾¿è´­ä¹°åæ ‡è®°ä¸ºâ€œå·²æ‹¥æœ‰â€
                        this.state.currentCard.tempPos = this.state.pos;
                    }
                    break;

                case 'FT_Dream':
                    if (!fixedData) return;

                    // åˆ¤æ–­æ˜¯å¦æ˜¯ç©å®¶è‡ªå·±çš„æ¢¦æƒ³
                    if (fixedData.isWinner) {
                        this.queueEvent({
                            type: 'INFO_DECISION',
                            data: {
                                name: `ä½ çš„æ¢¦æƒ³: ${fixedData.name}`,
                                desc: `ğŸ’– <b>è¿™æ˜¯ä½ æ¢¦å¯ä»¥æ±‚çš„ï¼</b><br>æ”¯ä»˜ $${fixedData.cost.toLocaleString()} è´­ä¹°å¹¶<b>èµ¢å¾—æ¸¸æˆ</b>ï¼`,
                                icon: fixedData.icon,
                                cost: fixedData.cost,
                                onConfirm: () => {
                                    if (this.state.cash >= fixedData.cost) {
                                        this.state.cash -= fixedData.cost;
                                        this.winGame('DREAM');
                                    } else {
                                        this.log('ç°é‡‘ä¸è¶³', true);
                                    }
                                }
                            }
                        });
                    } else {
                        // åˆ«äººçš„æ¢¦æƒ³
                        this.queueEvent({
                            type: 'INFO_ONLY',
                            data: {
                                name: `åˆ«äººçš„æ¢¦æƒ³: ${fixedData.name}`,
                                desc: `è¿™æ˜¯åˆ«äººçš„æ¢¦æƒ³ï¼Œä½ åªèƒ½çœ‹çœ‹ã€‚<br>æˆæœ¬: $${fixedData.cost.toLocaleString()}<br><span class="text-xs text-slate-400">(ä½ åªèƒ½è´­ä¹°è‡ªå·±é€‰å®šçš„æ¢¦æƒ³)</span>`,
                                icon: fixedData.icon
                            }
                        });
                    }
                    this.processQueue();
                    break;

                case 'FT_Charity':
                    this.triggerCharity();
                    break;

                case 'FT_Hazard':
                    if (tile.effect === 'audit') {
                        this.log('ğŸ‘® ç¨åŠ¡å®¡è®¡ï¼å¤±å»ä¸€åŠç°é‡‘ã€‚', true);
                        this.state.cash = Math.floor(this.state.cash / 2);
                    } else if (tile.effect === 'divorce') {
                        this.log('ğŸ’” ç¦»å©šï¼å¤±å»æ‰€æœ‰ç°é‡‘ã€‚', true);
                        this.state.cash = 0;
                    } else if (tile.effect === 'lawsuit') {
                        const cost = Math.floor(this.state.cash / 2);
                        this.log(`âš–ï¸ é­é‡å®˜å¸ï¼æ”¯ä»˜ $${cost.toLocaleString()} å¾‹å¸ˆè´¹`, true);
                        this.state.cash -= cost;
                    }
                    this.updateUI();
                    break;
            }
        },


        triggerCharity() {
            const cost = Math.floor(this.totalIncome * 0.1);
            this.queueEvent({
                type: 'INFO_DECISION',
                data: {
                    name: 'æ…ˆå–„æèµ ',
                    desc: `æèµ æ€»æ”¶å…¥çš„ 10% ($${cost.toLocaleString()})ï¼Ÿ<br>å¥½å¤„ï¼šæ¥ä¸‹æ¥3ä¸ªå›åˆå¯ä½¿ç”¨ä¸‰é¢—éª°å­ã€‚`,
                    icon: 'ğŸ’œ',
                    cost: cost,
                    onConfirm: () => {
                        if(this.state.cash >= cost) {
                            this.state.cash -= cost;
                            if (this.state.isFastTrack) {
                                this.state.fastTrackCharityTurns = 3;
                            } else {
                                this.state.charityTurns = 3;
                            }
                            this.log(`ğŸ’œ æèµ æˆåŠŸï¼Œç‰¹æƒç”Ÿæ•ˆï¼`, true);
                            this.updateUI();
                        } else {
                            this.log('ç°é‡‘ä¸è¶³');
                        }
                    }
                }
            });
            this.processQueue();
        },

        manageLoan(amount) {
            if (!amount) return;
            if (this.state.isFastTrack) return; 

            if (amount > 0) {
                this.state.loan += amount;
                this.state.cash += amount;
                this.log(`ğŸ¦ å€Ÿå…¥ $${amount}`);
            } else {
                let repay = Math.abs(amount);
                if (this.state.loan < repay) repay = this.state.loan;
                if (repay <= 0) { this.log("ğŸ¦ æ— è´·æ¬¾éœ€å¿è¿˜"); return; }

                if (this.state.cash >= repay) {
                    this.state.loan -= repay;
                    this.state.cash -= repay;
                    this.log(`ğŸ¦ è¿˜æ¬¾ $${repay}`);
                } else {
                    this.log("âš ï¸ ç°é‡‘ä¸è¶³ä»¥è¿˜æ¬¾", true);
                    const panel = document.querySelector('.loan-panel');
                    if(panel) {
                        panel.classList.add('shake-anim');
                        setTimeout(()=>panel.classList.remove('shake-anim'), 400);
                    }
                }
            }
            this.updateUI();
            this.renderSheet('debt');
        },

        quickLoan() {
            const sheet = document.getElementById('sheet-modal');
            const isHidden = sheet.classList.contains('hidden');
            
            if (isHidden) {
                this.renderSheet('debt');
                sheet.style.display = 'flex'; 
                sheet.classList.remove('hidden');
                
                this.state.currentTab = 'debt';
                document.querySelectorAll('.segment-btn').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.segment-btn')[1].classList.add('active'); 
                document.getElementById('panel-invest').classList.add('hidden');
                document.getElementById('panel-debt').classList.remove('hidden');
            } else {
                this.toggleSheet();
            }
        },
        
        promptPayLiability(id) {
            const item = this.state.liabilities.find(l => String(l.id) === String(id));
            if (!item) return;

            this.toggleSheet();

            this.queueEvent({
                type: 'INFO_DECISION',
                data: {
                    name: `å¿è¿˜: ${item.name}`,
                    desc: `æ”¯ä»˜ $${item.balance.toLocaleString()} ä»¥æ¶ˆé™¤æ¯æœˆ $${item.expense} çš„æ”¯å‡ºã€‚<br>è¿™å°†å¢åŠ ä½ çš„æœˆç°é‡‘æµã€‚`,
                    icon: 'ğŸ’³',
                    cost: item.balance,
                    onConfirm: () => {
                        this.payLiabilityExec(item.id);
                    }
                }
            });
            this.processQueue();
        },

        payLiabilityExec(id) {
            const item = this.state.liabilities.find(l => String(l.id) === String(id));
            if (!item) return;

            if (this.state.cash >= item.balance) {
                this.state.cash -= item.balance;
                this.state.liabilities = this.state.liabilities.filter(l => String(l.id) !== String(id));
                this.log(`ğŸ’¸ å·²è¿˜æ¸… ${item.name}`);
                this.updateUI();
                this.checkWinCondition();
            } else {
                this.log('ç°é‡‘ä¸è¶³', true);
            }
        },

        liquidateAsset(id) {
            const assetIdx = this.state.assets.findIndex(a => a.id === id);
            if (assetIdx === -1) return;
            const asset = this.state.assets[assetIdx];

            if (this.state.isFastTrack) return; 

            if (asset.type === 'Stock' || asset.type === 'Option') {
                const recoup = Math.floor((asset.cost * asset.quantity) / 2);
                if (!confirm(`ã€ç´§æ€¥æŠ›å”®ã€‘é“¶è¡ŒåŠä»·å›æ”¶è‚¡ç¥¨ï¼Œå¾—æ¬¾ $${recoup}ã€‚ç¡®å®šï¼Ÿ`)) return;
                this.state.cash += recoup;
            } else {
                const returnCash = Math.floor(asset.down / 2);
                if (!confirm(`ã€èµ„äº§æŠ›å”®ã€‘æŠ˜ä»·å–ç»™é“¶è¡Œï¼Œæ”¶å›é¦–ä»˜çš„ä¸€åŠ: $${returnCash}ã€‚ç¡®å®šå—ï¼Ÿ`)) return;
                this.state.passive -= (asset.flow || 0);
                this.state.cash += returnCash;
            }

            this.state.assets.splice(assetIdx, 1);
            this.log(`ğŸ’¸ èµ„äº§å·²å˜å–`);
            this.updateUI();
            this.renderSheet('paper');
        },

        chooseDeal(type) {
            if (type === 'Big' && this.state.cash < 500) { 
                this.log("âš ï¸ ç°é‡‘è¿‡å°‘"); return;
            }
            const deck = type === 'Big' ? CONFIG.bigDeals : CONFIG.smallDeals;
            // å¤åˆ¶ä¸€ä»½å¡ç‰‡æ•°æ®ï¼Œä»¥å…ä¿®æ”¹åŸå§‹é…ç½®
            let card = JSON.parse(JSON.stringify(deck[Math.floor(Math.random() * deck.length)]));

            // --- æ–°å¢ï¼šè‚¡ç¥¨ä»·æ ¼éšæœºæ³¢åŠ¨é€»è¾‘ ---
            if (card.type === 'Stock' && card.range) {
                // 1. è§£æèŒƒå›´ï¼Œä¾‹å¦‚ "$5-$30" å˜æˆ min=5, max=30
                const parts = card.range.replace(/\$/g, '').split('-');
                if (parts.length === 2) {
                    const min = parseInt(parts[0]);
                    const max = parseInt(parts[1]);
                    // 2. åœ¨èŒƒå›´å†…ç”Ÿæˆéšæœºæ•´æ•°
                    const randomPrice = Math.floor(Math.random() * (max - min + 1)) + min;
                    
                    // 3. æ›´æ–°å¡ç‰‡æ•°æ®çš„æˆæœ¬(å•ä»·)
                    card.cost = randomPrice;
                    
                    // 4. æ›´æ–°æè¿°ï¼Œé«˜äº®æ˜¾ç¤ºå½“å‰ä»·æ ¼ï¼Œå¢åŠ ç´§å¼ æ„Ÿ
                    const percent = Math.floor(((randomPrice - min) / (max - min)) * 100);
                    let mood = '';
                    if (percent < 20) mood = 'ğŸ“‰ å†å²ä½ä½ï¼';
                    else if (percent > 80) mood = 'ğŸ”¥ å†å²é«˜ä½ï¼';
                    
                    card.desc = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-400">å½“å‰æŠ¥ä»·</span>
                            <span class="text-xl font-bold ${percent < 50 ? 'text-green-600' : 'text-red-500'}">$${randomPrice}</span>
                        </div>
                        <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden mb-3">
                            <div class="bg-blue-500 h-full" style="width: ${percent}%"></div>
                        </div>
                        <p class="text-xs text-slate-500">${card.name} æ­£åœ¨äº¤æ˜“ä¸­ã€‚ä»·æ ¼æ³¢åŠ¨èŒƒå›´ ${card.range}ã€‚${mood}</p>
                    `;
                }
            }
            // -----------------------------------

            this.showCardModal('OPP', card);
        },

        queueEvent(event) {
            if (this.state.isGameOver && !this.state.isFastTrack && event.type !== 'INFO_DECISION') return;
            this.state.eventQueue.push(event);
        },

        processQueue() {
            if (this.state.eventQueue.length === 0) return;
            
            const overlay = document.getElementById('modal-overlay');
            if (!overlay.classList.contains('hidden') || overlay.style.display !== 'none') return; 

            const nextEvent = this.state.eventQueue.shift();
            
            if (uiTimer) clearTimeout(uiTimer);
            
            uiTimer = setTimeout(() => {
                this.showCardModal(nextEvent.type, nextEvent.data);
            }, 100);
        },

                handleMarket(card) {
            // é€»è¾‘ä¼˜åŒ–ï¼šå¦‚æœæ˜¯æœ‰äººä¹°æˆ¿/ä¼ä¸š
            if (card.type === 'Buyer') {
                const matchingAssets = this.state.assets.filter(a => a.name === card.target);
                
                if (matchingAssets.length > 0) {
                    // æ¸…ç©ºä¸Šæ¬¡çš„é€‰æ‹©
                    this.state.tempSelectedAssets.clear();

                    // ç”Ÿæˆå¤šé€‰åˆ—è¡¨ HTML
                    let htmlList = `<div class="space-y-2 mt-4 max-h-[220px] overflow-y-auto no-scrollbar py-1">`;
                    
                    matchingAssets.forEach(asset => {
                        const loan = asset.cost - asset.down;
                        const profit = card.price - loan - asset.down; // å‡€èµš = å”®ä»· - é“¶è¡Œè´·æ¬¾ - ä½ çš„é¦–ä»˜
                        
                        // æ³¨æ„ï¼šè¿™é‡Œ onclick è°ƒç”¨äº†æ–°å‡½æ•° toggleAssetSelect
                        htmlList += `
                            <div id="asset-card-${asset.id}" onclick="game.toggleAssetSelect('${asset.id}', ${card.price}, this)" 
                                class="selectable-card sheet-card mb-2 active:scale-[0.98]">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center select-indicator transition-colors">
                                        <div class="w-2.5 h-2.5 bg-white rounded-full opacity-0"></div>
                                    </div>
                                    <div>
                                        <div class="font-bold text-sm text-slate-800 dark:text-white">${asset.name}</div>
                                        <div class="text-[10px] text-slate-400">è´·æ¬¾: $${loan.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-green-600 text-sm">+$${profit.toLocaleString()}</div>
                                    <div class="text-[10px] text-slate-400">å‡€æ”¶ç›Š</div>
                                </div>
                            </div>
                        `;
                    });
                    htmlList += `</div>`;
                    
                    // æ³¨å…¥ç¡®è®¤æŒ‰é’®åŒºåŸŸ
                    htmlList += `
                        <div class="pt-4 mt-2 border-t border-slate-100 dark:border-white/5">
                            <button id="btn-multi-sell" onclick="game.executeMultiSell(${card.price})" disabled 
                                class="w-full py-3 bg-slate-200 dark:bg-white/10 text-slate-400 rounded-2xl font-bold transition-all shadow-none">
                                è¯·é€‰æ‹©è¦å–å‡ºçš„èµ„äº§
                            </button>
                        </div>
                    `;

                    this.queueEvent({
                        type: 'INFO_ONLY', 
                        data: {
                            name: `æœ‰äººæ±‚è´­: ${card.target}`,
                            desc: `${card.desc}<br><div class="text-xs text-slate-400 mt-1 mb-2">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼‰</div>${htmlList}`,
                            icon: 'ğŸ¤'
                        }
                    });
                } else {
                    this.log(`ğŸ“° å¸‚åœº: ${card.desc} (ä½ æ²¡æœ‰æ­¤èµ„äº§)`);
                }
            } 
            // è‚¡ç¥¨é€»è¾‘ä¿æŒä¸å˜
            else if (card.type === 'PriceChange') {
                // ... ä¿æŒåŸæœ‰ä»£ç ä¸å˜ ...
                const stocks = this.state.assets.filter(a => a.symbol === card.symbol && a.type === 'Stock');
                if (stocks.length > 0) {
                    stocks.forEach(stock => {
                        if (stock.quantity > 0) { 
                            const totalValue = stock.quantity * card.price;
                            const profit = totalValue - (stock.quantity * stock.cost);
                            
                            this.queueEvent({
                                type: 'MARKET_SELL',
                                data: {
                                    id: uuid(),
                                    name: `è¡Œæƒ…: ${card.symbol} $${card.price}`,
                                    desc: `${card.desc}<br>
                                            ä½ æœ‰ ${stock.quantity} è‚¡ (å‡ä»· $${Math.floor(stock.cost)})ã€‚<br><br>
                                            <div class="flex justify-between text-xs font-bold">
                                                <span>å¸‚å€¼: $${totalValue.toLocaleString()}</span>
                                                <span class="${profit>=0?'text-green-500':'text-red-500'}">
                                                ${profit>=0?'+':''}$${profit.toLocaleString()}
                                                </span>
                                            </div>`,
                                    icon: 'ğŸ“ˆ',
                                    sellPrice: totalValue, 
                                    targetAssetId: stock.id,
                                    roi: totalValue 
                                }
                            });
                        }
                    });
                } else {
                    this.log(`ğŸ“° å¸‚åœº: ${card.symbol} ç°ä»· $${card.price}`);
                }
                // ...
            }
            else if (card.type === 'Inflation') {
                this.log(`ğŸ“° å¸‚åœº: ${card.desc}`);
            }
            this.processQueue();
        },

        showCardModal(type, data) {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            if (uiTimer) clearTimeout(uiTimer);

            this.state.currentCard = { ...data, actionType: type };
            this.state.inputQty = 100; 
            
            this.openOverlay('card-modal');
            
            document.getElementById('modal-cash-display').innerText = '-' + this.state.loan.toLocaleString();

            const title = document.getElementById('card-title');
            const desc = document.getElementById('card-desc');
            const icon = document.getElementById('card-icon-bg');
            const financials = document.getElementById('card-financials');
            const inputArea = document.getElementById('input-area');
            const btnAction = document.getElementById('btn-card-action');
            const btnShort = document.getElementById('btn-short-action');
            const btnCancel = document.getElementById('btn-cancel');
            const tag = document.getElementById('card-tag');
            const inputPrice = document.getElementById('input-price-per');

            title.innerText = data.name;
            desc.innerHTML = data.desc;
            desc.className = "text-slate-500 dark:text-slate-400 text-sm mt-3 leading-relaxed px-2"; 
            icon.innerText = data.icon || 'ğŸ“„';
            tag.innerText = type === 'OPP' ? (data.type === 'Business' ? 'Big Deal' : 'Deal') : type;
            tag.classList.remove('hidden');

            financials.classList.add('hidden');
            inputArea.classList.add('hidden');
            btnShort.classList.add('hidden');
            btnAction.classList.remove('hidden');
            btnCancel.classList.remove('hidden'); 

            btnAction.className = "flex-[1.5] py-3.5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 dark:shadow-none tap-effect text-sm transition-colors";
            
            // å¦‚æœæ˜¯ INFO_ONLYï¼Œä¸¥æ ¼éšè—æ“ä½œæŒ‰é’®ï¼Œå¹¶è°ƒæ•´å–æ¶ˆæŒ‰é’®æ ·å¼
            if (type === 'INFO_ONLY') {
                btnAction.classList.add('hidden');
                btnShort.classList.add('hidden'); 
                btnCancel.innerText = 'å…³é—­';
                btnCancel.classList.remove('flex-1');
                btnCancel.classList.add('w-full', 'bg-slate-200', 'dark:bg-white/20', 'text-slate-900', 'dark:text-white'); 
            } else {
                btnAction.classList.remove('hidden');
                btnCancel.classList.add('flex-1'); 
                btnCancel.classList.remove('w-full', 'bg-slate-200', 'dark:bg-white/20', 'text-slate-900', 'dark:text-white');
            }
            

            if (type === 'OPP') {
                if (data.type === 'Stock') {
                    inputArea.classList.remove('hidden');
                    inputPrice.innerText = `$${data.cost}`;
                    this.updateInputTotal(); 
                    btnAction.innerText = 'ç°é‡‘ä¹°å…¥';
                } else {
                    financials.classList.remove('hidden');
                    document.getElementById('lbl-cost').innerText = 'æ€»ä»·';
                    document.getElementById('val-cost').innerText = `$${data.cost.toLocaleString()}`;
                    document.getElementById('lbl-down').innerText = 'é¦–ä»˜/æˆæœ¬';
                    document.getElementById('val-down').innerText = `$${data.down.toLocaleString()}`;
                    document.getElementById('val-flow').innerText = `+$${data.flow.toLocaleString()}`;
                    btnAction.innerText = this.state.isFastTrack ? 'æŠ•èµ„é¡¹ç›®' : 'è´­ä¹°èµ„äº§';
                }
            } 
            else if (type === 'MARKET_SELL') {
                btnAction.innerText = 'ç¡®è®¤å–å‡º';
                btnAction.classList.replace('bg-blue-600', 'bg-green-600');
                financials.classList.add('hidden');
            }
            else if (type === 'DOODAD') {
                tag.classList.add('hidden');
                financials.classList.add('hidden');
                btnCancel.classList.add('hidden');
                desc.className = "text-3xl font-bold text-slate-900 dark:text-white my-6 text-center tracking-tight"; 
                desc.innerText = `-$${data.cost.toLocaleString()}`;
                btnAction.innerText = `æ”¯ä»˜`; 
                btnAction.classList.replace('bg-blue-600', 'bg-red-500');
            }
            else if (type === 'INFO_DECISION') {
                btnAction.innerText = `ç¡®è®¤ ($${data.cost.toLocaleString()})`;
            }
        },

        manualInputShares(val) {
            const num = parseInt(val) || 0;
            this.state.inputQty = num < 0 ? 0 : num;
            this.updateInputTotal();
        },

        adjustShares(delta) {
            let newQty = this.state.inputQty + delta;
            if (newQty < 0) newQty = 0;
            this.state.inputQty = newQty;
            document.getElementById('input-qty-field').value = newQty;
            this.updateInputTotal();
        },

        updateInputTotal() {
            const card = this.state.currentCard;
            if (card && card.cost) {
                document.getElementById('input-total').innerText = '$' + (this.state.inputQty * card.cost).toLocaleString();
            }
        },

        confirmCardAction(intent) {
            const card = this.state.currentCard;
            if (!card) return; 

            if (card.actionType === 'INFO_DECISION') {
                    if (card.onConfirm) card.onConfirm();
            }
            else if (card.actionType === 'OPP') {
                if (card.type === 'Stock') {
                    const cost = card.cost * this.state.inputQty;
                    if (intent === 'BUY') {
                        if (this.state.cash >= cost) {
                            const existingStock = this.state.assets.find(a => a.type === 'Stock' && a.symbol === card.symbol);
                            if (existingStock) {
                                const oldTotalCost = existingStock.cost * existingStock.quantity;
                                const newTotalCost = cost;
                                const newQty = existingStock.quantity + this.state.inputQty;
                                this.state.cash -= cost;
                                existingStock.quantity = newQty;
                                existingStock.cost = (oldTotalCost + newTotalCost) / newQty;
                                this.log(`ğŸ›’ åŠ ä»“ ${card.symbol} (+${this.state.inputQty}è‚¡)`);
                            } else {
                                this.state.cash -= cost;
                                this.state.assets.push({ ...card, id: uuid(), quantity: this.state.inputQty, displayName: card.name });
                                this.log(`ğŸ›’ ä¹°å…¥ ${card.symbol}`);
                            }
                        } else { this.shakeModal(); return; }
                    }
                } else {
                    if (this.state.cash >= card.down) {
                        this.state.cash -= card.down;
                        this.state.assets.push({ ...card, id: uuid() });
                        this.state.passive += card.flow;
                        
                        if (this.state.isFastTrack) {
                            this.state.ftAddedCashflow += card.flow;
                            this.state.salary += card.flow; 
                            this.log(`ğŸš€ æŠ•èµ„æˆåŠŸ! ç°é‡‘æµ +$${card.flow.toLocaleString()}`);
                        } else {
                            this.log(`ğŸ  è´­å…¥èµ„äº§: +$${card.flow.toLocaleString()}/æœˆ`);
                        }

                    if (this.state.isFastTrack && this.state.currentCard && this.state.currentCard.tempPos !== undefined) {
                        this.state.fastTrackBiz[this.state.currentCard.tempPos] = {
                            name: card.name,
                            icon: card.icon,
                            flow: card.flow
                        };
                        delete this.state.currentCard.tempPos;
                        this.renderBoard(); 
                    }

                    } else { this.shakeModal(); return; }
                }
            }
            else if (card.actionType === 'MARKET_SELL') {
                this.state.cash += card.roi;
                const idx = this.state.assets.findIndex(a => a.id === card.targetAssetId);
                if (idx > -1) {
                        if (this.state.assets[idx].flow) this.state.passive -= this.state.assets[idx].flow;
                        this.state.assets.splice(idx, 1);
                }
                this.log(`ğŸ’° èµ„äº§å˜ç°æˆåŠŸ`);
            }
            else if (card.actionType === 'DOODAD') {
                if(this.state.cash < card.cost) {
                        const needed = card.cost - this.state.cash;
                        const loanAmt = Math.ceil(needed / 1000) * 1000;
                        if (loanAmt > 0) this.manageLoan(loanAmt);
                }
                this.state.cash -= card.cost;
                this.log(`ğŸ’¸ æ”¯ä»˜ $${card.cost}`);
            }

            this.checkWinCondition();
            this.updateUI();
            
            if (!this.state.isGameOver) {
                this.closeModal();
            }
        },

        shakeModal() {
            const m = document.getElementById('card-modal');
            m.classList.remove('modal-enter'); m.classList.add('shake-anim');
            setTimeout(() => m.classList.remove('shake-anim'), 400);
        },

        // æ–°å¢ï¼šç›´æ¥å–å‡ºæŒ‡å®šèµ„äº§çš„å‡½æ•°ï¼ˆç”¨äºåˆå¹¶åçš„å¸‚åœºå¼¹çª—ï¼‰
        sellAssetDirect(assetId, price) {
            const idx = this.state.assets.findIndex(a => a.id === assetId);
            if (idx > -1) {
                const asset = this.state.assets[idx];
                const loan = asset.cost - asset.down;
                const netCash = price - loan;
                
                this.state.cash += netCash;
                if (asset.flow) this.state.passive -= asset.flow;
                this.state.assets.splice(idx, 1);
                
                this.log(`ğŸ’° æˆåŠŸä»¥ $${price.toLocaleString()} å–å‡º ${asset.name}`);
                this.checkWinCondition();
                this.updateUI();
                this.renderSheet('paper');
                
                // å–å‡ºä¸€ä¸ªåï¼Œå…³é—­å¼¹çª—ã€‚å¦‚æœæƒ³æ”¯æŒè¿ç»­å–ï¼Œå¯ä»¥é‡æ–°è§¦å‘handleMarketæ£€æµ‹ï¼Œè¿™é‡Œç®€å•å¤„ç†ç›´æ¥å…³é—­
                this.closeModal();
            }
        },

        // --- æ–°å¢ï¼šå¤„ç†ç‚¹å‡»é€‰æ‹© ---
        toggleAssetSelect(id, price, el) {
            const btn = document.getElementById('btn-multi-sell');
            const indicator = el.querySelector('.select-indicator');
            const innerDot = indicator.querySelector('div');

            if (this.state.tempSelectedAssets.has(id)) {
                // å–æ¶ˆé€‰ä¸­
                this.state.tempSelectedAssets.delete(id);
                el.classList.remove('selected');
                el.style.borderColor = 'transparent';
                el.style.background = '';
                
                indicator.classList.remove('bg-green-500', 'border-green-500');
                indicator.classList.add('border-slate-300', 'dark:border-slate-600');
                innerDot.classList.remove('opacity-100');
            } else {
                // é€‰ä¸­
                this.state.tempSelectedAssets.add(id);
                el.classList.add('selected');
                // å¼ºåˆ¶æ ·å¼è¦†ç›–
                indicator.classList.remove('border-slate-300', 'dark:border-slate-600');
                indicator.classList.add('bg-green-500', 'border-green-500');
                innerDot.classList.add('opacity-100');
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const count = this.state.tempSelectedAssets.size;
            if (count > 0) {
                btn.disabled = false;
                btn.innerHTML = `ç¡®è®¤å–å‡º (${count}å¥—)`;
                btn.className = "w-full py-3 bg-green-600 text-white rounded-2xl font-bold shadow-lg shadow-green-200 dark:shadow-none tap-effect transition-all transform hover:scale-[1.02]";
            } else {
                btn.disabled = true;
                btn.innerHTML = `è¯·é€‰æ‹©è¦å–å‡ºçš„èµ„äº§`;
                btn.className = "w-full py-3 bg-slate-200 dark:bg-white/10 text-slate-400 rounded-2xl font-bold transition-all shadow-none";
            }
        },

        // --- æ–°å¢ï¼šæ‰§è¡Œæ‰¹é‡å–å‡º ---
        executeMultiSell(unitPrice) {
            const count = this.state.tempSelectedAssets.size;
            if (count === 0) return;

            let totalProfit = 0;
            
            // éå†å¹¶å–å‡º
            // å€’åºéå†é˜²æ­¢ splice ç´¢å¼•é”™ä½ï¼Œæˆ–è€…ä½¿ç”¨ filter é‡å»ºæ•°ç»„
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ ID æŸ¥æ‰¾æ³•
            const assetsToKeep = [];
            
            this.state.assets.forEach(asset => {
                if (this.state.tempSelectedAssets.has(asset.id)) {
                    const loan = asset.cost - asset.down;
                    const netCash = unitPrice - loan;
                    
                    this.state.cash += netCash;
                    if (asset.flow) this.state.passive -= asset.flow;
                    
                    totalProfit += (netCash - asset.down); // ç»Ÿè®¡çº¯åˆ©æ¶¦ç”¨äºå±•ç¤º
                } else {
                    assetsToKeep.push(asset);
                }
            });

            this.state.assets = assetsToKeep;
            this.state.tempSelectedAssets.clear();

            this.log(`ğŸ’° æˆåŠŸå–å‡º ${count} å¤„èµ„äº§ï¼Œç°é‡‘å¤§å¹…å›æµï¼`);
            this.checkWinCondition();
            this.updateUI();
            this.renderSheet('paper'); // åˆ·æ–°æŠ¥è¡¨
            this.closeModal(); // å…³é—­å¼¹çª—
        },

        checkWinCondition() {
            if (this.state.isGameOver) return; 

            if (this.state.isFastTrack) {
                if (this.state.ftAddedCashflow >= 50000) {
                    this.winGame('CASHFLOW');
                }
            } else {
                const totalExp = this.totalExpense;
                if (this.state.passive > totalExp) {
                    this.enterFastTrack();
                }
            }
        },

     declareBankruptcy() {
         if (confirm('â˜ ï¸ ä½ ç¡®å®šè¦å®£å¸ƒç ´äº§å—ï¼Ÿ\n\nè¿™å°†ç«‹å³ç»“æŸæ¸¸æˆï¼Œä½ å°†å¤±å»ä¸€åˆ‡è¿›å±•ã€‚')) {
             this.state.isGameOver = true;
             this.isMoving = false;

             document.getElementById('end-icon').innerText = 'â˜ ï¸';
             document.getElementById('end-title').innerText = 'ç ´äº§æ¸…ç®—';
             document.getElementById('end-desc').innerHTML = `
                 å€ºåŠ¡å·²å°†ä½ å‹å®ã€‚<br><br>
                 <span class="text-xs opacity-70">è®°ä½ï¼šåå€ºåŠ¡ä¼šæ¯æ‰ä¸€åˆ‡ã€‚<br>
                 ä¸‹æ¬¡ä¼˜å…ˆæŠ•èµ„äº§ç”Ÿè¢«åŠ¨æ”¶å…¥ï¼Œé¿å…è¿‡åº¦æ¶ˆè´¹ã€‚</span>
             `;

             this.openOverlay('game-over-modal');
             document.getElementById('dice-controls').innerHTML = '';

             const btn = document.querySelector('#game-over-modal button');
             btn.innerText = "é‡æ–°å¼€å§‹";
             btn.onclick = () => location.reload();
         }
     },

        // --- æ–°å¢ï¼šAI æ ¸å¿ƒé€»è¾‘ ---
                        runAiTurn() {
            if (this.state.isGameOver) return;
            this.state.isAiTurn = true;
            this.updateUI();
            
            this.log(`ğŸ¤– ${this.state.ai.name} æ­£åœ¨æ€è€ƒ...`);
            
            setTimeout(() => {
                // === ä¿®å¤ 1: AI ä½¿ç”¨è‡ªå·±çš„åœ°å›¾é€»è¾‘ï¼Œä¸ä¾èµ–ç©å®¶ ===
                // ç¡®ä¿ AI å¯¹è±¡é‡Œæœ‰ isFastTrack å±æ€§ï¼Œå¦‚æœæ²¡æœ‰é»˜è®¤ä¸º false
                const aiInFastTrack = !!this.state.ai.isFastTrack; 
                const tiles = aiInFastTrack ? CONFIG.fastTrackTiles : CONFIG.tiles;
                
                // 1. æ·éª°å­
                const dice = Math.floor(Math.random() * 6) + 1;
                
                // 2. ç§»åŠ¨
                this.state.ai.pos = (this.state.ai.pos + dice) % tiles.length;
                this.renderBoard(); // é‡æ–°æ¸²æŸ“ï¼Œå¦‚æœåœ¨åŒä¸€å¼ å›¾ä¸Šèƒ½çœ‹åˆ°ç§»åŠ¨
                
                const tile = tiles[this.state.ai.pos];
                
                // 3. æ ¸å¿ƒå†³ç­–é€»è¾‘
                setTimeout(() => {
                    let msg = '';
                    
                    // === æƒ…å†µ A: ç»“ç®—æ—¥ ===
                    if (tile.type === 'Pay' || tile.type === 'FT_Pay') {
                        const income = this.state.ai.flow;
                        this.state.ai.cash += income;
                        this.animChange('display-cash', 'positive');
                        msg = `ğŸ’° AI ç»“ç®—æ—¥ï¼šç°é‡‘ +$${income.toLocaleString()}`;
                    }
                    
                    // === æƒ…å†µ B: æœºä¼š (æŠ•èµ„) ===
                    else if (tile.type === 'Opp' || tile.type === 'FT_Biz') {
                        let card = null;
                        
                        if (aiInFastTrack) {
                            card = CONFIG.fastTrackDeals[Math.floor(Math.random() * CONFIG.fastTrackDeals.length)];
                        } else {
                            // ã€AI å‡çº§ã€‘æ›´æ¿€è¿›åœ°æŸ¥çœ‹å¤§ç”Ÿæ„ã€‚åªè¦ç°é‡‘æµä¸ºæ­£ä¸”æ‰‹å¤´æœ‰ $1500 å°±æ•¢çœ‹å¤§ç”Ÿæ„ï¼Œåˆ©ç”¨é“¶è¡Œæ æ†ã€‚
                            const aggressiveThreshold = 1500; 
                            const canAffordBig = this.state.ai.cash > aggressiveThreshold;
                            // 70% æ¦‚ç‡çœ‹å¤§ç”Ÿæ„ï¼Œ30% çœ‹å°ç”Ÿæ„ï¼ˆåŸæ¥æ˜¯éšæœºï¼‰
                            const wantBig = canAffordBig ? (Math.random() > 0.3) : false; 
                            const deck = wantBig ? CONFIG.bigDeals : CONFIG.smallDeals;
                            const rawCard = deck[Math.floor(Math.random() * deck.length)];
                            card = { ...rawCard }; 
                        }

                        let costToPay = 0;
                        let flowToGet = 0;
                        let dealName = card.name;
                        let willBuy = false;
                        let loanNeeded = 0;
                        
                        if (card.type === 'Stock') {
                            // ã€AI å‡çº§ã€‘è‚¡ç¥¨é€»è¾‘ï¼šåªè¦ä»·æ ¼åœ¨ä½ä½åŒºé—´ï¼ˆä½äºæœ€é«˜ä»·çš„ 50%ï¼‰ï¼Œå°±å¤§ä¸¾ä¹°å…¥
                            const rangeParts = card.range ? card.range.replace(/\$/g, '').split('-') : [10, 30];
                            const highPrice = parseInt(rangeParts[1]);
                            
                            if (card.cost <= highPrice * 0.6) {
                                // å³ä½¿å€Ÿé’±ä¹Ÿè¦ä¹°ä½ä»·è‚¡ï¼ˆæ¨¡æ‹Ÿé«˜é£é™©åå¥½ï¼‰ï¼Œä½†è¿™é‡Œä¿å®ˆä¸€ç‚¹ï¼Œåªç”¨ç°é‡‘
                                const maxAfford = Math.floor(this.state.ai.cash / card.cost);
                                if (maxAfford > 0) {
                                    // æ¢­å“ˆ 50% - 100% çš„ç°é‡‘
                                    const investRatio = 0.5 + (Math.random() * 0.5); 
                                    const qty = Math.floor((this.state.ai.cash * investRatio) / card.cost / 100) * 100;
                                    if (qty > 0) {
                                        costToPay = card.cost * qty;
                                        dealName = `${card.symbol} (${qty}è‚¡)`;
                                        willBuy = true;
                                    }
                                }
                            }
                        } else {
                            // ã€AI å‡çº§ã€‘æˆ¿äº§/ä¼ä¸šé€»è¾‘
                            costToPay = card.down || card.cost; 
                            flowToGet = card.flow || 0;
                            
                            const cashGap = costToPay - this.state.ai.cash;
                            
                            if (cashGap <= 0) {
                                // ç°é‡‘è¶³å¤Ÿï¼Œåªè¦æœ‰æ­£æ”¶ç›Šå°±ä¹°ï¼Œæˆ–è€…æ”¶ç›Šä¸º0ä½†é¦–ä»˜æä½ï¼ˆèµŒå‡å€¼ï¼‰
                                if (flowToGet >= 0) willBuy = true;
                            } else {
                                // ç°é‡‘ä¸è¶³ï¼Œè®¡ç®—è´·æ¬¾
                                loanNeeded = Math.ceil(cashGap / 1000) * 1000;
                                const monthlyInterest = loanNeeded * 0.1;
                                const netFlow = flowToGet - monthlyInterest;

                                // ã€AI æ ¸å¿ƒç­–ç•¥ã€‘åªè¦ (ç°é‡‘æµ - åˆ©æ¯) > 0ï¼Œè¿™å°±å«â€œæ— é™å›æŠ¥ç‡â€ï¼Œå¿…é¡»ä¹°ï¼
                                // å³ä½¿ netFlow åªæ˜¯ +$10ï¼Œå¯¹äº AI æ¥è¯´ä¹Ÿæ˜¯å‡€èµšã€‚
                                if (netFlow >= 0) {
                                    willBuy = true;
                                    this.state.ai.expense += monthlyInterest;
                                    this.state.ai.cash += loanNeeded; 
                                }
                            }
                        }

                        if (willBuy) {
                            this.state.ai.cash -= costToPay;
                            if (card.type !== 'Stock') {
                                this.state.ai.passive += flowToGet;
                                this.state.ai.flow = (this.state.ai.salary + this.state.ai.passive) - this.state.ai.expense;
                            }
                            
                            let logTail = loanNeeded > 0 
                                ? `<br><span class="text-red-400 font-bold">âš¡ï¸ æ¿€è¿›èèµ„ $${loanNeeded/1000}k</span>` 
                                : `<br><span class="text-xs opacity-70">å…¨æ¬¾æ‹¿ä¸‹</span>`;

                            msg = `ğŸ¢ AI æ‹¿ä¸‹äº† ${dealName}${logTail}`;
                        } else {
                            msg = `ğŸ‘€ AI æ”¾å¼ƒäº† ${dealName} <span class="text-[9px] opacity-50">(æ— åˆ©å¯å›¾)</span>`;
                        }
                    }
                    
                    // === æƒ…å†µ C: é¢å¤–æ”¯å‡º ===
                    else if (tile.type === 'Doodad' || tile.type === 'FT_Hazard') {
                        const doodad = CONFIG.doodads[Math.floor(Math.random() * CONFIG.doodads.length)];
                        const cost = doodad.cost;
                        
                        if (this.state.ai.cash >= cost) {
                            this.state.ai.cash -= cost;
                            msg = `ğŸ’¸ AI æ”¯å‡ºï¼š${doodad.name} (-$${cost})`;
                        } else {
                            const loan = Math.ceil((cost - this.state.ai.cash)/1000) * 1000;
                            this.state.ai.cash += loan; // å€Ÿé’±
                            this.state.ai.cash -= cost; // ä»˜æ¬¾
                            this.state.ai.expense += (loan * 0.1); // åŠ åˆ©æ¯
                            this.state.ai.flow = (this.state.ai.salary + this.state.ai.passive) - this.state.ai.expense;
                            msg = `ğŸ’¸ AI è´·æ¬¾æ”¯ä»˜äº† ${doodad.name}`;
                        }
                    }
                    // === æƒ…å†µ D: ç”Ÿå­©å­ ===
                    else if (tile.type === 'Baby' || tile.type === 'FT_Dream') {
                         if(tile.type === 'Baby') {
                             const childCost = CONFIG.professions.find(p => p.name === this.state.ai.jobTitle)?.perChild || 100;
                             this.state.ai.expense += childCost;
                             this.state.ai.flow = (this.state.ai.salary + this.state.ai.passive) - this.state.ai.expense;
                             msg = `ğŸ‘¶ AI å–œå¾—è´µå­ (æ”¯å‡º +$${childCost})`;
                         } else {
                             msg = `ğŸ’­ AI æ­£åœ¨æ¢¦æƒ³æ ¼å­ä¸Šåšæ¢¦`;
                         }
                    }
                    else {
                        msg = `ğŸ² AI åœç•™åœ¨ ${tile.label}`;
                    }

                    this.log(msg, true);
                    this.updateUI(); 
                    
                    // AI çš„ç®€å•èƒœåˆ©åˆ¤æ–­ï¼ˆè¿›å…¥å¿«è½¦é“ï¼‰
                    // å¦‚æœ AI è¢«åŠ¨æ”¶å…¥ > æ”¯å‡ºï¼Œä¸”è¿˜æœªè¿›å¿«è½¦é“
                    if (!aiInFastTrack && this.state.ai.passive > this.state.ai.expense) {
                        setTimeout(() => {
                            this.state.ai.isFastTrack = true; // æ ‡è®° AI è¿›å…¥å¿«è½¦é“
                            this.state.ai.pos = 0; // é‡ç½®ä½ç½®
                            this.state.ai.cash += (this.state.ai.passive * 100); // å¥–åŠ±ç°é‡‘
                            this.log(`ğŸš€ AI å®ç°äº†è´¢åŠ¡è‡ªç”±ï¼Œæ™‹çº§å¿«è½¦é“ï¼`, true);
                        }, 1000);
                    }

                    setTimeout(() => {
                        this.state.isAiTurn = false;
                        this.log(`ğŸ«µ è½®åˆ°ä½ äº†ï¼`);
                        this.updateUI();
                    }, 1500);
                    
                }, 1000); // ç§»åŠ¨åçš„å»¶è¿Ÿ
                
            }, 1000); // æ€è€ƒå»¶è¿Ÿ
        },

        winGame(type) {
            this.state.isGameOver = true; 
            this.isMoving = false; 
            
            setTimeout(() => {
                if (uiTimer) clearTimeout(uiTimer);
                this.state.eventQueue = [];
                
                let title = '', desc = '';
                if (type === 'DREAM') {
                    title = 'æ¢¦æƒ³æˆçœŸï¼';
                    desc = `æ­å–œï¼ä½ ä¹°ä¸‹äº† <b class="text-pink-500">${this.state.userDream.name}</b>ã€‚<br>ä½ èµ¢å¾—äº†æ•´åœºæ¸¸æˆï¼`;
                } else {
                    title = 'é‡‘é’±å¸å›½ï¼';
                    desc = `æ­å–œï¼ä½ åœ¨å¿«è½¦é“å»ºç«‹äº† <b class="text-green-500">+$${this.state.ftAddedCashflow.toLocaleString()}/æœˆ</b> çš„é¢å¤–ç°é‡‘æµã€‚<br>ä½ æ˜¯çœŸæ­£çš„èµ„æœ¬å¤§é³„ï¼`;
                }

                document.getElementById('end-icon').innerText = 'ğŸ†';
                document.getElementById('end-title').innerText = title;
                document.getElementById('end-desc').innerHTML = desc;
                
                const sheet = document.getElementById('sheet-modal');
                sheet.classList.add('hidden');
                sheet.style.display = 'none';

                this.openOverlay('game-over-modal');
                document.getElementById('dice-controls').innerHTML = '';
                
                const btn = document.querySelector('#game-over-modal button');
                btn.innerText = "é‡æ–°å¼€å§‹";
                btn.onclick = () => location.reload();
            }, 50);
        },

        toggleSheet() {
            const sheet = document.getElementById('sheet-modal');
            if (sheet.classList.contains('hidden')) {
                this.renderSheet(this.state.currentTab);
                sheet.style.display = 'flex'; sheet.classList.remove('hidden');
            } else {
                sheet.style.display = 'none'; sheet.classList.add('hidden');
            }
        },

        switchTab(tab, btn) {
            this.state.currentTab = tab;
            document.querySelectorAll('.segment-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('panel-invest').classList.toggle('hidden', tab !== 'paper');
            document.getElementById('panel-debt').classList.toggle('hidden', tab !== 'debt');
            this.renderSheet(tab);
        },

                renderSheet(tab) {
            // ä¿æŒå¤–éƒ¨è´·æ¬¾é¢æ¿çš„æ•°æ®æ›´æ–°
            document.getElementById('sheet-loan').innerText = '$' + this.state.loan.toLocaleString();
            document.getElementById('sheet-interest').innerText = '$' + (this.state.loan * 0.1).toLocaleString();
            document.getElementById('sheet-kids').innerText = this.state.childCount;
            document.getElementById('sheet-kid-cost').innerText = this.childExpense.toLocaleString();

            const container = (tab === 'paper') ? document.getElementById('sheet-content') : document.getElementById('liabilities-list');
            container.innerHTML = '';

            // è·å–åŸºç¡€æ•°æ®
            const totalIncome = this.state.salary + this.state.passive;
            const totalExp = this.totalExpense;
            const netFlow = totalIncome - totalExp;
            
            // --- é€‰é¡¹å¡ 1: èµ„äº§ä¸ä»ªè¡¨ç›˜ (å®Œå…¨é‡æ„) ---
            if (tab === 'paper') {
                
                // 1. é¡¶éƒ¨ï¼šFintech ä»ªè¡¨ç›˜
                // è®¡ç®—è¿›åº¦ï¼šè¢«åŠ¨æ”¶å…¥ vs æ€»æ”¯å‡º
                const progressPct = totalExp > 0 ? Math.min((this.state.passive / totalExp) * 100, 100) : 100;
                // è®¡ç®—æ”¯å‡ºçº¢çº¿çš„ä½ç½® (å¦‚æœæ˜¯100%åˆ™æ»¡äº†)
                const expenseMarker = 100; 

                container.innerHTML += `
                    <div class="fintech-header">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">æœˆå‡€ç°é‡‘æµ</div>
                                <div class="text-3xl font-bold tracking-tight text-white">$${netFlow.toLocaleString()}</div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl">
                                ${netFlow >= 0 ? 'ğŸ¤‘' : 'ğŸ’¸'}
                            </div>
                        </div>

                        <div class="relative pt-2">
                            <div class="flex justify-between text-[10px] font-medium text-slate-300 mb-1">
                                <span>è¢«åŠ¨æ”¶å…¥: $${this.state.passive.toLocaleString()}</span>
                                <span class="text-red-300">æ€»æ”¯å‡º: $${totalExp.toLocaleString()}</span>
                            </div>
                            <div class="freedom-track">
                                <div class="freedom-bar" style="width: ${progressPct}%"></div>
                                </div>
                            <div class="text-[10px] text-emerald-400 text-right font-bold mt-1">
                                è‡ªç”±è¿›åº¦: ${Math.floor(progressPct)}%
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="text-[10px] text-slate-400 uppercase">å·¥èµ„æ”¶å…¥</div>
                                <div class="text-sm font-bold text-white">$${this.state.salary.toLocaleString()}</div>
                            </div>
                            <div class="stat-box">
                                <div class="text-[10px] text-slate-400 uppercase">æ‰‹å¤´ç°é‡‘</div>
                                <div class="text-sm font-bold text-white">$${this.state.cash.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;

                // 2. èµ„äº§åˆ—è¡¨ç”Ÿæˆå™¨
                if (this.state.assets.length === 0) {
                    container.innerHTML += `
                        <div class="flex flex-col items-center justify-center py-16 opacity-40">
                            <div class="text-6xl mb-4 grayscale opacity-50">ğŸŒ±</div>
                            <div class="text-sm font-medium">æš‚æ— èµ„äº§ç»„åˆ</div>
                            <button onclick="game.toggleSheet()" class="mt-4 px-4 py-2 bg-slate-200 dark:bg-white/10 rounded-full text-xs font-bold">å»æŠ•èµ„</button>
                        </div>`;
                } else {
                    const renderAssetRow = (title, meta, flow, icon, type) => `
                        <div class="asset-row tap-effect">
                            <div class="flex items-center flex-1 min-w-0">
                                <div class="asset-icon-circle">${icon}</div>
                                <div class="truncate pr-3">
                                    <div class="font-bold text-[15px] text-slate-800 dark:text-slate-100 truncate">${title}</div>
                                    <div class="text-[11px] text-slate-400 mt-0.5">${meta}</div>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="font-bold text-[14px] ${flow > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400'}">
                                    ${flow > 0 ? '+' : ''}$${flow.toLocaleString()}
                                </div>
                                <div class="text-[9px] text-slate-400 font-medium uppercase mt-0.5">æœˆæµ</div>
                            </div>
                        </div>
                    `;

                    // åˆ†ç±»æ¸²æŸ“ï¼šè‚¡ç¥¨
                    const stocks = this.state.assets.filter(a => a.type === 'Stock');
                    if (stocks.length > 0) {
                        container.innerHTML += `<div class="section-label">ğŸ“Š è¯åˆ¸è´¦æˆ·</div>`;
                        // åˆå¹¶åŒç±»è‚¡ç¥¨
                        const stockMap = {};
                        stocks.forEach(s => {
                            if(!stockMap[s.symbol]) stockMap[s.symbol] = { ...s, totalQty: 0, totalCost: 0 };
                            stockMap[s.symbol].totalQty += s.quantity;
                            stockMap[s.symbol].totalCost += (s.cost * s.quantity);
                        });
                        Object.values(stockMap).forEach(s => {
                            const avg = Math.floor(s.totalCost / s.totalQty);
                            container.innerHTML += renderAssetRow(s.symbol, `${s.totalQty}è‚¡ Â· å‡ä»· $${avg}`, 0, 'ğŸ“ˆ', 'Stock');
                        });
                    }

                    // åˆ†ç±»æ¸²æŸ“ï¼šæˆ¿åœ°äº§
                    const realEstate = this.state.assets.filter(a => a.type === 'RealEstate');
                    if (realEstate.length > 0) {
                        container.innerHTML += `<div class="section-label">ğŸ  ä¸åŠ¨äº§</div>`;
                        realEstate.forEach(a => {
                            const debt = a.cost - a.down;
                            container.innerHTML += renderAssetRow(a.name, `è´Ÿå€º $${debt.toLocaleString()}`, a.flow, 'ğŸ¡', 'RE');
                        });
                    }

                    // åˆ†ç±»æ¸²æŸ“ï¼šä¼ä¸š
                    const business = this.state.assets.filter(a => a.type === 'Business');
                    if (business.length > 0) {
                        container.innerHTML += `<div class="section-label">ğŸ¢ ä¼ä¸šè‚¡æƒ</div>`;
                        business.forEach(a => {
                            container.innerHTML += renderAssetRow(a.name, `åˆå§‹æŠ•å…¥ $${a.down.toLocaleString()}`, a.flow, 'ğŸš€', 'Biz');
                        });
                    }
                    
                    // å…¶ä»–
                    const others = this.state.assets.filter(a => !['Stock', 'RealEstate', 'Business'].includes(a.type));
                    if (others.length > 0) {
                         container.innerHTML += `<div class="section-label">ğŸ’ å…¶ä»–èµ„äº§</div>`;
                         others.forEach(a => container.innerHTML += renderAssetRow(a.name, 'æ”¶è—å“', a.flow, 'ğŸº', 'Other'));
                    }
                }
                
                container.innerHTML += '<div class="h-24"></div>';
            }

            // --- é€‰é¡¹å¡ 2: è´Ÿå€ºç®¡ç† (åŒæ ·é£æ ¼åŒ–) ---
            else if (tab === 'debt') {
                const fixedCost = this.state.basicTax + this.state.otherExpense;
                
                // çº¢è‰²è­¦ç¤ºå¤´éƒ¨
                container.innerHTML += `
                    <div class="fintech-header" style="background: linear-gradient(135deg, #7f1d1d, #450a0a);">
                        <div class="text-white/60 text-[10px] font-bold uppercase mb-1">æœˆæ€»æ”¯å‡º</div>
                        <div class="text-3xl font-bold text-white mb-2">-$${totalExp.toLocaleString()}</div>
                        <div class="text-[11px] text-white/50 bg-black/20 inline-block px-2 py-1 rounded-lg">å‡å°‘è´Ÿå€ºå¯é™ä½æ­¤æ•°å€¼</div>
                    </div>
                    
                    <div class="section-label">âš ï¸ åˆšæ€§æ”¯å‡º</div>
                    <div class="asset-row">
                        <div class="flex items-center gap-3">
                            <div class="asset-icon-circle bg-slate-100 text-slate-500">ğŸ“‰</div>
                            <div>
                                <div class="font-bold text-slate-800 dark:text-slate-100">ç¨è´¹ & æ‚è´¹</div>
                                <div class="text-xs text-slate-400">æ— æ³•é¿å…</div>
                            </div>
                        </div>
                        <div class="font-bold text-red-500">-$${fixedCost.toLocaleString()}</div>
                    </div>
                `;

                if (this.childExpense > 0) {
                     container.innerHTML += `
                        <div class="asset-row">
                            <div class="flex items-center gap-3">
                                <div class="asset-icon-circle bg-pink-50 text-pink-500">ğŸ‘¶</div>
                                <div>
                                    <div class="font-bold text-slate-800 dark:text-slate-100">æŠšå…»è´¹</div>
                                    <div class="text-xs text-slate-400">${this.state.childCount} ä¸ªå­©å­</div>
                                </div>
                            </div>
                            <div class="font-bold text-red-500">-$${this.childExpense.toLocaleString()}</div>
                        </div>
                     `;
                }

                if (this.state.liabilities.length > 0) {
                    container.innerHTML += `<div class="section-label">ğŸ’³ åè´¦ (ç‚¹å‡»è¿˜æ¬¾)</div>`;
                    this.state.liabilities.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'asset-row tap-effect active:scale-[0.98] transition-transform';
                        div.onclick = () => game.promptPayLiability(item.id);
                        div.innerHTML = `
                             <div class="flex items-center flex-1">
                                <div class="asset-icon-circle bg-red-50 text-red-500 border-red-100">ğŸš«</div>
                                <div>
                                    <div class="font-bold text-slate-800 dark:text-slate-100">${item.name}</div>
                                    <div class="text-[10px] text-red-500">æœ¬é‡‘ $${item.balance.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-slate-700 dark:text-slate-300">-$${item.expense}</div>
                                <div class="text-[9px] text-blue-500 font-bold mt-1">è¿˜æ¸… ></div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML += `<div class="p-8 text-center text-slate-400 text-sm italic">æ— å•†ä¸šè´·æ¬¾/åè´¦ï¼Œå¹²å¾—æ¼‚äº®ï¼</div>`;
                }
                
                container.innerHTML += `
                    <div class="h-8"></div>
                    <button onclick="game.declareBankruptcy()" class="w-full py-4 bg-slate-100 dark:bg-white/5 text-slate-400 hover:text-red-500 rounded-2xl font-bold text-xs transition-colors">
                        â˜ ï¸ å®£å¸ƒç ´äº§
                    </button>
                    <div class="h-24"></div>`;
            }
        },

        openOverlay(id) {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            
            ['card-modal','choice-modal','game-over-modal','dream-modal'].forEach(i => document.getElementById(i).classList.add('hidden'));
            
            const target = document.getElementById(id);
            target.classList.remove('hidden', 'shake-anim'); 
            target.classList.add('modal-enter');
        },
        closeModal() {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.add('opacity-0'); 
            
            if (uiTimer) clearTimeout(uiTimer);
            
            uiTimer = setTimeout(() => {
                overlay.classList.add('hidden'); 
                overlay.style.display = 'none';
                overlay.classList.remove('opacity-0');
                
                // --- ä¿®æ”¹å¼€å§‹ ---
                // å¦‚æœå½“å‰ä¸æ˜¯ AI çš„å›åˆï¼Œä¸”é˜Ÿåˆ—é‡Œæ²¡æœ‰äº‹ä»¶äº†ï¼Œè¯´æ˜ç©å®¶æ“ä½œå®Œäº†ï¼Œè¯¥ AI äº†
                const wasPlayerTurn = !this.state.isAiTurn;
                this.state.currentCard = null;
                
                // å…ˆå¤„ç†é˜Ÿåˆ—ï¼ˆæ¯”å¦‚è¿ç»­å¼¹çª—ï¼‰
                if (this.state.eventQueue.length > 0) {
                    this.processQueue();
                } else if (wasPlayerTurn && !this.state.isGameOver) {
                    // åªæœ‰å½“è¿™æ˜¯ç©å®¶ä¸»åŠ¨å…³é—­ï¼Œä¸”æ²¡æœ‰åç»­äº‹ä»¶æ—¶ï¼Œæ‰è§¦å‘ AI
                    setTimeout(() => this.runAiTurn(), 500); 
                }
                // --- ä¿®æ”¹ç»“æŸ ---
                
            }, 200);
        },

        updateUI() {
            // 1. åˆ¤æ–­å½“å‰æ˜¯è°çš„å›åˆ
            const isAi = this.state.isAiTurn;
            const target = isAi ? this.state.ai : this.state;
            
            // 2. å‡†å¤‡æ•°æ® (å¦‚æœæ˜¯ AIï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›ç‰¹æ®Šè®¡ç®—é€‚é…)
            const name = isAi ? target.name : this.state.jobTitle;
            const avatar = isAi ? target.avatar : this.state.jobIcon;
            
            const cash = target.cash;
            // ç©å®¶çš„æœˆç°é‡‘æµæ˜¯å®æ—¶ç®—çš„ï¼ŒAI çš„æˆ‘ä»¬ç›´æ¥å­˜ç€
            const flow = isAi ? target.flow : this.monthlyFlow; 
            const passive = target.passive || 0;
            
            // ç©å®¶æ”¯å‡ºæ˜¯ç®—çš„ï¼ŒAI ç®€åŒ–ä¸ºä¸€ä¸ªå›ºå®šå€¼æˆ–ç´¯åŠ å€¼
            const expense = isAi ? target.expense : this.totalExpense;

            // 3. æ›´æ–°é¡¶éƒ¨é¢æ¿ DOM
            document.getElementById('game-phase-text').innerText = name;
            document.getElementById('game-phase-badge').innerText = avatar;
            
            // å¢åŠ è§†è§‰åŒºåˆ†ï¼šå¦‚æœæ˜¯ AI å›åˆï¼Œç»™é¢æ¿åŠ ä¸ªå¾®å¼±çš„çº¢è‰²èƒŒæ™¯å…‰æ™•ï¼Œæˆ–è€…ä¿æŒåŸæ ·
            const topPanel = document.getElementById('top-panel');
            if (isAi) {
                topPanel.classList.add('ring-2', 'ring-red-500', 'ring-opacity-50'); // ç»™ä¸ªçº¢åœˆæé†’
            } else {
                topPanel.classList.remove('ring-2', 'ring-red-500', 'ring-opacity-50');
            }

            // æ›´æ–°æ•°å­—æ˜¾ç¤º
            this.animChange('display-cash', cash > 0 ? 'positive' : 'negative'); // ç®€å•çš„åŠ¨ç”»è§¦å‘
            document.getElementById('display-cash').innerText = '$' + Math.floor(cash).toLocaleString();
            document.getElementById('display-flow').innerText = '$' + flow.toLocaleString();
            document.getElementById('display-passive').innerText = '$' + passive.toLocaleString();
            document.getElementById('display-expense').innerText = '$' + expense.toLocaleString();

            // 4. æ›´æ–°è¿›åº¦æ¡ (è´¢åŠ¡è‡ªç”±è¿›åº¦)
            let percent = 0;
            if (this.state.isFastTrack) {
                const targetFlow = isAi ? target.flow : this.state.ftAddedCashflow;
                percent = Math.min((targetFlow / 50000) * 100, 100);
            } else {
                // è¿›åº¦ = è¢«åŠ¨æ”¶å…¥ / æ€»æ”¯å‡º
                percent = expense > 0 ? Math.min((passive / expense) * 100, 100) : 100;
            }
            document.getElementById('progress-bar').style.width = percent + '%';
            
            // å¦‚æœæ˜¯ç©å®¶ä¸”èµ¤å­—ï¼Œæ˜¾ç¤ºè­¦å‘Šï¼›AI èµ¤å­—æˆ‘ä»¬å°±ä¸å¼¹è­¦å‘Šäº†ï¼Œå…å¾—å¹²æ‰°ç©å®¶
            if (!isAi && !this.state.isFastTrack && flow < 0 && cash < 0) {
                document.getElementById('bankrupt-warn').classList.remove('hidden');
            } else {
                document.getElementById('bankrupt-warn').classList.add('hidden');
            }

            this.renderDiceControls();
        },
        
        renderBoard() {
            const board = document.getElementById('game-board'); 
            board.innerHTML = '';
            
            const tiles = this.state.isFastTrack ? CONFIG.fastTrackTiles : CONFIG.tiles;
            
            board.style.gridTemplateColumns = "repeat(4, 1fr)";
            
            tiles.forEach((tile, idx) => {
                const div = document.createElement('div');
                let extraClass = '';
                if (this.state.isFastTrack) {
                    extraClass = 'text-[9px]'; 
                }

                div.className = `tile ${tile.color} ${extraClass}`;
                
                if (this.state.isFastTrack && tile.type === 'FT_Dream') {
                    div.innerHTML = `<div class="tile-icon text-lg">${tile.icon}</div><div class="opacity-70 scale-75 origin-center tracking-tight text-[8px]">${tile.label}</div>`;

                if (this.state.isFastTrack && tile.type === 'FT_Biz') {
                    if (this.state.fastTrackBiz[idx]) {
                        const biz = this.state.fastTrackBiz[idx];
                        div.innerHTML = `
                            <div class="tile-icon text-lg">${biz.icon}</div>
                            <div class="text-[8px] font-bold opacity-90 scale-90 tracking-tight leading-none">${biz.name}</div>
                            <div class="text-[7px] opacity-70">å·²æ‹¥æœ‰</div>
                        `;
                    }
                }

                } else {
                    div.innerHTML = `<div class="tile-icon">${tile.icon}</div><div class="opacity-70 scale-90 origin-center tracking-tight">${tile.label}</div>`;
                }
                
                                // æ¸²æŸ“ç©å®¶
                if (idx === this.state.pos) {
                    div.classList.add('active');
                    div.innerHTML += `<div class="player-token"></div>`;
                    // åªæœ‰è½®åˆ°ç©å®¶æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å… AI ç§»åŠ¨æ—¶å±å¹•ä¹±è·³
                    if (!this.state.isAiTurn) {
                        setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'center' }), 10);
                    }
                }
                // æ¸²æŸ“ AI (ä¿®å¤ï¼šåªæœ‰å½“ AI æ‰€åœ¨çš„ä¸–ç•Œä¸å½“å‰æ˜¾ç¤ºçš„åœ°å›¾ä¸€è‡´æ—¶æ‰æ¸²æŸ“)
                // å¦‚æœå½“å‰æ˜¾ç¤ºå¿«è½¦é“(state.isFastTrack)ï¼Œä½† AI æ²¡è¿›å¿«è½¦é“(ai.isFastTrack é»˜è®¤ä¸º undefined æˆ– false)ï¼Œåˆ™ä¸æ˜¾ç¤º AI
                const aiIsFast = !!this.state.ai.isFastTrack;
                const playerIsFast = !!this.state.isFastTrack;

                if (idx === this.state.ai.pos && aiIsFast === playerIsFast) {
                    div.innerHTML += `<div class="ai-token"></div>`;
                }
                
                board.appendChild(div);
            });
        },
        log(msg, important = false) {
            const el = document.getElementById('log-capsule');
            el.innerHTML = msg;
            if (important) {
                el.classList.add('scale-105', 'bg-white', 'dark:bg-white', 'text-slate-800', 'shadow-md');
            } else {
                el.classList.remove('scale-105', 'bg-white', 'dark:bg-white', 'text-slate-800', 'shadow-md');
            }
            setTimeout(() => el.classList.remove('scale-105', 'bg-white', 'dark:bg-white', 'text-slate-800', 'shadow-md'), 800);
        },
        animChange(id, type) {
            const el = document.getElementById(id);
            const color = type === 'positive' ? 'text-green-600' : 'text-red-500';
            el.classList.add(color, 'scale-110', 'transition-transform');
            setTimeout(() => el.classList.remove(color, 'scale-110'), 300);
        }
    };

    window.game = game;

    const setVh = () => {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    };
    window.addEventListener('resize', setVh);
    setVh();

    game.init();    </script>
</body>
</html>
