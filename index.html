<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cashflow: Classic Rat Race</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#000000',
                            card: '#1C1C1E',
                            overlay: 'rgba(30, 30, 30, 0.7)'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .hidden { display: none !important; }
        
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.85);
            --ios-card-dark: rgba(28, 28, 30, 0.85);
            --ios-blur: 12px;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
        }

        /* --- iPhone æ»šåŠ¨é‡æ„æ ¸å¿ƒæ ·å¼ --- */
        .ios-scroll-container {
            transform: translate3d(0,0,0);
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
            pointer-events: auto;
        }
        .ios-scroll-container::-webkit-scrollbar { display: none; }
        
        /* --- iPhone é€‚é…æ ¸å¿ƒä¿®å¤ --- */
        .pt-safe-top {
            padding-top: 20px; 
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }
        .pb-safe-bottom {
            padding-bottom: 20px; 
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg: #000000;
                --ios-card: rgba(28, 28, 30, 0.8); 
                --ios-card-dark: rgba(28, 28, 30, 0.9);
                --shadow-sm: 0 2px 8px rgba(0,0,0,0.5);
                --shadow-lg: 0 12px 32px rgba(0,0,0,0.6);
            }
            .tile { background: #1C1C1E !important; border: 1px solid #2c2c2e; }
            .tile-pay { background: #3f2c00 !important; color: #fbbf24 !important; border-color: #78350f !important; }
            .tile-opp { background: #064e3b !important; color: #4ade80 !important; border-color: #065f46 !important; }
            .tile-market { background: #172554 !important; color: #60a5fa !important; border-color: #1e3a8a !important; }
            .tile-doodad { background: #450a0a !important; color: #f87171 !important; border-color: #7f1d1d !important; }
            .tile-baby { background: #500724 !important; color: #f472b6 !important; border-color: #831843 !important; }
            .tile-charity { background: #431407 !important; color: #fb923c !important; border-color: #7c2d12 !important; }
            .tile-down { background: #3b0764 !important; color: #c084fc !important; border-color: #581c87 !important; }
        }

        body { 
            background-color: var(--ios-bg); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            color: #1c1c1e;
            overflow: hidden; 
        }

        .hardware-accel {
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            perspective: 1000px;
        }

        .glass { 
            background: var(--ios-card); 
            backdrop-filter: blur(var(--ios-blur)); 
            -webkit-backdrop-filter: blur(var(--ios-blur)); 
            border: 1px solid rgba(255, 255, 255, 0.4); 
        }

        @media (prefers-color-scheme: dark) {
            .glass { border: 1px solid rgba(255, 255, 255, 0.1); }
        }
        
        .glass-dark {
            background: var(--ios-card-dark);
            backdrop-filter: blur(var(--ios-blur));
            -webkit-backdrop-filter: blur(var(--ios-blur));
            color: white;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes popUp { 
            0% { transform: scale(0.95) translateY(10px); opacity: 0; } 
            100% { transform: scale(1) translateY(0); opacity: 1; } 
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px); }
            40% { transform: translateX(6px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }
        .modal-enter { 
            animation: popUp 0.3s cubic-bezier(0.19, 1, 0.22, 1) forwards; 
            will-change: transform, opacity; 
        }
        .shake-anim { animation: shake 0.4s ease-in-out; }
        
        .tap-effect { transition: transform 0.1s, opacity 0.1s; cursor: pointer; touch-action: manipulation; }
        .tap-effect:active { transform: scale(0.97); opacity: 0.8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #board-container { -webkit-overflow-scrolling: touch; }

        #game-board { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            padding: 0 12px; max-width: 600px; margin: 0 auto;
        }
        .tile {
            aspect-ratio: 1; border-radius: 14px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 10px; font-weight: 700;
            color: #1c1c1e; background: white; box-shadow: var(--shadow-sm);
            position: relative; text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            will-change: transform; 
        }
        .tile-icon { font-size: 22px; margin-bottom: 2px; }
        .tile.active {
            transform: scale(1.05); box-shadow: 0 0 0 3px var(--ios-blue), var(--shadow-lg); z-index: 10;
        }

        .tile-pay { background: #FFF9C4; color: #F57F17; }
        .tile-opp { background: #DCFCE7; color: #15803d; }
        .tile-market { background: #DBEAFE; color: #1d4ed8; }
        .tile-doodad { background: #FEE2E2; color: #b91c1c; }
        .tile-baby { background: #FCE7F3; color: #be185d; }
        .tile-charity { background: #FFEDD5; color: #c2410c; }
        .tile-down { background: #F3E8FF; color: #7e22ce; }

        .player-token {
            position: absolute; width: 14px; height: 14px; background: var(--ios-blue);
            border: 2px solid white; border-radius: 50%; top: -4px; right: -4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 20;
            transition: all 0.2s ease;
        }

        .ios-segment { background: rgba(118, 118, 128, 0.24); border-radius: 9px; padding: 2px; display: flex; }
        .segment-btn {
            flex: 1; text-align: center; font-size: 13px; font-weight: 500;
            padding: 6px 0; border-radius: 7px; color: rgba(255,255,255,0.6); transition: all 0.2s;
        }
        .segment-btn.active { background: #636366; color: white; box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        
        .stepper-btn {
            width: 36px; height: 36px; border-radius: 10px; background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 600; color: var(--ios-blue);
        }
        @media (prefers-color-scheme: dark) {
            .stepper-btn { background: #2c2c2e; color: #60a5fa; box-shadow: none; border: 1px solid #3a3a3c; }
        }

        .loan-panel {
            background: rgba(255,59,48, 0.15); border: 1px solid rgba(255,59,48, 0.2);
            border-radius: 16px; padding: 16px; margin-bottom: 16px;
        }
        .debt-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;
            margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05);
        }

        #input-qty-field {
            background: transparent; font-size: 1.6rem; font-weight: 700; text-align: center;
            width: 100px; color: #1e293b; outline: none; border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }
        @media (prefers-color-scheme: dark) { #input-qty-field { color: white; } }
        #input-qty-field:focus { border-bottom-color: var(--ios-blue); }
        
        #modal-overlay { 
            z-index: 60 !important; 
            background-color: rgba(0, 0, 0, 0.4); 
            backdrop-filter: none !important;
        } 
        @media (prefers-color-scheme: dark) {
            #modal-overlay { background-color: rgba(0, 0, 0, 0.65); }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-slate-800 dark:text-slate-200 hardware-accel">

    <div class="z-20 pt-safe-top">
        <div class="px-4 py-2">
            <div id="top-panel" class="glass rounded-[28px] p-5 shadow-sm transition-all duration-300 hardware-accel">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <div id="game-phase-badge" class="w-8 h-8 rounded-full bg-slate-900 dark:bg-white dark:text-black flex items-center justify-center text-white font-bold text-lg shadow-md">ğŸ‘·</div>
                        <span id="game-phase-text" class="font-bold text-lg tracking-tight text-slate-800 dark:text-white">èŒä¸š</span>
                        </div>
                    <button onclick="game.toggleSheet()" class="tap-effect px-3 py-1.5 bg-white/60 dark:bg-white/10 backdrop-blur rounded-full text-xs font-semibold text-slate-600 dark:text-slate-300 flex items-center gap-1 border border-white/40 dark:border-white/10 shadow-sm">
                        ğŸ“Š èµ„äº§ & è´Ÿå€º
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/70 dark:bg-white/10 p-3.5 rounded-2xl border border-white/50 dark:border-white/5 shadow-sm">
                        <div class="text-[10px] text-slate-400 dark:text-slate-400 font-bold uppercase tracking-wide">æ‰‹å¤´ç°é‡‘</div>
                        <div class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight" id="display-cash">$0</div>
                    </div>
                    <div class="bg-blue-50/90 dark:bg-blue-900/20 p-3.5 rounded-2xl border border-blue-100 dark:border-blue-800/50 relative overflow-hidden shadow-sm">
                        <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wide">æœˆç°é‡‘æµ</div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 tracking-tight" id="display-flow">$0</div>
                        <div id="bankrupt-warn" class="absolute inset-0 bg-red-100/95 flex items-center justify-center text-red-600 font-bold text-xs hidden animate-pulse">âš ï¸ èµ¤å­—è­¦æŠ¥</div>
                    </div>
                </div>

                <div class="mt-4 px-1">
                    <div class="flex justify-between text-[11px] text-slate-400 dark:text-slate-500 mb-1.5 font-medium">
                        <span>è¢«åŠ¨æ”¶å…¥: <strong id="display-passive" class="text-slate-600 dark:text-slate-300">$0</strong></span>
                        <span>æ€»æ”¯å‡º: <strong id="display-expense" class="text-slate-600 dark:text-slate-300">$0</strong></span>
                    </div>
                    <div class="h-2.5 w-full bg-slate-200/60 dark:bg-white/10 rounded-full overflow-hidden relative">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-green-400 to-emerald-500 w-0 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(52,199,89,0.3)]"></div>
                    </div>
                    <div class="mt-3 mb-2 flex justify-center"> <div id="log-capsule" class="bg-slate-100/90 dark:bg-[#2c2c2e]/90 backdrop-blur-md px-4 py-1.5 rounded-full text-[11px] font-medium text-slate-500 dark:text-slate-400 max-w-[90%] truncate transition-all border border-white/50 dark:border-white/5 shadow-sm">
                            æ¬¢è¿æ¥åˆ°ç°é‡‘æµæ¸¸æˆ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar py-2" id="board-container">
        <div id="game-board"></div>
        <div class="h-44"></div> 
    </div>

    <div class="fixed bottom-0 w-full glass rounded-t-[36px] shadow-[0_-8px_40px_rgba(0,0,0,0.08)] z-30 pb-safe-bottom hardware-accel">
        <div class="p-5 pb-2"> <div id="dice-controls" class="flex gap-3 h-14">
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 hidden flex items-end sm:items-center justify-center transition-opacity duration-300">
        
        <div id="card-modal" class="glass w-full sm:w-[380px] sm:rounded-[36px] rounded-t-[36px] p-6 shadow-2xl hidden relative pb-safe-bottom hardware-accel">
            
            <div class="absolute top-6 left-6 px-3 py-1.5 bg-green-100 dark:bg-green-900/40 rounded-full text-[11px] font-bold text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800/30 flex items-center gap-1 z-10 shadow-sm">
                ğŸ¦ <span id="modal-cash-display" class="text-red-600 dark:text-red-400">$0</span>
            </div>

            <button onclick="game.quickLoan()" class="absolute top-6 right-6 px-3 py-1.5 bg-slate-100 dark:bg-[#2c2c2e] hover:bg-slate-200 dark:hover:bg-[#3a3a3c] rounded-full text-[11px] font-bold text-slate-500 dark:text-slate-400 tap-effect flex items-center gap-1 z-10 border border-slate-200 dark:border-white/5 shadow-sm">
                ğŸ¦ å€Ÿ/è¿˜
            </button>

            <div class="flex justify-center -mt-16 mb-4">
                <div id="card-icon-bg" class="bg-white dark:bg-[#2c2c2e] p-4 rounded-2xl shadow-[0_8px_24px_rgba(0,0,0,0.08)] text-4xl border border-slate-50 dark:border-white/5">ğŸ </div>
            </div>
            
            <div class="text-center mb-6">
                <div id="card-tag" class="inline-block px-2.5 py-0.5 bg-slate-100 dark:bg-white/10 text-slate-400 dark:text-slate-400 text-[10px] font-bold rounded-md mb-2 uppercase tracking-wider">Type</div>
                <h2 id="card-title" class="text-2xl font-bold text-slate-800 dark:text-white leading-tight">Title</h2>
                <div id="card-desc" class="text-slate-500 dark:text-slate-400 text-sm mt-3 leading-relaxed px-2">Description.</div>
            </div>

            <div id="input-area" class="mb-6 hidden">
                 <div class="flex items-center justify-between bg-slate-50 dark:bg-[#2c2c2e] rounded-2xl p-3 border border-slate-100 dark:border-white/5">
                    <button onclick="game.adjustShares(-100)" class="stepper-btn text-slate-400">-</button>
                    <div class="text-center min-w-[80px]">
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-0.5">æ•°é‡ (æ‰‹/è‚¡)</div>
                        <input type="number" id="input-qty-field" value="100" step="10" oninput="game.manualInputShares(this.value)">
                    </div>
                    <button onclick="game.adjustShares(100)" class="stepper-btn text-blue-600">+</button>
                 </div>
                 <div class="flex justify-between items-center px-4 mt-2">
                     <span class="text-xs text-slate-400 font-medium">å•ä»·: <span id="input-price-per">$0</span></span>
                     <span class="text-xs text-slate-500 dark:text-slate-300 font-bold">æ€»è®¡: <span id="input-total" class="text-slate-800 dark:text-white">$0</span></span>
                 </div>
            </div>

            <div id="card-financials" class="bg-slate-50/80 dark:bg-[#2c2c2e] rounded-2xl p-4 mb-6 space-y-2.5 text-sm hidden border border-slate-100 dark:border-white/5">
                <div class="flex justify-between items-center"><span class="text-slate-400 font-medium" id="lbl-cost">æˆæœ¬</span><span class="font-bold text-slate-700 dark:text-slate-200" id="val-cost">$0</span></div>
                <div class="flex justify-between items-center"><span class="text-slate-400 font-medium" id="lbl-down">é¦–ä»˜</span><span class="font-bold text-blue-600 dark:text-blue-400" id="val-down">$0</span></div>
                <div class="w-full h-px bg-slate-200 dark:bg-white/10 my-1"></div>
                <div class="flex justify-between items-center"><span class="text-slate-400 font-medium">æœˆç°é‡‘æµ</span><span class="font-bold text-green-600 dark:text-green-400" id="val-flow">+$0</span></div>
            </div>

            <div class="flex gap-3 mb-4"> <button id="btn-cancel" onclick="game.closeModal()" class="flex-1 py-3.5 bg-slate-100 dark:bg-[#2c2c2e] hover:bg-slate-200 dark:hover:bg-[#3a3a3c] text-slate-500 dark:text-slate-400 rounded-2xl font-bold tap-effect text-sm transition-colors">æ”¾å¼ƒ</button>
                <button onclick="game.confirmCardAction('SHORT')" id="btn-short-action" class="hidden flex-1 py-3.5 bg-red-50 dark:bg-red-900/20 text-red-500 border border-red-100 dark:border-red-900/30 rounded-2xl font-bold tap-effect text-sm">åšç©º</button>
                <button onclick="game.confirmCardAction('BUY')" id="btn-card-action" class="flex-[1.5] py-3.5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 dark:shadow-none tap-effect text-sm transition-colors">æ‰§è¡Œ</button>
            </div>
        </div>

        <div id="choice-modal" class="glass w-full sm:w-[360px] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl hidden pb-safe-bottom dark:border dark:border-white/10 hardware-accel">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2 text-center">é€‰æ‹©æŠ•èµ„èµ›é“</h3>
            <p class="text-xs text-slate-400 text-center mb-6 px-4">å°ç”Ÿæ„èµ·æ­¥å¿«ä½†é£é™©é«˜ï¼Œå¤§ç”Ÿæ„ç¨³å®šä½†é—¨æ§›é«˜ã€‚</p>
            
            <div class="space-y-3">
                <button onclick="game.chooseDeal('Small')" class="w-full p-4 rounded-2xl border bg-white/50 dark:bg-[#2c2c2e]/50 border-slate-100 dark:border-white/5 hover:border-blue-200 active:bg-blue-50 dark:active:bg-white/5 flex items-center justify-between tap-effect transition-all shadow-sm group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span class="text-2xl group-active:scale-110 transition-transform">ğŸ“‰</span> åˆçº§å¸‚åœº</div>
                        <div class="text-xs text-slate-400 mt-1">è‚¡ç¥¨ Â· åŸºé‡‘ Â· å°æˆ¿äº§ (æˆæœ¬ $5kå†…)</div>
                    </div>
                    <div class="text-blue-500 text-sm font-bold">å…¥é—¨ ></div>
                </button>
                <button onclick="game.chooseDeal('Big')" class="w-full p-4 rounded-2xl border bg-white/50 dark:bg-[#2c2c2e]/50 border-slate-100 dark:border-white/5 hover:border-purple-200 active:bg-purple-50 dark:active:bg-white/5 flex items-center justify-between tap-effect transition-all shadow-sm group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span class="text-2xl group-active:scale-110 transition-transform">ğŸ¢</span> å¤§ç”Ÿæ„</div>
                        <div class="text-xs text-slate-400 mt-1">å…¬å¯“ Â· ä¼ä¸šæ”¶è´­ (æˆæœ¬ $6k+)</div>
                    </div>
                    <div class="text-purple-500 text-sm font-bold">è¿›é˜¶ ></div>
                </button>
            </div>
            <button onclick="game.closeModal()" class="w-full mt-6 py-2 mb-2 text-slate-400 text-xs font-semibold">è·³è¿‡æ­¤å›åˆ</button>
        </div>

        <!-- æ¢¦æƒ³é€‰æ‹©å¼¹çª—ï¼šä¿®å¤åº•éƒ¨å¯¹é½é—®é¢˜ -->
        <div id="dream-modal" class="glass fixed left-0 right-0 bottom-0 mx-auto w-full sm:w-[360px] sm:rounded-[32px] rounded-t-[32px] shadow-2xl hidden flex flex-col z-50 h-[75dvh] transition-transform duration-300">
    
            <div class="flex-shrink-0 px-6 pt-6 pb-2 z-10 bg-inherit rounded-t-[32px] relative border-b border-black/5 dark:border-white/5">
                <div class="w-12 h-1.5 bg-slate-200 dark:bg-white/20 rounded-full mx-auto mb-3"></div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white text-center">é€‰æ‹©ä½ çš„æ¢¦æƒ³</h3>
                <p class="text-xs text-slate-400 text-center mt-1">è¿™æ˜¯ä½ è¿›å…¥å¿«è½¦é“åçš„ç»ˆæç›®æ ‡ã€‚</p>
            </div>

            <div class="relative flex-1 min-h-0 w-full">
                <!-- åˆ—è¡¨å®¹å™¨ï¼špb-safe-bottom åŠ åœ¨è¿™é‡Œ -->
                <div id="dream-list" class="ios-scroll-container absolute inset-0 px-6 py-4 space-y-3 pb-safe-bottom">
                    <!-- JS ç”Ÿæˆå†…å®¹ -->
                    <div class="h-20"></div> <!-- åº•éƒ¨é¢å¤–å«é«˜ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ -->
                </div>
                
                <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-white/90 dark:from-[#1c1c1e] to-transparent pointer-events-none rounded-b-[32px]"></div>
            </div>
        </div>
        
        <div id="game-over-modal" class="glass w-[90%] sm:w-[360px] rounded-[32px] p-8 shadow-2xl hidden flex-col items-center text-center dark:border dark:border-white/10 hardware-accel pb-safe-bottom">
            <div class="text-6xl mb-4" id="end-icon">â˜ ï¸</div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2" id="end-title">æ¸¸æˆç»“æŸ</h2>
            <p class="text-slate-500 text-sm mb-6" id="end-desc">æè¿°</p>
            <button onclick="location.reload()" class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-black rounded-2xl font-bold shadow-lg shadow-slate-300 dark:shadow-none tap-effect mb-4">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <div id="sheet-modal" class="fixed inset-0 z-[70] hidden flex-col justify-end">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-[2px]" onclick="game.toggleSheet()"></div>
        <div class="glass-dark w-full h-[92dvh] rounded-t-[32px] p-6 relative flex flex-col modal-enter shadow-[0_-10px_40px_rgba(0,0,0,0.5)]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white tracking-tight">è´¢åŠ¡æŠ¥è¡¨</h2>
                <button onclick="game.toggleSheet()" class="w-8 h-8 rounded-full bg-white/10 text-white flex items-center justify-center tap-effect hover:bg-white/20">âœ•</button>
            </div>

            <div class="ios-segment mb-6">
                <div class="segment-btn active" onclick="game.switchTab('paper', this)">æŠ•èµ„ç»„åˆ</div>
                <div class="segment-btn" onclick="game.switchTab('debt', this)">è´Ÿå€ºç®¡ç†</div>
            </div>

            <div id="panel-invest" class="flex-1 overflow-y-auto space-y-3 pb-safe-bottom">
                 <div id="sheet-content"></div>
                 <div class="h-10"></div>
            </div>

            <div id="panel-debt" class="flex-1 overflow-y-auto hidden space-y-4 pb-safe-bottom">
                <div class="loan-panel flex justify-between items-center text-white mb-2">
                    <div>
                        <div class="text-[10px] text-red-300 font-bold uppercase">é“¶è¡Œæ€¥ç”¨è´· (10%æœˆæ¯)</div>
                        <div class="text-xl font-bold" id="sheet-loan">$0</div>
                        <div class="text-[10px] opacity-60">æœˆåˆ©æ¯æ”¯å‡º: <span id="sheet-interest">$0</span></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="game.manageLoan(-1000)" class="px-3 py-1.5 bg-white/10 rounded-lg text-xs font-bold active:bg-white/20 border border-white/5">è¿˜æ¬¾</button>
                        <button onclick="game.manageLoan(1000)" class="px-3 py-1.5 bg-red-500 rounded-lg text-xs font-bold active:bg-red600 shadow-md shadow-red-900/30">å€Ÿæ¬¾</button>
                    </div>
                </div>

                <div class="text-[11px] text-white/40 uppercase font-bold px-1">ç”Ÿæ´»è´Ÿå€º (è¿˜æ¸…ä»¥å‡å°‘æ”¯å‡º)</div>
                <div id="liabilities-list" class="space-y-2"></div>
                <div class="h-10"></div>
            </div>
            
            <div class="pt-4 pb-safe-bottom border-t border-white/10 flex justify-between text-xs text-white/40 font-medium">
                <span>å·¥èµ„: $<span id="sheet-salary">0</span></span>
                <span>å­©å­: <span id="sheet-kids" class="text-white">0</span> (æ”¯å‡º $<span id="sheet-kid-cost">0</span>)</span>
            </div>
        </div>
    </div>

    <script>
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const CONFIG = {
        basicLivingExpense: 0,
        dreams: [
            { id: 'island', name: 'ç§äººå²›å±¿', cost: 200000, icon: 'ğŸï¸', desc: 'åœ¨å¤ªå¹³æ´‹æ‹¥æœ‰å±äºè‡ªå·±çš„åº¦å‡å¤©å ‚ã€‚' },
            { id: 'mayor', name: 'ç«é€‰å¸‚é•¿', cost: 150000, icon: 'ğŸ›ï¸', desc: 'æŠ•èº«å…¬å…±æœåŠ¡ï¼Œç®¡ç†æ•´ä¸ªåŸå¸‚ã€‚' },
            { id: 'park', name: 'å† åå…¬å›­', cost: 100000, icon: 'ğŸŒ³', desc: 'ä¸ºç¤¾åŒºæèµ ä¸€åº§ä»¥ä½ åå­—å‘½åçš„å…¬å›­ã€‚' },
            { id: 'library', name: 'æèµ å›¾ä¹¦é¦†', cost: 80000, icon: 'ğŸ“š', desc: 'ä¸ºå­©å­ä»¬å»ºç«‹ä¸€åº§ç°ä»£åŒ–çš„å›¾ä¹¦é¦†ã€‚' },
            { id: 'jet', name: 'ç§äººå–·æ°”æœº', cost: 250000, icon: 'âœˆï¸', desc: 'æ¹¾æµ G650ï¼Œéšæ—¶éšåœ°èµ·é£ã€‚' },
            { id: 'golf', name: 'ä¸–ç•Œé«˜å°”å¤«', cost: 120000, icon: 'â›³', desc: 'æ‰“éä¸–ç•Œä¸Šæœ€é¡¶çº§çš„100ä¸ªçƒåœºã€‚' },
            { id: 'yacht', name: 'è±ªåæ¸¸è‰‡', cost: 300000, icon: 'ğŸ›¥ï¸', desc: 'åœ¨åœ°ä¸­æµ·æ‹¥æœ‰è¿™è‰˜åä¸ºâ€œè‡ªç”±å·â€çš„å·¨è½®ã€‚' },
            { id: 'school', name: 'å¸Œæœ›å°å­¦', cost: 500000, icon: 'ğŸ«', desc: 'å»ºç«‹ä¸€æ‰€å…¨å…è´¹çš„ç²¾è‹±å­¦æ ¡ã€‚' }
        ],
        professions: [
            {
                name: 'ä¿å®‰', icon: 'ğŸ§¹', salary: 1600, savings: 1600, perChild: 70,
                debts: { mortgage: 20000, car: 4000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 280, mortgage: 200, car: 60, credit: 60, retail: 50, loan: 0, other: 300 }
            },
            {
                name: 'å¡è½¦å¸æœº', icon: 'ğŸš›', salary: 2500, savings: 2500, perChild: 140,
                debts: { mortgage: 31000, car: 4000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 460, mortgage: 400, car: 80, credit: 60, retail: 50, loan: 0, other: 570 }
            },
            {
                name: 'æœºæ¢°å¸ˆ', icon: 'ğŸ”§', salary: 2000, savings: 2000, perChild: 110,
                debts: { mortgage: 31000, car: 3000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 360, mortgage: 300, car: 60, credit: 60, retail: 50, loan: 0, other: 450 }
            },
            {
                name: 'æ•™å¸ˆ', icon: 'ğŸ‘¨â€ğŸ«', salary: 3300, savings: 3300, perChild: 180,
                debts: { mortgage: 50000, car: 5000, credit: 3000, retail: 1000, loan: 12000 },
                expenses: { tax: 630, mortgage: 500, car: 100, credit: 90, retail: 50, loan: 60, other: 760 }
            },
            {
                name: 'æŠ¤å£«', icon: 'ğŸ’‰', salary: 3100, savings: 3100, perChild: 170,
                debts: { mortgage: 47000, car: 5000, credit: 3000, retail: 1000, loan: 6000 },
                expenses: { tax: 600, mortgage: 400, car: 100, credit: 90, retail: 50, loan: 30, other: 710 }
            },
            {
                name: 'ç§˜ä¹¦', icon: 'ğŸ“', salary: 2500, savings: 2500, perChild: 140,
                debts: { mortgage: 38000, car: 4000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 460, mortgage: 400, car: 80, credit: 60, retail: 50, loan: 0, other: 570 }
            },
            {
                name: 'è­¦å®˜', icon: 'ğŸ‘®', salary: 3000, savings: 3000, perChild: 160,
                debts: { mortgage: 46000, car: 5000, credit: 2000, retail: 1000, loan: 0 },
                expenses: { tax: 580, mortgage: 400, car: 100, credit: 60, retail: 50, loan: 0, other: 690 }
            },
            {
                name: 'ç»ç†', icon: 'ğŸ‘”', salary: 4600, savings: 4600, perChild: 240,
                debts: { mortgage: 75000, car: 6000, credit: 4000, retail: 1000, loan: 12000 },
                expenses: { tax: 910, mortgage: 700, car: 120, credit: 120, retail: 50, loan: 60, other: 1000 }
            },
            {
                name: 'å·¥ç¨‹å¸ˆ', icon: 'ğŸ“', salary: 4900, savings: 4900, perChild: 250,
                debts: { mortgage: 75000, car: 7000, credit: 5000, retail: 1000, loan: 12000 },
                expenses: { tax: 1050, mortgage: 700, car: 140, credit: 150, retail: 50, loan: 60, other: 1090 }
            },
            {
                name: 'åŒ»ç”Ÿ', icon: 'ğŸ‘¨â€âš•ï¸', salary: 13200, savings: 13200, perChild: 640,
                debts: { mortgage: 202000, car: 19000, credit: 9000, retail: 1000, loan: 150000 },
                expenses: { tax: 3420, mortgage: 1900, car: 380, credit: 270, retail: 50, loan: 750, other: 2880 }
            },
            {
                name: 'å¾‹å¸ˆ', icon: 'âš–ï¸', salary: 7500, savings: 7500, perChild: 380,
                debts: { mortgage: 115000, car: 11000, credit: 6000, retail: 1000, loan: 78000 },
                expenses: { tax: 1830, mortgage: 1100, car: 220, credit: 180, retail: 50, loan: 390, other: 1650 }
            },
            {
                name: 'é£è¡Œå‘˜', icon: 'ğŸ§‘â€âœˆï¸', salary: 9500, savings: 9500, perChild: 480,
                debts: { mortgage: 143000, car: 15000, credit: 22000, retail: 1000, loan: 0 },
                expenses: { tax: 2350, mortgage: 1330, car: 300, credit: 660, retail: 50, loan: 0, other: 2210 }
            }
        ],
        tiles: [
            { type: 'Pay', label: 'ç»“ç®—æ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Market', label: 'å¸‚åœº', color: 'tile-market', icon: 'ğŸ“ˆ' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Doodad', label: 'é¢å¤–æ”¯å‡º', color: 'tile-doodad', icon: 'ğŸ’¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' }, 
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Pay', label: 'ç»“ç®—æ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Market', label: 'å¸‚åœº', color: 'tile-market', icon: 'ğŸ“‰' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Doodad', label: 'é¢å¤–æ”¯å‡º', color: 'tile-doodad', icon: 'ğŸ’¸' },
            { type: 'Downsized', label: 'å¤±ä¸š', color: 'tile-down', icon: 'ğŸ›‹ï¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Pay', label: 'ç»“ç®—æ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Market', label: 'å¸‚åœº', color: 'tile-market', icon: 'ğŸ“ˆ' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Doodad', label: 'é¢å¤–æ”¯å‡º', color: 'tile-doodad', icon: 'ğŸ’¸' },
            { type: 'Baby', label: 'ç”Ÿå­©å­', color: 'tile-baby', icon: 'ğŸ‘¶' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
            { type: 'Opp', label: 'æœºä¼š', color: 'tile-opp', icon: 'âš¡ï¸' },
        ],
        fastTrackTiles: [
            // ç¬¬ä¸€ç»„ 12
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¢' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ’–' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ­' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¥' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸï¸' },
            { type: 'FT_Hazard', label: 'ç¨åŠ¡å®¡è®¡', color: 'tile-doodad', icon: 'ğŸ‘®', effect: 'audit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¬' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸš¤' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¬' },
            // ç¬¬äºŒç»„ 12
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ°' },
            { type: 'FT_Hazard', label: 'ç¦»å©š', color: 'tile-down', icon: 'ğŸ’”', effect: 'divorce' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ•' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ—¿' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'â›ï¸' },
            { type: 'FT_Hazard', label: 'å®˜å¸', color: 'tile-doodad', icon: 'âš–ï¸', effect: 'lawsuit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ§ª' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ¢' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¦' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸŸï¸' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ“¡' },
            // ç¬¬ä¸‰ç»„ 12
            { type: 'FT_Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸš›' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ¦' },
            { type: 'FT_Hazard', label: 'ç¨åŠ¡å®¡è®¡', color: 'tile-doodad', icon: 'ğŸ‘®', effect: 'audit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ«' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸš' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ§¬' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸª' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Hazard', label: 'ç¦»å©š', color: 'tile-down', icon: 'ğŸ’”', effect: 'divorce' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ”Œ' },
            // ç¬¬å››ç»„ 12
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸ°' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¯' },
            { type: 'FT_Hazard', label: 'å®˜å¸', color: 'tile-doodad', icon: 'âš–ï¸', effect: 'lawsuit' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸš„' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'â›²' },
            { type: 'FT_Pay', label: 'ç°é‡‘æµæ—¥', color: 'tile-pay', icon: 'ğŸ’°' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ›ï¸' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'ğŸï¸' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¥¦' },
            { type: 'FT_Charity', label: 'æ…ˆå–„', color: 'tile-charity', icon: 'ğŸ’œ' },
            { type: 'FT_Biz', label: 'æŠ•èµ„', color: 'tile-opp', icon: 'ğŸ¤–' },
            { type: 'FT_Dream', label: 'æ¢¦æƒ³', color: 'tile-baby', icon: 'â›·ï¸' },
        ],

        smallDeals: [
            { name: 'MYT4U ç”µå­', symbol:'MYT4U', type: 'Stock', cost: 10, range: '$5-$30', desc: 'è‚¡ä»· $10ã€‚é•¿æœŸåœ¨$5åˆ°$30ä¹‹é—´æ³¢åŠ¨ã€‚', icon: 'ğŸ“‰', allowShort: false },
            { name: 'OK4U åŒ»è¯', symbol:'OK4U', type: 'Stock', cost: 40, range: '$5-$40', desc: 'è‚¡ä»· $40ï¼Œå¤„äºå†å²é«˜ä½ã€‚', icon: 'â›°ï¸', allowShort: false },
            { name: 'ON2U å¨±ä¹', symbol:'ON2U', type: 'Stock', cost: 5, range: '$5-$40', desc: 'ä¾¿å£«è‚¡ç¥¨ï¼ä»·æ ¼ä»…ä¸º $5ï¼Œé£é™©ä½ï¼Œå›æŠ¥å¯èƒ½æé«˜ã€‚', icon: 'ğŸš€', allowShort: false },
            { name: 'ä¼˜å…ˆè‚¡åˆ†çº¢', type: 'Asset', cost: 1200, down: 1200, flow: 10, desc: 'ç”µåŠ›å…¬å¸ä¼˜å…ˆè‚¡ï¼Œæä¾›ç¨³å®šçš„10%å¹´åŒ–å›æŠ¥ã€‚', icon: 'ğŸ“œ' },
            { name: 'é“¶è¡Œå®šæœŸå­˜å•', type: 'Asset', cost: 3000, down: 3000, flow: 15, desc: 'ä½é£é™©CDå­˜å•ã€‚', icon: 'ğŸ¦' },
            { name: '2å®¤1å… å…¬å¯“', type: 'RealEstate', cost: 45000, down: 4000, flow: 180, desc: 'æ³•æ‹å±‹ã€‚é¦–ä»˜ä»…éœ€$4000ï¼ŒROIé«˜è¾¾54%ï¼', icon: 'ğŸ ' },
            { name: '3å®¤2å… æ¡æ¼', type: 'RealEstate', cost: 65000, down: 5000, flow: 190, desc: 'å±‹ä¸»æ€¥å”®ã€‚åªéœ€ $5,000 é¦–ä»˜ã€‚ç°é‡‘æµ +$190ã€‚', icon: 'ğŸšï¸' },
            { name: 'é‡‘å¸æ”¶è—', type: 'Asset', cost: 500, down: 500, flow: 0, desc: 'å…‹é²æ ¼é‡‘å¸ã€‚å¯¹æŠ—é€šèƒ€çš„ç¡¬é€šè´§ï¼Œæ— ç°é‡‘æµã€‚', icon: 'ğŸª™' }
        ],
        bigDeals: [
            { name: '3å®¤2å… è±ªå®…', type: 'RealEstate', cost: 125000, down: 25000, flow: 400, desc: 'åœ°æ®µä¼˜è¶Šã€‚ä¸é”™çš„ç°é‡‘æµèµ„äº§ï¼Œå¢å€¼ç©ºé—´å¤§ã€‚', icon: 'ğŸ¡' },
            { name: '4å•å…ƒ å…¬å¯“', type: 'RealEstate', cost: 160000, down: 32000, flow: 800, desc: '4-Plex å°å‹å…¬å¯“æ¥¼ã€‚ç°é‡‘æµéå¸¸å¥åº·ã€‚', icon: 'ğŸ˜ï¸' },
            { name: '8å•å…ƒ å…¬å¯“', type: 'RealEstate', cost: 320000, down: 60000, flow: 2400, desc: '8-Plexã€‚ç®¡ç†æˆæœ¬ä½ï¼Œæ”¶ç›Šé«˜ã€‚', icon: 'ğŸ¢' },
            { name: 'æ´—è½¦æˆ¿', type: 'Business', cost: 150000, down: 30000, flow: 1000, desc: 'å…¨è‡ªåŠ¨æ´—è½¦ç”Ÿæ„ã€‚éœ€è¦è¾ƒå¤šé¦–ä»˜ã€‚', icon: 'ğŸš—' },
            { name: 'è½¯ä»¶å…¬å¸ IPO', type: 'Business', cost: 50000, down: 50000, flow: 0, desc: 'ç§å‹Ÿè‚¡æƒã€‚é«˜é£é™©é«˜å›æŠ¥ï¼Œä¸Šå¸‚åå¯èƒ½ç¿»10å€ã€‚', icon: 'ğŸ’»' }
        ],
        fastTrackDeals: [
            { name: 'ç”Ÿç‰©ç§‘æŠ€å…¬å¸', cost: 200000, flow: 10000, icon: 'ğŸ§¬', desc: 'æ²»æ„ˆç½•è§ç—…ï¼Œå¸‚åœºæ½œåŠ›å·¨å¤§ã€‚' },
            { name: 'ç‚¸é¸¡è¿é”åº—', cost: 150000, flow: 9000, icon: 'ğŸ—', desc: 'å…¨çƒç‰¹è®¸ç»è¥æ‰©å¼ è®¡åˆ’ã€‚' },
            { name: 'AI ç ”å‘ä¸­å¿ƒ', cost: 250000, flow: 12000, icon: 'ğŸ’»', desc: 'å¼€å‘ä¸‹ä¸€ä»£äººå·¥æ™ºèƒ½é€šç”¨æ¨¡å‹ã€‚' },
            { name: 'å¸‚ä¸­å¿ƒè´­ç‰©å¹¿åœº', cost: 300000, flow: 15000, icon: 'ğŸ¬', desc: 'ä½äºCBDçš„é»„é‡‘åœ°æ®µã€‚' },
            { name: 'éæ´²é‡‘çŸ¿', cost: 500000, flow: 25000, icon: 'â›ï¸', desc: 'å‹˜æ¢é˜Ÿå‘ç°äº†å·¨å¤§çš„çŸ¿è„‰ã€‚' },
            { name: 'å¥½è±ååˆ¶ç‰‡å‚', cost: 600000, flow: 30000, icon: 'ğŸ¬', desc: 'ç”Ÿäº§å…¨çƒå‘è¡Œçš„è¶…çº§å¤§ç‰‡ã€‚' },
            { name: 'ç§äººå¤ªç©ºæ¢ç´¢', cost: 1000000, flow: 50000, icon: 'ğŸš€', desc: 'ç«æ˜Ÿæ®–æ°‘è®¡åˆ’å‰å“¨ç«™ã€‚' }
        ],
        marketCards: [
            { type: 'PriceChange', symbol: 'MYT4U', price: 30, desc: 'MYT4U å¸‚åœºç«çƒ­ï¼è‚¡ä»·æ¶¨è‡³ $30ã€‚' },
            { type: 'PriceChange', symbol: 'MYT4U', price: 5, desc: 'MYT4U å¸‚åœºå´©ç›˜ï¼è‚¡ä»·è·Œè‡³ $5ã€‚' }, 
            { type: 'PriceChange', symbol: 'ON2U', price: 40, desc: 'ON2U ç”µå½±ç¥¨æˆ¿å¤§å–ï¼è‚¡ä»·é£™å‡è‡³ $40ã€‚' },
            { type: 'PriceChange', symbol: 'OK4U', price: 50, desc: 'OK4U æ–°è¯ç ”å‘æˆåŠŸï¼è‚¡ä»·æ¶¨è‡³ $50ã€‚' },
            { type: 'Buyer', target: '3å®¤2å… æ¡æ¼', price: 135000, desc: 'åˆšéœ€ä¹°å®¶å‡ºç°ï¼å‡ºä»· $135k è´­ä¹°3å®¤2å…çš„æˆ¿å­ã€‚' },
            { type: 'Buyer', target: '2å®¤1å… å…¬å¯“', price: 65000, desc: 'æŠ•èµ„å®¢å‡ºä»· $65k æ”¶è´­æ‰€æœ‰2å®¤1å…å…¬å¯“ã€‚' },
            { type: 'Buyer', target: '4å•å…ƒ å…¬å¯“', price: 220000, desc: 'å…¬å¯“å¸‚åœºå›æš–ã€‚ä¹°å®¶å‡ºä»· $220kã€‚' },
            { type: 'Inflation', desc: 'é€šè´§è†¨èƒ€ï¼æ‰€æœ‰æ¶ˆè´¹å“ä»·æ ¼ä¸Šæ¶¨ã€‚' },
            { type: 'Buyer', target: 'é‡‘å¸æ”¶è—', price: 1000, desc: 'é‡‘ä»·æš´æ¶¨ï¼æ”¶è—å®¶æ€¥å¯»å…‹é²æ ¼é‡‘å¸ï¼Œå‡ºä»· $1,000ã€‚' },
            { type: 'Buyer', target: 'è½¯ä»¶å…¬å¸ IPO', price: 250000, desc: 'ä¸Šå¸‚å¤§è·æˆåŠŸï¼ä½ çš„åŸå§‹è‚¡ä»·å€¼é£™å‡è‡³ $250,000ï¼' }
        ],
        doodads: [
            { name: 'å‘¨æœ«åº¦å‡', cost: 2000, icon: 'ğŸ–ï¸' },
            { name: 'è´­ç‰©ç‹‚æ¬¢', cost: 3000, icon: 'ğŸ›ï¸' },
            { name: 'è´­ä¹°å¤§å±ç”µè§†', cost: 3500, icon: 'ğŸ“º' },
            { name: 'æ–°éŸ³å“ç³»ç»Ÿ', cost: 1200, icon: 'ğŸ”Š' },
            { name: 'æ–°é«˜å°”å¤«çƒå…·', cost: 1500, icon: 'â›³ï¸' },
            { name: 'ç å®é¦–é¥°', cost: 5000, icon: 'ğŸ’' },
            { name: 'è±ªåæ™šé¤', cost: 400, icon: 'ğŸ½ï¸' },
            { name: 'æ–°è¡£æœå¥—è£…', cost: 800, icon: 'ğŸ‘”' },
            { name: 'èˆ¹åªç»´ä¿®', cost: 6000, icon: 'ğŸ›¥ï¸' },
            { name: 'å®¶åº­å¨±ä¹ç³»ç»Ÿ', cost: 2500, icon: 'ğŸ®' },
            { name: 'è´­ä¹°æ–°å®¶å…·', cost: 4000, icon: 'ğŸ›‹ï¸' },
            { name: 'æ±½è½¦å¤§ä¿®', cost: 1500, icon: 'ğŸ”§' },
            { name: 'å¥¢ä¾ˆæ‰‹è¡¨', cost: 8000, icon: 'âŒš' },
            { name: 'æ¸¸è‰‡ä¿å…»', cost: 12000, icon: 'âš“' }
        ],
    };

    let uiTimer = null; 

    const game = {
        state: {
            isGameOver: false,
            isFastTrack: false, 
            userDream: null,    
            ftAddedCashflow: 0, 
            
            cash: 0,
            loan: 0,
            liabilities: [],
            pos: 0,
            assets: [], 
            salary: 0,
            passive: 0,
            childCount: 0,
            currentCard: null,
            inputQty: 100, 
            currentTab: 'paper',
            downsizedTurns: 0, 
            charityTurns: 0, 
            eventQueue: [],
            fastTrackCharityTurns: 0, 
            fastTrackBiz: {}, 
            
            jobTitle: '',
            jobIcon: '',
            perBabyCost: 0,
            basicTax: 0,
            otherExpense: 0
        },

        isMoving: false, 

        init() {
            this.renderDreamSelection();
        },

        renderDreamSelection() {
            this.openOverlay('dream-modal');
            const list = document.getElementById('dream-list');
            // æ¸…ç©ºé™¤ spacer ä»¥å¤–çš„å†…å®¹
            list.innerHTML = ''; 
            
            CONFIG.dreams.forEach(dream => {
                const btn = document.createElement('button');
                btn.className = "block w-full p-4 mb-3 rounded-2xl border bg-white/60 dark:bg-[#2c2c2e]/60 border-slate-100 dark:border-white/5 active:bg-pink-50 dark:active:bg-pink-900/20 active:scale-[0.98] transition-all text-left group shadow-sm relative overflow-hidden";
                btn.onclick = (e) => {
                     e.stopPropagation(); 
                     this.startGame(dream);
                };
                
                btn.innerHTML = `
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="text-3xl bg-white dark:bg-white/10 w-12 h-12 rounded-full flex items-center justify-center shadow-sm text-shadow">${dream.icon}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-slate-800 dark:text-white text-[15px] flex justify-between items-center">
                            <span class="truncate pr-2">${dream.name}</span>
                            <span class="text-pink-600 dark:text-pink-400 font-mono text-sm bg-pink-50 dark:bg-pink-900/30 px-2 py-0.5 rounded-lg">$${dream.cost/1000}k</span>
                        </div>
                        <div class="text-[11px] text-slate-500 dark:text-slate-400 leading-tight mt-1 line-clamp-2">${dream.desc}</div>
                    </div>
                   </div>
               `;
               list.appendChild(btn);
            });
            // åº•éƒ¨å«é«˜
            const spacer = document.createElement('div');
            spacer.className = "h-20";
            list.appendChild(spacer);
        },

        startGame(selectedDream) {
            this.state.userDream = selectedDream;
            this.closeModal(); 
            
            this.state.isGameOver = false;
            this.state.isFastTrack = false;
            this.state.pos = 0;
            this.state.ftAddedCashflow = 0;

            const job = CONFIG.professions[Math.floor(Math.random() * CONFIG.professions.length)];
            
            this.state.jobTitle = job.name;
            this.state.jobIcon = job.icon;
            this.state.salary = job.salary;
            this.state.cash = job.savings;
            this.state.perBabyCost = job.perChild;
            
            this.state.basicTax = job.expenses.tax;
            this.state.otherExpense = job.expenses.other;

            this.state.liabilities = [];
            this.state.assets = [];
            this.state.passive = 0;
            this.state.childCount = 0;
            
            const debtMap = {
                mortgage: { name: 'æˆ¿å±‹æŠµæŠ¼', exp: job.expenses.mortgage },
                car: { name: 'è´­è½¦è´·æ¬¾', exp: job.expenses.car },
                credit: { name: 'ä¿¡ç”¨å¡', exp: job.expenses.credit },
                retail: { name: 'é›¶å”®ä¿¡è´·', exp: job.expenses.retail },
                loan: { name: 'æ•™è‚²è´·æ¬¾', exp: job.expenses.loan }
            };

            for (const [key, amount] of Object.entries(job.debts)) {
                if (amount > 0) {
                    this.state.liabilities.push({
                        id: key,
                        name: debtMap[key].name,
                        balance: amount,
                        expense: debtMap[key].exp
                    });
                }
            }

            this.renderBoard(); 
            this.updateUI();
            
            document.getElementById('sheet-salary').innerText = this.state.salary.toLocaleString();
            document.getElementById('game-phase-text').innerText = this.state.jobTitle;
            document.getElementById('game-phase-badge').innerText = this.state.jobIcon;
            
            this.log(`ğŸ¯ ç›®æ ‡: ${selectedDream.name}`, true);
            setTimeout(() => this.log(`ğŸ² èŒä¸š: ${job.name} (é€ƒç¦»è€é¼ èµ›è·‘)`), 1500);
        },

        enterFastTrack() {
            this.state.isFastTrack = true;
            this.state.isGameOver = false;
            
            const oldPassive = this.state.passive;
            this.state.cash += (oldPassive * 100);
            
            this.state.assets = []; 
            this.state.liabilities = []; 
            this.state.childCount = 0;
            this.state.loan = 0;
            this.state.basicTax = 0;
            this.state.otherExpense = 0;
            this.state.pos = 0;
            this.state.ftAddedCashflow = 0;
            
            this.state.salary = oldPassive;
            this.state.passive = 0; 

            this.renderBoard();
            this.updateUI();
            
            document.getElementById('game-phase-badge').innerText = 'ğŸï¸';
            document.getElementById('game-phase-text').innerText = 'å¿«è½¦é“';
            
            this.openOverlay('game-over-modal');
            document.getElementById('end-icon').innerText = 'ğŸš€';
            document.getElementById('end-title').innerText = 'æ™‹çº§å¿«è½¦é“ï¼';
            document.getElementById('end-desc').innerHTML = `
                ä½ å·²è´¢åŠ¡è‡ªç”±ï¼è·å¾—å¯åŠ¨èµ„é‡‘ <b class="text-green-500">$${(oldPassive*100).toLocaleString()}</b>ã€‚<br><br>
                <div class="text-left bg-slate-100 dark:bg-white/10 p-3 rounded-xl text-xs space-y-2">
                <div class="font-bold">ğŸ† èƒœåˆ©æ¡ä»¶ (äºŒé€‰ä¸€):</div>
                <div>1. è´­ä¹°ä½ çš„æ¢¦æƒ³: <span class="text-pink-500 font-bold">${this.state.userDream.name}</span></div>
                <div>2. æˆ–å¢åŠ ç°é‡‘æµ: <span class="text-green-500 font-bold">+$50,000/æœˆ</span></div>
                </div>
            `;
            
            const btn = document.querySelector('#game-over-modal button');
            btn.innerText = "å¼€å§‹é£™è½¦";
            btn.onclick = () => this.closeModal();
        },

        get liabilitiesExpense() { return this.state.liabilities.reduce((sum, item) => sum + item.expense, 0); },
        get childExpense() { return this.state.childCount * this.state.perBabyCost; },
        get totalExpense() {
            const loanInterest = this.state.loan * 0.1;
            return this.state.basicTax + this.state.otherExpense + this.liabilitiesExpense + this.childExpense + loanInterest;
        },
        get monthlyFlow() { 
            if (this.state.isFastTrack) return this.state.salary + this.state.passive;
            return (this.state.salary + this.state.passive) - this.totalExpense; 
        },
        get totalIncome() { return this.state.salary + this.state.passive; },

        renderDiceControls() {
            const container = document.getElementById('dice-controls');
            if (this.state.isGameOver && !this.state.isFastTrack) {
                container.innerHTML = ''; return;
            }
            container.innerHTML = '';

            const disabledClass = this.isMoving ? "opacity-50 pointer-events-none" : "";
            const commonClass = `tap-effect flex-1 bg-[#1C1C1E] dark:bg-white dark:text-black text-white rounded-2xl font-bold text-lg shadow-xl shadow-slate-300 dark:shadow-none flex items-center justify-center gap-2 active:bg-black transition-all ${disabledClass}`;

            if (this.state.isFastTrack) {
                container.innerHTML = '';
                const btn2 = document.createElement('button');
                btn2.onclick = () => game.rollDice(2);
                btn2.className = `tap-effect flex-1 bg-pink-600 dark:bg-pink-500 dark:text-white text-white rounded-2xl font-bold text-lg shadow-xl flex items-center justify-center gap-2 ${this.isMoving ? 'opacity-50 pointer-events-none' : ''}`;
                btn2.innerHTML = 'ğŸ²ğŸ² åŒéª°';
                container.appendChild(btn2);

                if (this.state.fastTrackCharityTurns > 0) {
                    const btn3 = document.createElement('button');
                    btn3.onclick = () => {
                        game.rollDice(3);
                        game.state.fastTrackCharityTurns--;
                        game.updateUI();
                    };
                    btn3.className = `tap-effect flex-1 bg-orange-600 text-white rounded-2xl font-bold text-lg shadow-xl flex items-center justify-center gap-2 ${this.isMoving ? 'opacity-50 pointer-events-none' : ''}`;
                    btn3.innerHTML = `ğŸ²ğŸ²ğŸ² ä¸‰éª°ï¼ˆå‰©ä½™${this.state.fastTrackCharityTurns}æ¬¡ï¼‰`;
                    container.appendChild(btn3);
                }
                return;
            }

            if (this.state.downsizedTurns > 0) {
                container.innerHTML = `
                    <button onclick="game.rollDice(1)" class="flex-1 bg-white/10 backdrop-blur-md border border-white/10 text-white/50 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 transition-all tap-effect shadow-lg">
                        <span class="text-2xl">ğŸ’¤</span> 
                        <div class="flex flex-col leading-none">
                            <span class="text-sm font-medium">æš‚åœå›åˆ</span>
                            <span class="text-[10px] opacity-60">å‰©ä½™ ${this.state.downsizedTurns} è½®</span>
                        </div>
                    </button>
                `;
                return;
            }

            if (this.state.charityTurns > 0) {
                container.innerHTML = `
                    <button onclick="game.rollDice(1)" class="${commonClass}">ğŸ² 1</button>
                    <button onclick="game.rollDice(2)" class="${commonClass} bg-orange-500 shadow-orange-200">ğŸ² 2</button>
                `;
            } else {
                container.innerHTML = `<button onclick="game.rollDice(1)" class="${commonClass}">ğŸ² æ·éª°å­</button>`;
            }
        },

        rollDice(diceCount) {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            if (this.isMoving) return;
            
            const overlay = document.getElementById('modal-overlay');
            if ((!overlay.classList.contains('hidden')) || overlay.style.display === 'flex') {
                return;
            }

            if (this.state.downsizedTurns > 0) {
                this.state.downsizedTurns--;
                this.log(`ğŸ›‹ï¸ åœèµ›ä¸­... è¿˜å‰© ${this.state.downsizedTurns} è½®`);
                this.updateUI();
                return;
            }

            // --- è‡ªåŠ¨è´·æ¬¾é€»è¾‘ ---
            if (this.state.cash < 0) {
                const debt = Math.abs(this.state.cash);
                const borrowAmt = Math.ceil(debt / 1000) * 1000;
                this.manageLoan(borrowAmt);
                this.log(`âš ï¸ ç°é‡‘ä¸è¶³ï¼Œè‡ªåŠ¨è´·æ¬¾ $${borrowAmt.toLocaleString()}`);
                this.updateUI();
                return; // åˆ·æ–°UIåç­‰å¾…ç”¨æˆ·å†æ¬¡ç‚¹å‡»éª°å­
            }
            // ------------------

            if (this.state.charityTurns > 0) {
                this.state.charityTurns--;
            }

            let dice = 0;
            const d1 = Math.floor(Math.random() * 6) + 1;
            if (diceCount === 2) {
                const d2 = Math.floor(Math.random() * 6) + 1;
                dice = d1 + d2;
                this.log(`ğŸ² æ·å‡ºäº† ${d1} + ${d2} = ${dice} ç‚¹`, true);
            } else {
                dice = d1;
                this.log(`ğŸ² æ·å‡ºäº† ${dice} ç‚¹`, true);
            }
            
            this.isMoving = true;
            this.updateUI(); 
            
            let stepsRemaining = dice;
            const tiles = this.state.isFastTrack ? CONFIG.fastTrackTiles : CONFIG.tiles;
            let lastTime = 0;

            const animateMove = (timestamp) => {
                if (this.state.isGameOver && !this.state.isFastTrack) return;
                if (!lastTime) lastTime = timestamp;
                const elapsed = timestamp - lastTime;

                const speed = this.state.isFastTrack ? 120 : 180;

                if (elapsed > speed) { 
                    if (stepsRemaining <= 0) {
                        this.isMoving = false;
                        this.updateUI();
                        this.triggerTile(tiles[this.state.pos]);
                        return;
                    }

                    this.updatePlayerToken(this.state.pos, (this.state.pos + 1) % tiles.length);
                    this.state.pos = (this.state.pos + 1) % tiles.length;

                    if (stepsRemaining > 1) { 
                        if (tiles[this.state.pos].type === 'Pay' || tiles[this.state.pos].type === 'FT_Pay') {
                            this.payDay();
                        }
                    }

                    stepsRemaining--;
                    lastTime = timestamp;
                }
                
                if (stepsRemaining >= 0) {
                        requestAnimationFrame(animateMove);
                }
            };

            requestAnimationFrame(animateMove);
        },

        updatePlayerToken(oldIndex, newIndex) {
            const tiles = document.getElementById('game-board').children;
            if (tiles[oldIndex]) {
                tiles[oldIndex].classList.remove('active');
                const token = tiles[oldIndex].querySelector('.player-token');
                if (token) token.remove();
            }
            
            if (tiles[newIndex]) {
                tiles[newIndex].classList.add('active');
                if (!tiles[newIndex].querySelector('.player-token')) {
                    tiles[newIndex].innerHTML += `<div class="player-token"></div>`;
                }
                setTimeout(() => tiles[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }), 10);
            }
        },

        payDay() {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            
            const flow = this.monthlyFlow;
            this.state.cash += flow;
            this.log(`ğŸ’° ç»“ç®—æ—¥ï¼šç°é‡‘ +$${flow.toLocaleString()}`);
            this.animChange('display-cash', 'positive');
            
            this.checkWinCondition(); 

            if (!this.state.isFastTrack && this.state.cash < 0) {
                this.checkBankruptcy();
            }
        },

        checkBankruptcy() {
            if (this.state.isGameOver) return;
            
            if (this.state.cash < 0 || this.monthlyFlow < 0) {
                this.log(`âš ï¸ è´¢åŠ¡è­¦æŠ¥ï¼šç°é‡‘æˆ–æœˆç°é‡‘æµä¸ºè´Ÿï¼Œè¯·å€Ÿè´·æˆ–å˜å–èµ„äº§`, true);
                
                if (document.getElementById('sheet-modal').classList.contains('hidden')) {
                    setTimeout(() => this.toggleSheet(), 600);
                }
            }
        },

        triggerTile(tile) {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            
            if (this.state.isFastTrack) {
                this.handleFastTrackTile(tile);
            } else {
                switch(tile.type) {
                    case 'Pay': this.payDay(); break;
                    case 'Opp': this.openOverlay('choice-modal'); break;
                    case 'Doodad': 
                        const doodad = CONFIG.doodads[Math.floor(Math.random() * CONFIG.doodads.length)];
                        this.showCardModal('DOODAD', doodad); 
                        break;
                    case 'Market':
                        const market = CONFIG.marketCards[Math.floor(Math.random() * CONFIG.marketCards.length)];
                        this.handleMarket(market);
                        break;
                    case 'Charity': this.triggerCharity(); break;
                    case 'Baby':
                        if (this.state.childCount >= 3) {
                            this.log(`ğŸ‘¶ å­©å­å·²è¾¾ä¸Šé™`);
                        } else {
                            this.state.childCount++;
                            this.log(`ğŸ‘¶ å–œå¾—è´µå­ (æ”¯å‡º +$${this.state.perBabyCost}/æœˆ)`, true);
                        }
                        this.updateUI();
                        break;
                    case 'Downsized':
                        const expense = this.totalExpense;
                        this.state.cash -= expense; 
                        this.state.downsizedTurns = 2; 
                        this.state.charityTurns = 0; 
                        this.log(`ğŸ›‹ï¸ å¤±ä¸šï¼šæ”¯ä»˜è´¦å•å¹¶åœèµ›2è½®`);
                        this.updateUI();
                        if (this.state.cash < 0) this.checkBankruptcy();
                        break;
                }
            }
        },

        handleFastTrackTile(tile) {
            switch(tile.type) {
                case 'FT_Pay':
                    this.payDay();
                    break;

                case 'FT_Biz':
                    if (this.state.fastTrackBiz[this.state.pos]) {
                        const deal = this.state.fastTrackBiz[this.state.pos];
                        this.log(`ğŸ¢ å·²æ‹¥æœ‰ï¼š${deal.name} (+$${deal.flow.toLocaleString()}/æœˆ)`);
                        break;
                    }
                    const deal = CONFIG.fastTrackDeals[Math.floor(Math.random() * CONFIG.fastTrackDeals.length)];
                    const flow = deal.flow + (Math.floor(Math.random()*5)*1000);
                    const cost = deal.cost + (Math.floor(Math.random()*5)*10000);
                    
                    this.showCardModal('OPP', {
                        name: deal.name,
                        type: 'Business',
                        cost: cost,
                        down: cost, 
                        flow: flow,
                        desc: deal.desc,
                        icon: deal.icon
                    });
                    this.state.currentCard.tempPos = this.state.pos;
                    break;
                case 'FT_Dream':
                    // 30% å‡ ç‡åˆ·å‡ºç©å®¶è‡ªå·±çš„æ¢¦æƒ³
                    const isMyDream = (Math.random() > 0.7); 
                    
                    const targetDream = isMyDream ? this.state.userDream : CONFIG.dreams[Math.floor(Math.random() * CONFIG.dreams.length)];
                    const isTargetMyDream = targetDream.id === this.state.userDream.id;

                    if (isTargetMyDream) {
                        this.queueEvent({
                            type: 'INFO_DECISION',
                            data: {
                                name: `ä½ çš„æ¢¦æƒ³: ${targetDream.name}`,
                                desc: `ğŸ’– <b>è¿™æ˜¯ä½ æ¢¦å¯ä»¥æ±‚çš„ï¼</b><br>æ”¯ä»˜ $${targetDream.cost.toLocaleString()} è´­ä¹°å¹¶<b>èµ¢å¾—æ¸¸æˆ</b>ï¼`,
                                icon: targetDream.icon,
                                cost: targetDream.cost,
                                onConfirm: () => {
                                    if (this.state.cash >= targetDream.cost) {
                                        this.state.cash -= targetDream.cost;
                                        this.winGame('DREAM');
                                    } else {
                                        this.log('ç°é‡‘ä¸è¶³', true);
                                    }
                                }
                            }
                        });
                    } else {
                        // åˆ«äººçš„æ¢¦æƒ³ï¼šè®¾ä¸º INFO_ONLYï¼Œå¹¶åœ¨ showCardModal ä¸­éšè—è´­ä¹°æŒ‰é’®
                        this.queueEvent({
                            type: 'INFO_ONLY',
                            data: {
                                name: `åˆ«äººçš„æ¢¦æƒ³: ${targetDream.name}`,
                                desc: `è¿™æ˜¯åˆ«äººçš„æ¢¦æƒ³ï¼Œä½ åªèƒ½çœ‹çœ‹ã€‚<br>æˆæœ¬: $${targetDream.cost.toLocaleString()}<br><span class="text-xs text-slate-400">(ä½ åªèƒ½è´­ä¹°è‡ªå·±é€‰å®šçš„æ¢¦æƒ³)</span>`,
                                icon: targetDream.icon
                            }
                        });
                    }
                    this.processQueue();
                    break;
                case 'FT_Charity':
                    this.triggerCharity();
                    break;
                case 'FT_Hazard':
                    if (tile.effect === 'audit') {
                        this.log('ğŸ‘® ç¨åŠ¡å®¡è®¡ï¼å¤±å»ä¸€åŠç°é‡‘ã€‚', true);
                        this.state.cash = Math.floor(this.state.cash / 2);
                    } else if (tile.effect === 'divorce') {
                        this.log('ğŸ’” ç¦»å©šï¼å¤±å»æ‰€æœ‰ç°é‡‘ã€‚', true);
                        this.state.cash = 0;
                    } else if (tile.effect === 'lawsuit') {
                        const cost = Math.floor(this.state.cash / 2);
                        this.log(`âš–ï¸ é­é‡å®˜å¸ï¼æ”¯ä»˜ $${cost.toLocaleString()} å¾‹å¸ˆè´¹`, true);
                        this.state.cash -= cost;
                    }
                    this.updateUI();
                    break;
            }
        },

        triggerCharity() {
            const cost = Math.floor(this.totalIncome * 0.1);
            this.queueEvent({
                type: 'INFO_DECISION',
                data: {
                    name: 'æ…ˆå–„æèµ ',
                    desc: `æèµ æ€»æ”¶å…¥çš„ 10% ($${cost.toLocaleString()})ï¼Ÿ<br>å¥½å¤„ï¼šæ¥ä¸‹æ¥3ä¸ªå›åˆå¯ä½¿ç”¨ä¸‰é¢—éª°å­ã€‚`,
                    icon: 'ğŸ’œ',
                    cost: cost,
                    onConfirm: () => {
                        if(this.state.cash >= cost) {
                            this.state.cash -= cost;
                            if (this.state.isFastTrack) {
                                this.state.fastTrackCharityTurns = 3;
                            } else {
                                this.state.charityTurns = 3;
                            }
                            this.log(`ğŸ’œ æèµ æˆåŠŸï¼Œç‰¹æƒç”Ÿæ•ˆï¼`, true);
                            this.updateUI();
                        } else {
                            this.log('ç°é‡‘ä¸è¶³');
                        }
                    }
                }
            });
            this.processQueue();
        },

        manageLoan(amount) {
            if (!amount) return;
            if (this.state.isFastTrack) return; 

            if (amount > 0) {
                this.state.loan += amount;
                this.state.cash += amount;
                this.log(`ğŸ¦ å€Ÿå…¥ $${amount}`);
            } else {
                let repay = Math.abs(amount);
                if (this.state.loan < repay) repay = this.state.loan;
                if (repay <= 0) { this.log("ğŸ¦ æ— è´·æ¬¾éœ€å¿è¿˜"); return; }

                if (this.state.cash >= repay) {
                    this.state.loan -= repay;
                    this.state.cash -= repay;
                    this.log(`ğŸ¦ è¿˜æ¬¾ $${repay}`);
                } else {
                    this.log("âš ï¸ ç°é‡‘ä¸è¶³ä»¥è¿˜æ¬¾", true);
                    const panel = document.querySelector('.loan-panel');
                    if(panel) {
                        panel.classList.add('shake-anim');
                        setTimeout(()=>panel.classList.remove('shake-anim'), 400);
                    }
                }
            }
            this.updateUI();
            this.renderSheet('debt');
        },

        quickLoan() {
            const sheet = document.getElementById('sheet-modal');
            const isHidden = sheet.classList.contains('hidden');
            
            if (isHidden) {
                this.renderSheet('debt');
                sheet.style.display = 'flex'; 
                sheet.classList.remove('hidden');
                
                this.state.currentTab = 'debt';
                document.querySelectorAll('.segment-btn').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.segment-btn')[1].classList.add('active'); 
                document.getElementById('panel-invest').classList.add('hidden');
                document.getElementById('panel-debt').classList.remove('hidden');
            } else {
                this.toggleSheet();
            }
        },
        
        promptPayLiability(id) {
            const item = this.state.liabilities.find(l => String(l.id) === String(id));
            if (!item) return;

            this.toggleSheet();

            this.queueEvent({
                type: 'INFO_DECISION',
                data: {
                    name: `å¿è¿˜: ${item.name}`,
                    desc: `æ”¯ä»˜ $${item.balance.toLocaleString()} ä»¥æ¶ˆé™¤æ¯æœˆ $${item.expense} çš„æ”¯å‡ºã€‚<br>è¿™å°†å¢åŠ ä½ çš„æœˆç°é‡‘æµã€‚`,
                    icon: 'ğŸ’³',
                    cost: item.balance,
                    onConfirm: () => {
                        this.payLiabilityExec(item.id);
                    }
                }
            });
            this.processQueue();
        },

        payLiabilityExec(id) {
            const item = this.state.liabilities.find(l => String(l.id) === String(id));
            if (!item) return;

            if (this.state.cash >= item.balance) {
                this.state.cash -= item.balance;
                this.state.liabilities = this.state.liabilities.filter(l => String(l.id) !== String(id));
                this.log(`ğŸ’¸ å·²è¿˜æ¸… ${item.name}`);
                this.updateUI();
                this.checkWinCondition();
            } else {
                this.log('ç°é‡‘ä¸è¶³', true);
            }
        },

        liquidateAsset(id) {
            const assetIdx = this.state.assets.findIndex(a => a.id === id);
            if (assetIdx === -1) return;
            const asset = this.state.assets[assetIdx];

            if (this.state.isFastTrack) return; 

            if (asset.type === 'Stock' || asset.type === 'Option') {
                const recoup = Math.floor((asset.cost * asset.quantity) / 2);
                if (!confirm(`ã€ç´§æ€¥æŠ›å”®ã€‘é“¶è¡ŒåŠä»·å›æ”¶è‚¡ç¥¨ï¼Œå¾—æ¬¾ $${recoup}ã€‚ç¡®å®šï¼Ÿ`)) return;
                this.state.cash += recoup;
            } else {
                const returnCash = Math.floor(asset.down / 2);
                if (!confirm(`ã€èµ„äº§æŠ›å”®ã€‘æŠ˜ä»·å–ç»™é“¶è¡Œï¼Œæ”¶å›é¦–ä»˜çš„ä¸€åŠ: $${returnCash}ã€‚ç¡®å®šå—ï¼Ÿ`)) return;
                this.state.passive -= (asset.flow || 0);
                this.state.cash += returnCash;
            }

            this.state.assets.splice(assetIdx, 1);
            this.log(`ğŸ’¸ èµ„äº§å·²å˜å–`);
            this.updateUI();
            this.renderSheet('paper');
        },

        chooseDeal(type) {
            if (type === 'Big' && this.state.cash < 500) { 
                this.log("âš ï¸ ç°é‡‘è¿‡å°‘"); return;
            }
            const deck = type === 'Big' ? CONFIG.bigDeals : CONFIG.smallDeals;
            const card = deck[Math.floor(Math.random() * deck.length)];
            this.showCardModal('OPP', JSON.parse(JSON.stringify(card)));
        },

        queueEvent(event) {
            if (this.state.isGameOver && !this.state.isFastTrack && event.type !== 'INFO_DECISION') return;
            this.state.eventQueue.push(event);
        },

        processQueue() {
            if (this.state.eventQueue.length === 0) return;
            
            const overlay = document.getElementById('modal-overlay');
            if (!overlay.classList.contains('hidden') || overlay.style.display !== 'none') return; 

            const nextEvent = this.state.eventQueue.shift();
            
            if (uiTimer) clearTimeout(uiTimer);
            
            uiTimer = setTimeout(() => {
                this.showCardModal(nextEvent.type, nextEvent.data);
            }, 100);
        },

        handleMarket(card) {
            if (card.type === 'Buyer') {
                const assets = this.state.assets.filter(a => a.name === card.target);
                if (assets.length > 0) {
                    assets.forEach(asset => {
                        const loan = asset.cost - asset.down;
                        const netCash = card.price - loan;
                        let actionName = `å‡ºå”®: ${card.target}`;
                        let icon = 'ğŸ¤';
                        if (asset.type === 'Business') { actionName = 'ä¼ä¸šé€€å‡º/IPO'; icon = 'ğŸ¢'; }
                        if (asset.type === 'Asset') { actionName = 'èµ„äº§å˜ç°'; icon = 'ğŸ’°'; }

                        this.queueEvent({
                            type: 'MARKET_SELL',
                            data: {
                                id: uuid(), 
                                name: actionName, 
                                desc: `${card.desc}<br><br>
                                        <div class="text-xs bg-slate-100 dark:bg-white/10 p-2 rounded">
                                        å–å‡ºä»·: <b>$${card.price.toLocaleString()}</b><br>
                                        å¿è¿˜è´·æ¬¾: -$${loan.toLocaleString()}<br>
                                        <div class="border-t border-slate-300 dark:border-white/20 my-1"></div>
                                        å‡€å¾—ç°é‡‘: <b class="text-green-600">$${netCash.toLocaleString()}</b>
                                        </div>`,
                                icon: icon, 
                                sellPrice: card.price, 
                                targetAssetId: asset.id, 
                                roi: netCash 
                            }
                        });
                    });
                } else {
                        this.log(`ğŸ“° å¸‚åœº: ${card.desc}`);
                }
            } 
            else if (card.type === 'PriceChange') {
                const stocks = this.state.assets.filter(a => a.symbol === card.symbol && a.type === 'Stock');
                if (stocks.length > 0) {
                    stocks.forEach(stock => {
                        if (stock.quantity > 0) { 
                            const totalValue = stock.quantity * card.price;
                            const profit = totalValue - (stock.quantity * stock.cost);
                            
                            this.queueEvent({
                                type: 'MARKET_SELL',
                                data: {
                                    id: uuid(),
                                    name: `è¡Œæƒ…: ${card.symbol} $${card.price}`,
                                    desc: `${card.desc}<br>
                                            ä½ æœ‰ ${stock.quantity} è‚¡ (å‡ä»· $${Math.floor(stock.cost)})ã€‚<br><br>
                                            <div class="flex justify-between text-xs font-bold">
                                                <span>å¸‚å€¼: $${totalValue.toLocaleString()}</span>
                                                <span class="${profit>=0?'text-green-500':'text-red-500'}">
                                                ${profit>=0?'+':''}$${profit.toLocaleString()}
                                                </span>
                                            </div>`,
                                    icon: 'ğŸ“ˆ',
                                    sellPrice: totalValue, 
                                    targetAssetId: stock.id,
                                    roi: totalValue 
                                }
                            });
                        }
                    });
                } else {
                        this.log(`ğŸ“° å¸‚åœº: ${card.symbol} ç°ä»· $${card.price}`);
                }
            }
            else if (card.type === 'Inflation') {
                    this.log(`ğŸ“° å¸‚åœº: ${card.desc}`);
            }
            this.processQueue();
        },

        showCardModal(type, data) {
            if (this.state.isGameOver && !this.state.isFastTrack) return;
            if (uiTimer) clearTimeout(uiTimer);

            this.state.currentCard = { ...data, actionType: type };
            this.state.inputQty = 100; 
            
            this.openOverlay('card-modal');
            
            document.getElementById('modal-cash-display').innerText = '-' + this.state.loan.toLocaleString();

            const title = document.getElementById('card-title');
            const desc = document.getElementById('card-desc');
            const icon = document.getElementById('card-icon-bg');
            const financials = document.getElementById('card-financials');
            const inputArea = document.getElementById('input-area');
            const btnAction = document.getElementById('btn-card-action');
            const btnShort = document.getElementById('btn-short-action');
            const btnCancel = document.getElementById('btn-cancel');
            const tag = document.getElementById('card-tag');
            const inputPrice = document.getElementById('input-price-per');

            title.innerText = data.name;
            desc.innerHTML = data.desc;
            desc.className = "text-slate-500 dark:text-slate-400 text-sm mt-3 leading-relaxed px-2"; 
            icon.innerText = data.icon || 'ğŸ“„';
            tag.innerText = type === 'OPP' ? (data.type === 'Business' ? 'Big Deal' : 'Deal') : type;
            tag.classList.remove('hidden');

            financials.classList.add('hidden');
            inputArea.classList.add('hidden');
            btnShort.classList.add('hidden');
            btnAction.classList.remove('hidden');
            btnCancel.classList.remove('hidden'); 

            // å¦‚æœæ˜¯ INFO_ONLYï¼Œä¸¥æ ¼éšè—æ“ä½œæŒ‰é’®ï¼Œå¹¶è°ƒæ•´å–æ¶ˆæŒ‰é’®æ ·å¼
            if (type === 'INFO_ONLY') {
                btnAction.classList.add('hidden');
                btnShort.classList.add('hidden'); 
                btnCancel.innerText = 'å…³é—­';
                btnCancel.classList.remove('flex-1');
                btnCancel.classList.add('w-full', 'bg-slate-200', 'dark:bg-white/20', 'text-slate-900', 'dark:text-white'); 
            } else {
                btnAction.classList.remove('hidden');
                btnCancel.classList.add('flex-1'); 
                btnCancel.classList.remove('w-full', 'bg-slate-200', 'dark:bg-white/20', 'text-slate-900', 'dark:text-white');
            }
            
            btnAction.className = "flex-[1.5] py-3.5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 dark:shadow-none tap-effect text-sm transition-colors";

            if (type === 'OPP') {
                if (data.type === 'Stock') {
                    inputArea.classList.remove('hidden');
                    inputPrice.innerText = `$${data.cost}`;
                    this.updateInputTotal(); 
                    btnAction.innerText = 'ç°é‡‘ä¹°å…¥';
                } else {
                    financials.classList.remove('hidden');
                    document.getElementById('lbl-cost').innerText = 'æ€»ä»·';
                    document.getElementById('val-cost').innerText = `$${data.cost.toLocaleString()}`;
                    document.getElementById('lbl-down').innerText = 'é¦–ä»˜/æˆæœ¬';
                    document.getElementById('val-down').innerText = `$${data.down.toLocaleString()}`;
                    document.getElementById('val-flow').innerText = `+$${data.flow.toLocaleString()}`;
                    btnAction.innerText = this.state.isFastTrack ? 'æŠ•èµ„é¡¹ç›®' : 'è´­ä¹°èµ„äº§';
                }
            } 
            else if (type === 'MARKET_SELL') {
                btnAction.innerText = 'ç¡®è®¤å–å‡º';
                btnAction.classList.replace('bg-blue-600', 'bg-green-600');
                financials.classList.add('hidden');
            }
            else if (type === 'DOODAD') {
                tag.classList.add('hidden');
                financials.classList.add('hidden');
                btnCancel.classList.add('hidden');
                desc.className = "text-3xl font-bold text-slate-900 dark:text-white my-6 text-center tracking-tight"; 
                desc.innerText = `-$${data.cost.toLocaleString()}`;
                btnAction.innerText = `æ”¯ä»˜`; 
                btnAction.classList.replace('bg-blue-600', 'bg-red-500');
            }
            else if (type === 'INFO_DECISION') {
                btnAction.innerText = `ç¡®è®¤ ($${data.cost.toLocaleString()})`;
            }
        },

        manualInputShares(val) {
            const num = parseInt(val) || 0;
            this.state.inputQty = num < 0 ? 0 : num;
            this.updateInputTotal();
        },

        adjustShares(delta) {
            let newQty = this.state.inputQty + delta;
            if (newQty < 0) newQty = 0;
            this.state.inputQty = newQty;
            document.getElementById('input-qty-field').value = newQty;
            this.updateInputTotal();
        },

        updateInputTotal() {
            const card = this.state.currentCard;
            if (card && card.cost) {
                document.getElementById('input-total').innerText = '$' + (this.state.inputQty * card.cost).toLocaleString();
            }
        },

        confirmCardAction(intent) {
            const card = this.state.currentCard;
            if (!card) return; 

            if (card.actionType === 'INFO_DECISION') {
                    if (card.onConfirm) card.onConfirm();
            }
            else if (card.actionType === 'OPP') {
                if (card.type === 'Stock') {
                    const cost = card.cost * this.state.inputQty;
                    if (intent === 'BUY') {
                        if (this.state.cash >= cost) {
                            const existingStock = this.state.assets.find(a => a.type === 'Stock' && a.symbol === card.symbol);
                            if (existingStock) {
                                const oldTotalCost = existingStock.cost * existingStock.quantity;
                                const newTotalCost = cost;
                                const newQty = existingStock.quantity + this.state.inputQty;
                                this.state.cash -= cost;
                                existingStock.quantity = newQty;
                                existingStock.cost = (oldTotalCost + newTotalCost) / newQty;
                                this.log(`ğŸ›’ åŠ ä»“ ${card.symbol} (+${this.state.inputQty}è‚¡)`);
                            } else {
                                this.state.cash -= cost;
                                this.state.assets.push({ ...card, id: uuid(), quantity: this.state.inputQty, displayName: card.name });
                                this.log(`ğŸ›’ ä¹°å…¥ ${card.symbol}`);
                            }
                        } else { this.shakeModal(); return; }
                    }
                } else {
                    if (this.state.cash >= card.down) {
                        this.state.cash -= card.down;
                        this.state.assets.push({ ...card, id: uuid() });
                        this.state.passive += card.flow;
                        
                        if (this.state.isFastTrack) {
                            this.state.ftAddedCashflow += card.flow;
                            this.state.salary += card.flow; 
                            this.log(`ğŸš€ æŠ•èµ„æˆåŠŸ! ç°é‡‘æµ +$${card.flow.toLocaleString()}`);
                        } else {
                            this.log(`ğŸ  è´­å…¥èµ„äº§: +$${card.flow.toLocaleString()}/æœˆ`);
                        }

                    if (this.state.isFastTrack && this.state.currentCard && this.state.currentCard.tempPos !== undefined) {
                        this.state.fastTrackBiz[this.state.currentCard.tempPos] = {
                            name: card.name,
                            icon: card.icon,
                            flow: card.flow
                        };
                        delete this.state.currentCard.tempPos;
                        this.renderBoard(); 
                    }

                    } else { this.shakeModal(); return; }
                }
            }
            else if (card.actionType === 'MARKET_SELL') {
                this.state.cash += card.roi;
                const idx = this.state.assets.findIndex(a => a.id === card.targetAssetId);
                if (idx > -1) {
                        if (this.state.assets[idx].flow) this.state.passive -= this.state.assets[idx].flow;
                        this.state.assets.splice(idx, 1);
                }
                this.log(`ğŸ’° èµ„äº§å˜ç°æˆåŠŸ`);
            }
            else if (card.actionType === 'DOODAD') {
                if(this.state.cash < card.cost) {
                        const needed = card.cost - this.state.cash;
                        const loanAmt = Math.ceil(needed / 1000) * 1000;
                        if (loanAmt > 0) this.manageLoan(loanAmt);
                }
                this.state.cash -= card.cost;
                this.log(`ğŸ’¸ æ”¯ä»˜ $${card.cost}`);
            }

            this.checkWinCondition();
            this.updateUI();
            
            if (!this.state.isGameOver) {
                this.closeModal();
            }
        },

        shakeModal() {
            const m = document.getElementById('card-modal');
            m.classList.remove('modal-enter'); m.classList.add('shake-anim');
            setTimeout(() => m.classList.remove('shake-anim'), 400);
        },

        checkWinCondition() {
            if (this.state.isGameOver) return; 

            if (this.state.isFastTrack) {
                if (this.state.ftAddedCashflow >= 50000) {
                    this.winGame('CASHFLOW');
                }
            } else {
                const totalExp = this.totalExpense;
                if (this.state.passive > totalExp) {
                    this.enterFastTrack();
                }
            }
        },

     declareBankruptcy() {
         if (confirm('â˜ ï¸ ä½ ç¡®å®šè¦å®£å¸ƒç ´äº§å—ï¼Ÿ\n\nè¿™å°†ç«‹å³ç»“æŸæ¸¸æˆï¼Œä½ å°†å¤±å»ä¸€åˆ‡è¿›å±•ã€‚')) {
             this.state.isGameOver = true;
             this.isMoving = false;

             document.getElementById('end-icon').innerText = 'â˜ ï¸';
             document.getElementById('end-title').innerText = 'ç ´äº§æ¸…ç®—';
             document.getElementById('end-desc').innerHTML = `
                 å€ºåŠ¡å·²å°†ä½ å‹å®ã€‚<br><br>
                 <span class="text-xs opacity-70">è®°ä½ï¼šåå€ºåŠ¡ä¼šæ¯æ‰ä¸€åˆ‡ã€‚<br>
                 ä¸‹æ¬¡ä¼˜å…ˆæŠ•èµ„äº§ç”Ÿè¢«åŠ¨æ”¶å…¥ï¼Œé¿å…è¿‡åº¦æ¶ˆè´¹ã€‚</span>
             `;

             this.openOverlay('game-over-modal');
             document.getElementById('dice-controls').innerHTML = '';

             const btn = document.querySelector('#game-over-modal button');
             btn.innerText = "é‡æ–°å¼€å§‹";
             btn.onclick = () => location.reload();
         }
     },

        winGame(type) {
            this.state.isGameOver = true; 
            this.isMoving = false; 
            
            setTimeout(() => {
                if (uiTimer) clearTimeout(uiTimer);
                this.state.eventQueue = [];
                
                let title = '', desc = '';
                if (type === 'DREAM') {
                    title = 'æ¢¦æƒ³æˆçœŸï¼';
                    desc = `æ­å–œï¼ä½ ä¹°ä¸‹äº† <b class="text-pink-500">${this.state.userDream.name}</b>ã€‚<br>ä½ èµ¢å¾—äº†æ•´åœºæ¸¸æˆï¼`;
                } else {
                    title = 'é‡‘é’±å¸å›½ï¼';
                    desc = `æ­å–œï¼ä½ åœ¨å¿«è½¦é“å»ºç«‹äº† <b class="text-green-500">+$${this.state.ftAddedCashflow.toLocaleString()}/æœˆ</b> çš„é¢å¤–ç°é‡‘æµã€‚<br>ä½ æ˜¯çœŸæ­£çš„èµ„æœ¬å¤§é³„ï¼`;
                }

                document.getElementById('end-icon').innerText = 'ğŸ†';
                document.getElementById('end-title').innerText = title;
                document.getElementById('end-desc').innerHTML = desc;
                
                const sheet = document.getElementById('sheet-modal');
                sheet.classList.add('hidden');
                sheet.style.display = 'none';

                this.openOverlay('game-over-modal');
                document.getElementById('dice-controls').innerHTML = '';
                
                const btn = document.querySelector('#game-over-modal button');
                btn.innerText = "é‡æ–°å¼€å§‹";
                btn.onclick = () => location.reload();
            }, 50);
        },

        toggleSheet() {
            const sheet = document.getElementById('sheet-modal');
            if (sheet.classList.contains('hidden')) {
                this.renderSheet(this.state.currentTab);
                sheet.style.display = 'flex'; sheet.classList.remove('hidden');
            } else {
                sheet.style.display = 'none'; sheet.classList.add('hidden');
            }
        },

        switchTab(tab, btn) {
            this.state.currentTab = tab;
            document.querySelectorAll('.segment-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('panel-invest').classList.toggle('hidden', tab !== 'paper');
            document.getElementById('panel-debt').classList.toggle('hidden', tab !== 'debt');
            this.renderSheet(tab);
        },

        renderSheet(tab) {
            document.getElementById('sheet-loan').innerText = '$' + this.state.loan.toLocaleString();
            document.getElementById('sheet-interest').innerText = '$' + (this.state.loan * 0.1).toLocaleString();
            document.getElementById('sheet-kids').innerText = this.state.childCount;
            document.getElementById('sheet-kid-cost').innerText = this.childExpense.toLocaleString();

            if (tab === 'paper') {
                const container = document.getElementById('sheet-content');
                container.innerHTML = '';
                if (this.state.assets.length === 0) {
                    container.innerHTML = '<div class="text-white/30 text-center py-24 text-xs">æš‚æ— èµ„äº§</div>';
                } else {
                    const mergeList = ['é‡‘å¸æ”¶è—', 'ä¼˜å…ˆè‚¡åˆ†çº¢', 'é“¶è¡Œå®šæœŸå­˜å•'];
                    const mergedCounts = {};
                
                    this.state.assets.forEach(asset => {
                        if (mergeList.includes(asset.name)) {
                            if (!mergedCounts[asset.name]) {
                                mergedCounts[asset.name] = { 
                                    ...asset, 
                                    count: 1, 
                                    totalFlow: asset.flow,
                                    totalVal: asset.down 
                                };
                        } else {
                            mergedCounts[asset.name].count++;
                            mergedCounts[asset.name].totalFlow += asset.flow;
                            mergedCounts[asset.name].totalVal += asset.down;
                        }
                    }
                });

                    const renderItem = (asset, isMerged = false) => {
                        const isStock = asset.type === 'Stock';
                        const badge = isStock ? 'Stock' : (isMerged ? 'Asset' : 'Biz/Real');
                    
                        let valStr = '';
                        let titleStr = asset.name;

                        if (isMerged) {
                            titleStr = `${asset.name} <span class="text-yellow-400/80 text-xs ml-1">x${asset.count}</span>`;
                            valStr = `æ€»å€¼ $${asset.totalVal.toLocaleString()} Â· æµ $${asset.totalFlow}/æœˆ`;
                        } else if (isStock) {
                            valStr = `${asset.quantity}è‚¡ (æˆæœ¬ $${Math.floor(asset.cost)})`;
                        } else {
                            valStr = `+$${asset.flow.toLocaleString()}/æœˆ`;
                        }

                        const actionBtn = (this.state.isFastTrack || isMerged) ? '' : `<button onclick="game.liquidateAsset('${asset.id}')" class="text-[10px] text-red-200 bg-red-500/20 px-2 py-1 rounded active:bg-red-500/40">å–å‡º</button>`;

                        const div = document.createElement('div');
                        div.className = 'bg-white/10 p-3 rounded-2xl flex items-center justify-between text-white text-sm border border-white/5 mb-2';
                        div.innerHTML = `
                            <div>
                                <div class="font-bold flex items-center gap-2">${titleStr} <span class="text-[10px] bg-white/20 px-1 rounded h-fit">${badge}</span></div>
                                <div class="text-[10px] opacity-60 mt-0.5">${valStr}</div>
                            </div>
                            ${actionBtn}
                        `;
                        container.appendChild(div);
                    };

                    this.state.assets.forEach(asset => {
                        if (!mergeList.includes(asset.name)) {
                            renderItem(asset, false);
                        }
                    });
                
                    Object.values(mergedCounts).forEach(item => {
                        renderItem(item, true);
                    });
            } 
        } else if (tab === 'debt') {
                const list = document.getElementById('liabilities-list');
                list.innerHTML = '';
                
                const fixedDiv = document.createElement('div');
                fixedDiv.className = 'debt-item text-white opacity-60';
                fixedDiv.style.background = 'transparent';
                fixedDiv.style.border = 'none';
                fixedDiv.innerHTML = `
                    <div><div class="font-bold">ç¨æ”¶ & å…¶ä»–</div><div class="text-[10px]">-$${(this.state.basicTax + this.state.otherExpense).toLocaleString()}/æœˆ (å›ºå®š)</div></div>
                `;
                list.appendChild(fixedDiv);

                if (this.state.liabilities.length === 0) {
                    list.innerHTML += '<div class="text-white/50 text-center py-4 text-xs">æ— ç”Ÿæ´»è´Ÿå€º ğŸ‰</div>';
                } else {
                    this.state.liabilities.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'debt-item text-white';
                        div.innerHTML = `
                            <div><div class="font-bold">${item.name}</div><div class="text-[10px] opacity-60">-$${item.expense}/æœˆ</div></div>
                            <button onclick="game.promptPayLiability('${item.id}')" class="px-2 py-1 bg-green-600 rounded text-xs active:scale-95 transition-transform">ä»˜ $${item.balance.toLocaleString()}</button>
                        `;
                        list.appendChild(div);
                    });

             const bankruptcyBtn = document.createElement('div');
             bankruptcyBtn.className = 'mt-6';
             bankruptcyBtn.innerHTML = `
                 <button onclick="game.declareBankruptcy()" 
                         class="w-full py-4 bg-red-600 dark:bg-red-700 text-white rounded-2xl font-bold text-lg shadow-lg shadow-red-900/30 tap-effect active:scale-95 transition-all flex items-center justify-center gap-2">
                     â˜ ï¸ å®£å¸ƒç ´äº§ï¼ˆç»“æŸæ¸¸æˆï¼‰
                 </button>
                 <div class="text-[10px] text-red-300 dark:text-red-400 text-center mt-2 opacity-70">
                     å½“ä½ è§‰å¾—å€ºåŠ¡æ— æ³•ç¿»èº«æ—¶ï¼Œå¯ä¸»åŠ¨é€‰æ‹©ç ´äº§
                 </div>
             `;
             list.appendChild(bankruptcyBtn);

             const empty = document.createElement('div');
             empty.className = 'h-10';
             list.appendChild(empty);

                }
            }
        },

        openOverlay(id) {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            
            ['card-modal','choice-modal','game-over-modal','dream-modal'].forEach(i => document.getElementById(i).classList.add('hidden'));
            
            const target = document.getElementById(id);
            target.classList.remove('hidden', 'shake-anim'); 
            target.classList.add('modal-enter');
        },
        closeModal() {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.add('opacity-0'); 
            
            if (uiTimer) clearTimeout(uiTimer);
            
            uiTimer = setTimeout(() => {
                overlay.classList.add('hidden'); 
                overlay.style.display = 'none';
                overlay.classList.remove('opacity-0');
                this.state.currentCard = null;
                this.processQueue();
            }, 200);
        },
        updateUI() {
            document.getElementById('display-cash').innerText = '$' + Math.floor(this.state.cash).toLocaleString();
            document.getElementById('display-flow').innerText = '$' + this.monthlyFlow.toLocaleString();
            const displayPassive = this.state.isFastTrack ? this.state.ftAddedCashflow : this.state.passive;
            document.getElementById('display-passive').innerText = '$' + displayPassive.toLocaleString();
            
            const totalExp = this.totalExpense;
            document.getElementById('display-expense').innerText = '$' + totalExp.toLocaleString();
            
            let percent = 0;
            if (this.state.isFastTrack) {
                percent = Math.min((this.state.ftAddedCashflow / 50000) * 100, 100);
            } else {
                percent = totalExp > 0 ? Math.min((this.state.passive / totalExp) * 100, 100) : 100;
            }
            document.getElementById('progress-bar').style.width = percent + '%';

            if (!this.state.isFastTrack && this.monthlyFlow < 0 && this.state.cash < 0) document.getElementById('bankrupt-warn').classList.remove('hidden');
            else document.getElementById('bankrupt-warn').classList.add('hidden');

            this.renderDiceControls();
        },
        
        renderBoard() {
            const board = document.getElementById('game-board'); 
            board.innerHTML = '';
            
            const tiles = this.state.isFastTrack ? CONFIG.fastTrackTiles : CONFIG.tiles;
            
            board.style.gridTemplateColumns = "repeat(4, 1fr)";
            
            tiles.forEach((tile, idx) => {
                const div = document.createElement('div');
                let extraClass = '';
                if (this.state.isFastTrack) {
                    extraClass = 'text-[9px]'; 
                }

                div.className = `tile ${tile.color} ${extraClass}`;
                
                if (this.state.isFastTrack && tile.type === 'FT_Dream') {
                    div.innerHTML = `<div class="tile-icon text-lg">${tile.icon}</div><div class="opacity-70 scale-75 origin-center tracking-tight text-[8px]">${tile.label}</div>`;

                if (this.state.isFastTrack && tile.type === 'FT_Biz') {
                    if (this.state.fastTrackBiz[idx]) {
                        const biz = this.state.fastTrackBiz[idx];
                        div.innerHTML = `
                            <div class="tile-icon text-lg">${biz.icon}</div>
                            <div class="text-[8px] font-bold opacity-90 scale-90 tracking-tight leading-none">${biz.name}</div>
                            <div class="text-[7px] opacity-70">å·²æ‹¥æœ‰</div>
                        `;
                    }
                }

                } else {
                    div.innerHTML = `<div class="tile-icon">${tile.icon}</div><div class="opacity-70 scale-90 origin-center tracking-tight">${tile.label}</div>`;
                }
                
                if (idx === this.state.pos) {
                    div.classList.add('active');
                    div.innerHTML += `<div class="player-token"></div>`;
                    setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'center' }), 10);
                }
                board.appendChild(div);
            });
        },
        log(msg, important = false) {
            const el = document.getElementById('log-capsule');
            el.innerHTML = msg;
            if (important) {
                el.classList.add('scale-105', 'bg-white', 'dark:bg-white', 'text-slate-800', 'shadow-md');
            } else {
                el.classList.remove('scale-105', 'bg-white', 'dark:bg-white', 'text-slate-800', 'shadow-md');
            }
            setTimeout(() => el.classList.remove('scale-105', 'bg-white', 'dark:bg-white', 'text-slate-800', 'shadow-md'), 800);
        },
        animChange(id, type) {
            const el = document.getElementById(id);
            const color = type === 'positive' ? 'text-green-600' : 'text-red-500';
            el.classList.add(color, 'scale-110', 'transition-transform');
            setTimeout(() => el.classList.remove(color, 'scale-110'), 300);
        }
    };

    window.game = game;

    const setVh = () => {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    };
    window.addEventListener('resize', setVh);
    setVh();

    game.init();    </script>
</body>
</html>
